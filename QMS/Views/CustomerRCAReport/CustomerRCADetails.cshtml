@using QMS.Core.Models

@model RCAReportViewModel

@{
    ViewData["Title"] = "Customer RCA";
}

<style>
    .card {
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
        margin-bottom: 16px;
    }

    .d-flex {
        display: flex;
    }

    .justify-between {
        justify-content: space-between;
    }

    .align-center {
        align-items: center;
    }

    .table, .table-surge {
        border-collapse: collapse;
        width: 100%;
        font-size: 14px;
        text-align: center;
    }

        .table th, .table td, .table-surge th, .table-surge td {
            border: 1.5px solid #000;
            padding: 6px 8px;
            vertical-align: middle;
            box-sizing: border-box;
        }

    .header-title {
        font-size: x-large;
        color: #4682B4;
        font-weight: 700;
    }

    .soft-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        display: inline-block;
        width: 90%;
        min-width: 0;
        padding: 8px 28px 8px 10px;
        font-size: 14px;
        line-height: 1.2;
        color: #111;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid #e6eef6;
        border-radius: 0 0 8px 8px;
        box-shadow: none;
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 20 20' fill='none'><path d='M5 7l5 5 5-5' stroke='%23666' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'/></svg>");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 12px;
        transition: border-color 0.18s ease-in-out, transform 0.08s;
        cursor: pointer;
        vertical-align: middle;
        box-sizing: border-box;
        margin: 6px auto;
    }

        .soft-select.small {
            padding: 6px 24px 6px 8px;
            font-size: 13px;
            border-bottom-width: 1.8px;
            border-radius: 0 0 6px 6px;
            width: 86%;
        }

        .soft-select:hover {
            border-bottom-color: #c8ddf5;
        }

        .soft-select:focus {
            outline: none;
            border-bottom-color: #4a90e2;
            transform: translateY(-1px);
        }

    select.soft-select::-ms-expand {
        display: none;
    }

    select.soft-select option {
        color: #111;
    }

    .underline-input {
        border: 0;
        border-bottom: 1.5px solid #666;
        border-radius: 0;
        background: transparent;
        width: 50%;
        font-size: 15px;
        padding: 2px 6px;
        outline: none;
        box-shadow: none;
        vertical-align: middle;
        transition: border-color 0.2s ease-in-out;
    }

        .underline-input:focus {
            border-bottom: 1.5px solid #4682B4;
        }

    .ip-rating-select {
        width: 80px;
        margin-left: 6px;
        text-align: center;
        border-bottom: 1.8px solid #cfd9e3;
        border-radius: 0 0 6px 6px;
    }

    .btn-rectangle {
        display: inline-block;
        min-width: 260px;
        height: 60px;
        border: 1.5px solid #000;
        border-radius: 6px;
        background: #fff;
        vertical-align: middle;
        padding: 6px 10px;
        box-sizing: border-box;
    }

    .btn-outline-success, .btn-outline-danger {
        transition: all .18s ease-in-out;
    }

        .btn-outline-success:hover, .btn-outline-danger:hover {
            transform: scale(1.05);
        }

    .row-del-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        margin-left: 6px;
        padding: 0;
        color: red;
        font-size: 16px;
    }

        .row-del-btn:hover {
            color: darkred;
            transform: scale(1.1);
        }

    .card .table thead th {
        background: #f8f9fa;
        font-weight: 700;
    }

    .table td select.soft-select {
        max-width: 220px;
    }

    td[contenteditable="true"] {
        min-height: 36px;
        text-align: left;
    }

    .text-center {
        text-align: center;
    }
</style>

<div class="content">
    <div class="row">
        <div class="col-12">


            <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc;">
                <div class="card-body d-flex justify-between align-center" style="padding:18px;">
                    <div style="flex:1; text-align:left;">
                        <span class="header-title">Customer RCA</span>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button id="saveBtn" class="btn btn-outline-success" style="width:120px; font-size:15px; border-radius:6px;" onclick="saveRCAReport()">
                            <i class="fas fa-save" aria-hidden="true"></i> Save
                        </button>
                        <a href="@Url.Action("CustomerRCA", "CustomerRCAReport")" class="btn btn-outline-primary" style="width:120px; font-size:15px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center;">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> Back
                        </a>
                    </div>
                </div>
            </div>

            <form id="rcaReportForm" method="post" enctype="multipart/form-data" asp-controller="CustomerRCAReport" asp-action="InsertRCAReport">
                @Html.HiddenFor(m => m.Id)

                <!-- Info Card -->
                <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc; margin:0px;">
                    <div class="card-body" style="padding:16px;">

                        <div class="table-responsive" style="margin-bottom:0;">
                            <!-- TABLE 1 -->
                            <table class="table table-bordered" style="width:100%; border-collapse:collapse; text-align:left; font-size:14px; margin-bottom:0;">
                                <thead>
                                    <tr style="background-color:#ffffff;">
                                        <!-- Complaint No -->
                                        <th colspan="2"
                                            style="background-color:#ffffff; border:1.5px solid #000; font-weight:700; text-align:left; padding:8px;">
                                            1. Complaint No:-
                                            <input type="text" name="Complaint_No" value="@Model?.Complaint_No"
                                                   placeholder="Enter Complaint No"
                                                   style="border:none; border-bottom:1px solid #000; background:transparent; outline:none; width:60%; margin-left:8px;">
                                        </th>

                                        <!-- Date -->
                                        <th colspan="2"
                                            style="background-color:#ffffff; border:1.5px solid #000; font-weight:700; text-align:left; padding:8px;">
                                            Report Date:-
                                            @if (Model?.Id == 0)
                                            {
                                                <input type="date" name="Report_Date"
                                                       id="complaint_Date"
                                                       style="border:none; border-bottom:1px solid #000; background:transparent; outline:none; width:50%; margin-left:8px;" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                            }
                                            else
                                            {
                                                <input type="date" name="Report_Date"
                                                       id="complaint_Date"
                                                       style="border:none; border-bottom:1px solid #000; background:transparent; outline:none; width:50%; margin-left:8px;" value="@Model?.Report_Date?.ToString("yyyy-MM-dd")">

                                            }
                                        </th>
                                    </tr>
                                </thead>

                                <tr>
                                    <td style="width:25%; vertical-align:middle; padding:10px; border:1.5px solid #000;">
                                        <label style="font-weight:600;">
                                            <input type="checkbox" id="chkCustomerComplaints" style="margin-right:6px;" @(Model?.Cust_Complaints == true ? "checked" : "") name="Cust_Complaints" />
                                            Customer Complaints
                                        </label>
                                    </td>

                                    <td style="width:25%; vertical-align:middle; padding:10px; border:1.5px solid #000;">
                                        <label style="font-weight:600;">
                                            <input type="checkbox" id="chkNPIValidations" style="margin-right:6px;" @(Model?.NPI_Validations == true ? "checked" : "") name="NPI_Validations" />
                                            NPI Validations
                                        </label>
                                    </td>

                                    <td style="width:25%; vertical-align:middle; padding:10px; border:1.5px solid #000;">
                                        <label style="font-weight:600;">
                                            <input type="checkbox" id="chkPDIObservations" style="margin-right:6px;" @(Model?.PDI_Obser == true ? "checked" : "") name="PDI_Obser" />
                                            PDI Observations
                                        </label>
                                    </td>

                                    <td style="width:25%; vertical-align:middle; padding:10px; border:1.5px solid #000;">
                                        <label style="font-weight:600;">
                                            <input type="checkbox" id="chkSystemProcess" style="margin-right:6px;" @(Model?.System == true ? "checked" : "") name="System" />
                                            System / Process Improvements
                                        </label>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- SECOND TABLE (Directly after first, no spacing) -->
                        <div class="table-responsive" style="margin-top:0x;">
                            <table class="table table-bordered" style="width:100%; border-collapse:collapse; text-align:left; font-size:14px; margin-top:-1.5px;">
                                <tbody>
                                    <!-- First four single-column rows -->
                                    <tr>
                                        <td colspan="4" style="padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Customer Name and Location:</label>
                                            <input type="text" class="underline-input" style="width:80%; margin-left:6px;" placeholder="Enter customer name and location" value="@Model?.Cust_Name_Location" name="Cust_Name_Location" />
                                        </td>
                                    </tr>

                                    <tr>
                                        <td colspan="4" style="padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Source of Complaint:</label>
                                            <input type="text" class="underline-input" style="width:80%; margin-left:6px;" placeholder="Enter source of complaint" value="@Model?.Source_Complaint" name="Source_Complaint" />
                                        </td>
                                    </tr>

                                    <tr>
                                        <td colspan="4" style="padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Product Code and Description:</label>
                                            <input type="text" class="underline-input" style="width:80%; margin-left:6px;" placeholder="Enter product code and description" value="@Model?.Prod_Code_Desc" name="Prod_Code_Desc" />
                                        </td>
                                    </tr>

                                    <tr>
                                        <td colspan="4" style="padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Description of Complaint:</label>
                                            <input type="text" class="underline-input" style="width:80%; margin-left:6px;" placeholder="Enter complaint description" value="@Model?.Desc_Complaint" name="Desc_Complaint" />
                                        </td>
                                    </tr>


                                    <tr>
                                        <td style="width:50%; padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Batch Code:</label>
                                            <input type="text" class="underline-input" style="width:60%; margin-left:6px;" placeholder="Enter batch code" value="@Model?.Batch_Code" name="Batch_Code" />
                                        </td>
                                        <td style="width:50%; padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">PKD:</label>
                                            <input type="text" class="underline-input" style="width:60%; margin-left:6px;" placeholder="Enter PKD" value="@Model?.Pkd" name="Pkd" />
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%; padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Supplied Qty:</label>
                                            <input type="text" class="underline-input" style="width:60%; margin-left:6px;" placeholder="Enter supplied quantity" value="@Model?.Supp_Qty" name="Supp_Qty" />
                                        </td>
                                        <td style="width:50%; padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Installed Qty:</label>
                                            <input type="text" class="underline-input" style="width:60%; margin-left:6px;" placeholder="Enter failure quantity" value="@Model?.Failure_Qty" name="Failure_Qty" />
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%; padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Failure Qty:</label>
                                            <input type="text" class="underline-input" style="width:60%; margin-left:6px;" placeholder="Enter failure percentage" value="@Model?.Failure" name="Failure" />
                                        </td>
                                        <td style="width:50%; padding:8px; border:1.5px solid #000;">
                                            <label style="font-weight:600;">Age of Installation:</label>
                                            <input type="text" class="underline-input" style="width:60%; margin-left:6px;" placeholder="Enter age of installation" value="@Model?.Age_Install" name="Age_Install" />
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>


                        <div class="table-responsive" style="margin-top:0px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; text-align:left; font-size:14px; margin-top:-1.5px;">
                                <thead>
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            2. Site Observations
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4"
                                            contenteditable="true" data-name="Description"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Description
                                        </td>
                                    </tr>
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            3. Problem Statement
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Problem_State"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Problem_State
                                        </td>
                                    </tr>
                                </thead>
                            </table>
                        </div>

                        <div class="table-responsive" style="margin-top:0px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; text-align:center; font-size:14px; margin-top:-1.5px; margin-bottom:0;">
                                <thead style="border-collapse:collapse;">
                                    <tr style="border:1.5px solid #000;">
                                        <th colspan="3"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; text-align:left; padding:8px;">
                                            4. Problem Visualization (snaps of defective units):-
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:33%; border:1.5px solid #000; height:200px; vertical-align:middle;">
                                            @Html.HiddenFor(m => m.Problem_Visual_ImgA)
                                            <input type="file"
                                                   accept="image/*"
                                                   id="imgA"
                                                   name="Problem_Visual_ImgAFile"
                                                   style="display:block; margin:0 auto;" />
                                            <div id="previewA" style="margin-top:8px;">
                                                @if (!string.IsNullOrEmpty(Model?.Problem_Visual_ImgA))
                                                {
                                                    <img src="@Model.Problem_Visual_ImgA"
                                                         style="max-width:90%; max-height:160px;" />
                                                }
                                            </div>
                                        </td>
                                        <td style="width:33%; border:1.5px solid #000; height:200px; vertical-align:middle;" value="@Model?.Problem_Visual_ImgB" name="Problem_Visual_ImgB">
                                            @Html.HiddenFor(m => m.Problem_Visual_ImgB)
                                            <input type="file"
                                                   accept="image/*"
                                                   id="imgB"
                                                   name="Problem_Visual_ImgBFile"
                                                   style="display:block; margin:0 auto;" />
                                            <div id="previewB" style="margin-top:8px;">
                                                @if (!string.IsNullOrEmpty(Model?.Problem_Visual_ImgB))
                                                {
                                                    <img src="@Model.Problem_Visual_ImgB"
                                                         style="max-width:90%; max-height:160px;" />
                                                }
                                            </div>
                                        </td>
                                        <td style="width:33%; border:1.5px solid #000; height:200px; vertical-align:middle;" value="@Model?.Problem_Visual_ImgC" name="Problem_Visual_ImgC">
                                            @Html.HiddenFor(m => m.Problem_Visual_ImgC)
                                            <input type="file"
                                                   accept="image/*"
                                                   id="imgC"
                                                   name="Problem_Visual_ImgCFile"
                                                   style="display:block; margin:0 auto;" />
                                            <div id="previewC" style="margin-top:8px;">
                                                @if (!string.IsNullOrEmpty(Model?.Problem_Visual_ImgC))
                                                {
                                                    <img src="@Model.Problem_Visual_ImgC"
                                                         style="max-width:90%; max-height:160px;" />
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border:1.5px solid #000; font-weight:600;">Image a</td>
                                        <td style="border:1.5px solid #000; font-weight:600;">Image b</td>
                                        <td style="border:1.5px solid #000; font-weight:600;">Image c</td>
                                    </tr>
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; text-align:left; padding:8px;">
                                            5. Initial Observations
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Initial_Observ"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Initial_Observ
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>

                        <div class="table-responsive" style="margin-top:-1.5px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; font-size:14px; text-align:left; margin:0;">
                                <tbody>

                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            5. Complaint History
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Complaint_History"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:60px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Complaint_History
                                        </td>
                                    </tr>

                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            6. Initial Analysis:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>

                        <div class="table-responsive" style="margin:0; padding:0; border-top:none;">
                            <table class="table table-bordered" style="width:100%; border-collapse:collapse; margin-top:-1.5px; margin-bottom:0;">
                                <tbody>
                                    <tr>
                                        <td colspan="6" style="padding:12px; text-align:left;">
                                            <button id="addRowBtn" type="button" class="btn btn-outline-success" style="width:120px; font-size:15px; border-radius:6px;">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                        <div class="table-responsive" style="margin-top:0;">
                            @if (Model?.Details != null && Model.Details.Count > 0)
                            {
                                for (int i = 0; i < Model.Details.Count; i++)
                                {
                                    @Html.HiddenFor(m => m.Details[i].Init_Ana_Id)
                                }
                            }
                            <table id="monitoringTable" class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; text-align:left; font-size:14px; margin-top:-1.5px;">
                                <thead>
                                    <tr>
                                        <th style="width:8%; border:1.5px solid #000; text-align:center;">Sr. No</th>
                                        <th style="width:70%; border:1.5px solid #000; text-align:center;">Parameter Checked during internal Validation</th>
                                        <th style="width:30%; border:1.5px solid #000; text-align:center;">Observations</th>
                                    </tr>
                                </thead>
                                <tbody id="monitoringBody">
                                    @{
                                        var details = Model?.Details ?? new List<QMS.Core.Models.RCAReportDetailViewModel>();
                                        int idx = 1;
                                    }

                                    @if (details.Any())
                                    {
                                        foreach (var item in details)
                                        {
                                            <tr style="height:120px;">
                                                <td class="sr-cell" style="border:1.5px solid #000; text-align:center;">
                                                    @idx
                                                    <button class="row-del-btn" title="Delete row">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </td>

                                                <!-- Particular Of Test -->
                                                <td contenteditable="true" data-name="Parameter_Checked" style="border:1.5px solid #000; vertical-align:top;">
                                                    @(item.Parameter_Checked ?? "")
                                                </td>

                                                <!-- Target Date -->
                                                <td contenteditable="true" data-name="Observations" style="border:1.5px solid #000; vertical-align:top;">
                                                    @(item.Observations ?? "")
                                                </td>
                                            </tr>

                                            idx++;
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td style="border:1.5px solid #000; text-align:center;">1</td>
                                            <td style="border:1.5px solid #000;" contenteditable="true"></td>
                                            <td style="border:1.5px solid #000;" contenteditable="true"></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="table-responsive" style="margin-top:-1.5px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; font-size:14px; text-align:left; margin:0;">
                                <tbody>
                                    <!-- Current Process Verification -->
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            Current Process Verification Internal Checks:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Current_Process"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Current_Process
                                        </td>
                                    </tr>

                                    <!-- Initial Conclusion -->
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            Initial Conclusion:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Conclusion"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Conclusion
                                        </td>
                                    </tr>

                                    <!-- Analysis of 100 Samples -->
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            7. Analysis of Defective 100 Nos Samples:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Analysis_of_Defective100"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Analysis_of_Defective100
                                        </td>
                                    </tr>

                                    <!-- Root Cause Analysis -->
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            Root Cause Analysis:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="4" data-name="Root_Cause_Anal"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Root_Cause_Anal
                                        </td>
                                    </tr>
                                    <input type="hidden" name="Root_Cause_Date" id="Root_Cause_Date" value="@Model?.Root_Cause_Date" />
                                </tbody>
                            </table>
                        </div>

                        <!-- Images of Failed Samples -->
                        <div class="table-responsive" style="margin-top:-1.5px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; font-size:14px; text-align:center; margin:0;">
                                <thead>
                                    <tr>
                                        <th colspan="4"
                                            style="background-color:#ffffff; border:1.5px solid #000; font-weight:700; text-align:left; padding:8px;">
                                            Images of Failed Samples:
                                        </th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <td style="width:25%; border:1.5px solid #000; vertical-align:middle; height:180px;">
                                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                                                <p style="margin:0 0 6px 0; font-weight:600;">Photo 1</p>
                                                @Html.HiddenFor(m => m.Images_Failed_Samples1)
                                                <input type="file" accept="image/*" id="photo1" name="Images_Failed_Samples1File" style="margin-top:4px; font-size:13px;">
                                                <img id="preview1" alt="Photo 1" src="@Model?.Images_Failed_Samples1"
                                                @(string.IsNullOrEmpty(Model?.Images_Failed_Samples1) ? "display:none;" : "display:block;")
                                                     style="margin-top:6px; max-width:85%; max-height:110px;border:1px solid #aaa; border-radius:5px;">
                                            </div>
                                        </td>

                                        <td style="width:25%; border:1.5px solid #000; vertical-align:middle; height:180px;">
                                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                                                <p style="margin:0 0 6px 0; font-weight:600;">Photo 2</p>
                                                @Html.HiddenFor(m => m.Images_Failed_Samples2)
                                                <input type="file" accept="image/*" id="photo2" name="Images_Failed_Samples2File" style="margin-top:4px; font-size:13px;">
                                                <img id="preview2" alt="Photo 2" src="@Model?.Images_Failed_Samples2"
                                                @(string.IsNullOrEmpty(Model?.Images_Failed_Samples2) ? "display:none;" : "display:block;")
                                                     style="margin-top:6px; max-width:85%; max-height:110px; border:1px solid #aaa; border-radius:5px;">
                                            </div>
                                        </td>

                                        <td style="width:25%; border:1.5px solid #000; vertical-align:middle; height:180px;">
                                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                                                <p style="margin:0 0 6px 0; font-weight:600;">Photo 3</p>
                                                @Html.HiddenFor(m => m.Images_Failed_Samples3)
                                                <input type="file" accept="image/*" id="photo3" name="Images_Failed_Samples3File" style="margin-top:4px; font-size:13px;">
                                                <img id="preview3" alt="Photo 3" src="@Model?.Images_Failed_Samples3"
                                                @(string.IsNullOrEmpty(Model?.Images_Failed_Samples3) ? "display:none;" : "display:block;")
                                                     style="margin-top:6px; max-width:85%; max-height:110px;border:1px solid #aaa; border-radius:5px;">
                                            </div>
                                        </td>

                                        <td style="width:25%; border:1.5px solid #000; vertical-align:middle; height:180px;">
                                            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                                                <p style="margin:0 0 6px 0; font-weight:600;">Photo 4</p>
                                                @Html.HiddenFor(m => m.Images_Failed_Samples4)
                                                <input type="file" accept="image/*" id="photo4" name="Images_Failed_Samples4File" style="margin-top:4px; font-size:13px;">
                                                <img id="preview4" alt="Photo 4" src="@Model?.Images_Failed_Samples4"
                                                @(string.IsNullOrEmpty(Model?.Images_Failed_Samples4) ? "display:none;" : "display:block;")
                                                     style="margin-top:6px; max-width:85%; max-height:110px;border:1px solid #aaa; border-radius:5px;">
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="table-responsive" style="margin-top:0px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; text-align:left; font-size:14px; margin-top:-1.5px; margin-bottom:0;">
                                <thead style="border-collapse:collapse;">
                                    <tr style="border:1.5px solid #000;">
                                        <th colspan="6"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; text-align:left; padding:8px;">
                                            8. Problem Basket
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:16%; border:1.5px solid #000; text-align:left; padding:8px;">
                                            <label style="font-weight:600;">
                                                <input type="checkbox" id="chkManufacturing" style="margin-right:6px;" @(Model?.Man_Issue_Prob == true ? "checked" : "") name="Man_Issue_Prob">
                                                Manufacturing Issue
                                            </label>
                                        </td>
                                        <td style="width:16%; border:1.5px solid #000; text-align:left; padding:8px;">
                                            <label style="font-weight:600;">
                                                <input type="checkbox" id="chkDesign" style="margin-right:6px;" @(Model?.Design_Prob == true ? "checked" : "") name="Design_Prob">
                                                Design
                                            </label>
                                        </td>
                                        <td style="width:16%; border:1.5px solid #000; text-align:left; padding:8px;">
                                            <label style="font-weight:600;">
                                                <input type="checkbox" id="chkSiteIssue" style="margin-right:6px;" @(Model?.Site_Issue_Prob == true ? "checked" : "") name="Site_Issue_Prob">
                                                Site Issue
                                            </label>
                                        </td>
                                        <td style="width:16%; border:1.5px solid #000; text-align:left; padding:8px;">
                                            <label style="font-weight:600;">
                                                <input type="checkbox" id="chkCommunication" style="margin-right:6px;" @(Model?.Com_Gap_Prob == true ? "checked" : "") name="Com_Gap_Prob">
                                                Communication Gap
                                            </label>
                                        </td>
                                        <td style="width:16%; border:1.5px solid #000; text-align:left; padding:8px;">
                                            <label style="font-weight:600;">
                                                <input type="checkbox" id="chkInstallation" style="margin-right:6px;" @(Model?.Install_Issues_Prob == true ? "checked" : "") name="Install_Issues_Prob">
                                                Installation Issues
                                            </label>
                                        </td>
                                        <td style="width:16%; border:1.5px solid #000; text-align:left; padding:8px;">
                                            <label style="font-weight:600;">
                                                <input type="checkbox" id="chkWrongApplication" style="margin-right:6px;" @(Model?.Wrong_App_Prob == true ? "checked" : "") name="Wrong_App_Prob">
                                                Wrong Application
                                            </label>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-responsive" style="margin-top:0px;">
                            <table class="table table-bordered"
                                   style="width:100%; border-collapse:collapse; text-align:left; font-size:14px; margin-top:-1.5px; margin-bottom:0;">
                                <thead style="border-collapse:collapse;">
                                    <tr style="border:1.5px solid #000;">
                                        <th colspan="6"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            9. Corrective Action:
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" data-name="Corrective_Action"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Corrective_Action
                                        </td>
                                        <input type="hidden" name="Corrective_Action_Date" id="Corrective_Action_Date" value="@Model?.Corrective_Action_Date" />
                                    </tr>
                                    <tr>
                                        <th colspan="6"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            10. Images of corrections:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="6" data-name="Images_Corrections"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Images_Corrections
                                        </td>
                                    </tr>
                                    <tr>
                                        <th colspan="6"
                                            style="background-color:#d9e7f7; border:1.5px solid #000; font-weight:700; padding:8px;">
                                            11. Conclusion:
                                        </th>
                                    </tr>
                                    <tr>
                                        <td colspan="6" data-name="Conclusion"
                                            contenteditable="true"
                                            style="border:1.5px solid #000; height:80px; vertical-align:top; padding:8px; background-color:#fff;">
                                            @Model?.Conclusion
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                        <div class="table-responsive" style="margin-top:0px;">
                            <table class="table table-bordered" style="width:100%; border-collapse:collapse; font-size:14px;">
                                <tbody>
                                    <tr style="background-color:#c7d7ee;">
                                        <!-- Left column -->
                                        <td style="width:70%; border:1.5px solid #000; padding:8px; text-align:left;">
                                            <strong>RCA Prepared By:-</strong>
                                            <input type="text" name="Rca_Prepared_By"
                                                   placeholder="Enter RCA Prepared By"
                                                   style="width:60%; border:none; border-bottom:1px solid #000; background:transparent; outline:none; margin-left:8px;" value="@Model?.Rca_Prepared_By">

                                            <br><br>

                                            <strong>Name and Designation :</strong>
                                            <input type="text" name="Name_Designation"
                                                   placeholder="Enter Name and Designation"
                                                   style="width:70%; border:none; border-bottom:1px solid #000; background:transparent; outline:none; margin-left:8px;" value="@Model?.Name_Designation">
                                        </td>

                                        <!-- Right column -->
                                        <td style="width:30%; border:1.5px solid #000; padding:8px; text-align:left;">
                                            <strong>Date:-</strong>
                                            <input type="date" name="Date"
                                                   style="width:80%; border:none; border-bottom:1px solid #000; background:transparent; outline:none; margin-left:8px;" value="@Model?.Date?.ToString("yyyy-MM-dd")">
                                        </td>

                                    </tr>

                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        let monitoringBody;
        let monitoringAddBtn;

        $(document).ready(function () {
            initMonitoringTable();
            initPhotoPreviews();
            initAutoDate();

            // Map data-name => hidden input id
            const dateMapping = {
                "Root_Cause_Anal": "Root_Cause_Date",
                "Corrective_Action": "Corrective_Action_Date"
            };

            $("[contenteditable='true']").on("input", function () {
                const field = $(this).data("name");
                const hiddenId = dateMapping[field];

                if (!hiddenId) return; // safety

                const hiddenInput = $("#" + hiddenId);

                // Set date only once
                if (!hiddenInput.val()) {

                    const now = new Date();
                    const day = String(now.getDate()).padStart(2, "0");
                    const month = String(now.getMonth() + 1).padStart(2, "0");
                    const year = now.getFullYear();

                    const formatted = `${day}-${month}-${year}`;

                    hiddenInput.val(formatted);
                }
            });
        });


        function createMonitoringDeleteButton() {
            const btn = document.createElement('button');
            btn.className = 'row-del-btn';
            btn.title = 'Delete this row';
            btn.innerHTML = '<i class="fa fa-trash"></i>';

            Object.assign(btn.style, {
                background: 'transparent',
                border: 'none',
                cursor: 'pointer',
                color: 'red',
                fontSize: '15px',
                marginLeft: '6px'
            });

            btn.addEventListener('click', () => {
                const tr = btn.closest('tr');
                if (tr) tr.remove();
                refreshMonitoringSerials();
            });

            return btn;
        }

        function refreshMonitoringSerials() {
            if (!monitoringBody) return;

            Array.from(monitoringBody.rows).forEach((row, index) => {
                const srCell = row.cells[0];
                if (!srCell) return;

                srCell.innerHTML = '';
                srCell.textContent = index + 1;
                srCell.style.textAlign = 'center';
                srCell.appendChild(createMonitoringDeleteButton());
            });
        }

        function addMonitoringRow() {
            const tr = document.createElement('tr');

            tr.innerHTML = `
                    <td style="border:1.5px solid #000; text-align:center;"></td>
                    <td style="border:1.5px solid #000;" contenteditable="true"></td>
                    <td style="border:1.5px solid #000;" contenteditable="true"></td>
                `;

            monitoringBody.appendChild(tr);
            refreshMonitoringSerials();

            const newRow = monitoringBody.lastElementChild;
            if (newRow) newRow.cells[1].focus();
        }

        function initMonitoringTable() {
            monitoringBody = document.getElementById('monitoringBody');
            monitoringAddBtn = document.getElementById('addRowBtn');

            if (!monitoringBody || !monitoringAddBtn) {
                console.error('monitoringBody or addRowBtn not found.');
                return;
            }

            monitoringAddBtn.addEventListener('click', addMonitoringRow);
            refreshMonitoringSerials();
        }

        function setupPreview(inputId, imgId) {
            const inp = document.getElementById(inputId);
            const img = document.getElementById(imgId);

            if (!inp || !img) return;

            inp.addEventListener('change', () => {
                const file = inp.files && inp.files[0];

                if (!file) {
                    img.src = '';
                    img.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = e => {
                    img.src = e.target.result;
                    img.style.display = 'block';
                };

                reader.readAsDataURL(file);
            });
        }

        function initPhotoPreviews() {
            setupPreview('photo1', 'preview1');
            setupPreview('photo2', 'preview2');
            setupPreview('photo3', 'preview3');
            setupPreview('photo4', 'preview4');
        }

        function initAutoDate() {
            const dateInput = document.getElementById("complaintDate");
            if (!dateInput) return;

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }


        async function saveRCAReport() {
            debugger;
            const saveBtn = document.getElementById('saveBtn');
            if (!saveBtn) return;

            // Required fields list
            const requiredFields = [
                { name: "Complaint_No", label: "Complaint No" },
            ];

            // Validate required fields
            const missing = [];
            requiredFields.forEach(f => {
                const el = document.querySelector(`[name="${f.name}"]`);
                const value = el?.value?.trim();
                if (!value) {
                    missing.push(f.label);
                }
            });

            if (missing.length > 0) {
                const listHTML = missing.map(m => `<li>${m}</li>`).join("");
                showDangerAlert(
                    `<p>Please fill out the following required field(s):</p><ul>${listHTML}</ul>`
                );
                return;
            }

            const origHTML = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin spinner-inline"></i> Saving...';
            Blockloadershow();

            try {
                const form = document.getElementById('rcaReportForm');
                if (!form) throw new Error('Form element not found (id="rcaReportForm").');

                const formData = new FormData(form);

                // Ensure Id is always sent to server (Razor value)
                const currentRcaReportId = @(Model?.Id ?? 0);
                formData.set('Id', String(currentRcaReportId));

                const boolCheckboxes = [
                    { id: 'chkCustomerComplaints', name: 'Cust_Complaints' },
                    { id: 'chkNPIValidations',     name: 'NPI_Validations' },
                    { id: 'chkPDIObservations',    name: 'PDI_Obser' },
                    { id: 'chkSystemProcess',      name: 'System' },
                    { id: 'chkManufacturing',      name: 'Man_Issue_Prob' },
                    { id: 'chkDesign',             name: 'Design_Prob' },
                    { id: 'chkSiteIssue',          name: 'Site_Issue_Prob' },
                    { id: 'chkCommunication',      name: 'Com_Gap_Prob' },
                    { id: 'chkInstallation',       name: 'Install_Issues_Prob' }, // fixed spelling
                    { id: 'chkWrongApplication',   name: 'Wrong_App_Prob' }
                ];

                boolCheckboxes.forEach(cb => {
                    const el = document.getElementById(cb.id);
                    if (!el) return;
                    formData.set(cb.name, el.checked ? 'true' : 'false');
                });

                // All top-level contenteditable fields with data-name
                const editableCells = document.querySelectorAll('[contenteditable="true"][data-name]');
                editableCells.forEach(cell => {
                    const key = cell.getAttribute('data-name');
                    if (!key) return;

                    // Use innerHTML if you want formatting; innerText for plain text
                    let val = (cell.innerHTML || '').trim();

                    // Remove &nbsp; noise
                    val = val.replace(/&nbsp;/g, ' ').trim();

                    formData.set(key, val);
                });

                // ===== Build Details array from #monitoringBody (RCA version) =====
                const details = [];
                const rows = Array.from(document.querySelectorAll('#monitoringBody tr'));

                rows.forEach((row, idx) => {
                    const cells = row.querySelectorAll('td');
                    if (!cells || cells.length < 3) return;

                    const parameterChecked = (cells[1].innerText || '').trim();
                    const observations = (cells[2].innerText || '').trim();

                    // Ignore completely empty rows
                    if (!parameterChecked && !observations) return;

                    details.push({
                        SeqNo: idx + 1,
                        Parameter_Checked: parameterChecked,
                        Observations: observations
                    });
                });

                // Append Details to form data for model binding
                details.forEach((d, i) => {
                    formData.append(`Details[${i}].SeqNo`, d.SeqNo.toString());
                    formData.append(`Details[${i}].Parameter_Checked`, d.Parameter_Checked || '');
                    formData.append(`Details[${i}].Observations`, d.Observations || '');
                });

                // JSON backup (optional, for server-side manual parsing)
                formData.set('DetailsJson', JSON.stringify(details));

                // jQuery AJAX
                $.ajax({
                    url: form.action,
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    cache: false,
                    xhrFields: { withCredentials: true },
                    success: function (json, textStatus, xhr) {
                        json = json || {};

                        if (json.Success === true || json.success === true) {
                            const currentId = parseInt(formData.get('Id') || "0", 10);
                            if (currentId > 0) {
                                showSuccessAlert(json.Message || 'Updated successfully.');
                            } else {
                                showSuccessAlert(json.Message || 'Saved successfully.');
                            }

                            const navigateBack = () => {
                                if (json.RedirectUrl) {
                                    window.location.href = json.RedirectUrl;
                                    return;
                                }
                                try {
                                    const ref = document.referrer;
                                    if (ref && ref !== '' && ref !== window.location.href) {
                                        window.location.href = ref;
                                        return;
                                    }
                                } catch (e) { }

                                history.back();
                            };

                            setTimeout(navigateBack, 800);
                            return;
                        }

                        if (Array.isArray(json.errors) && json.errors.length) {
                            showDangerAlert(json.errors.join('<br/>'));
                        } else if (Array.isArray(json.Errors) && json.Errors.length) {
                            showDangerAlert(json.Errors.join('<br/>'));
                        } else if (json.Message || json.message) {
                            showDangerAlert(json.Message || json.message);
                        } else {
                            console.error('Unexpected server response:', json);
                            showDangerAlert('Save failed — see console for details.');
                        }
                    },
                    error: function (xhr, status, error) {
                        let msg = 'Server error: ' + status;
                        try {
                            if (xhr.responseText) {
                                msg += ' — ' + xhr.responseText;
                            }
                        } catch (e) { }
                        console.error('Save error:', error, xhr);
                        showDangerAlert(msg);
                    },
                    complete: function () {
                        Blockloaderhide();
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = origHTML;
                        }
                    }
                });

            } catch (err) {
                console.error('Save error:', err);
                showDangerAlert('Error saving data: ' + (err && err.message ? err.message : err));
                Blockloaderhide();
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = origHTML;
                }
            }
        }


    </script>
}

@section HideSidebar { }
