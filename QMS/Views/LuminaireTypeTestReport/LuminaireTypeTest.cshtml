@{
    ViewData["Title"] = "Internal Type Test report";
}

<!-- CSS: Matches Photometry / Electrical Protection header design -->
<link href="~/css/fontawesome/styles.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator_bootstrap4.min.css" rel="stylesheet" />
<link href="~/css/pnotify.css" rel="stylesheet" />

<style>
    .header-card {
        border-radius: 8px;
        border: 1px solid #ccc;
        background-color: #fff;
    }

    .header-title {
        font-size: large;
        color: #4682B4;
        font-weight: 700;
    }

    .header-btn {
        width: 140px;
        font-size: 15px;
        border-radius: 6px;
        transition: all 0.2s ease-in-out;
    }

        .header-btn:hover {
            transform: scale(1.05);
        }

    .mr-2 {
        margin-right: 8px;
    }

    /* simple blocker overlay used by Blockloadershow/Blockloaderhide */
    #globalBlocker {
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.25);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

        #globalBlocker .loader {
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            font-weight: 600;
        }

    /* alert container */
    #alertContainer {
        position: fixed;
        right: 18px;
        top: 76px;
        width: 320px;
        z-index: 2200;
    }

    /* Tabulator niceties */
    .tabulator .tabulator-header .tabulator-col {
        font-size: 14px;
        background-color: #D6E4F0;
        font-weight: 600;
        border-right: 1px solid #ccc;
    }

    .tabulator-row .tabulator-cell {
        padding: 5px 5px;
        font-size: 14px;
        height: 35px;
    }

    .tabulator-cell:hover {
        color: #4682B4 !important;
        cursor: pointer !important;
        font-weight: bold;
    }

</style>

<div class="content">
    <!-- Header Card -->
    <div class="card shadow-sm mb-3 header-card">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <b class="header-title">Internal Type Test report Details</b>
            </div>
            <div>
                <!-- Add Button -->
                <button id="addLuminaireButton"
                        type="button"
                        class="btn btn-outline-success legitRipple mr-2 header-btn"
                        onclick="location.href='@Url.Action("LuminaireTypeTestDetails", "LuminaireTypeTestReport")'">
                    <i class="fas fa-plus mr-2 fa-1x"></i>Add
                </button>

                <!-- Back Button -->
                <button id="backButton"
                        type="button"
                        class="btn btn-outline-primary header-btn"
                        onclick="location.href='@Url.Action("TrackerMenu", "Home")'">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="luminaire_table_wrapper" style="overflow-x:auto; width:100%; float:left;">
                <div id="luminaire_table"></div>
            </div>
        </div>
    </div>

    <!-- simple blocker and alert container -->
    <div id="globalBlocker"><div class="loader">Loading...</div></div>
    <div id="alertContainer"></div>
    @section Scripts {
        <script src="~/js/tabulator.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

        <script asp-append-version="true">
            var table = null;

            $(document).ready(function () {
                loadLuminaireGrid();
            });

            function loadLuminaireGrid() {
                Blockloadershow();
                $.ajax({
                    url: '@Url.Action("GetInternalTypeTestList", "LuminaireTypeTestReport")',
                    type: 'GET',
                    success: function (data) {
                        Blockloaderhide();
                        console.log("RAW SERVER DATA:", data);
                        if (Array.isArray(data)) {
                            buildLuminaireGrid(data);
                        } else {
                            buildLuminaireGrid([]);
                            showDangerAlert("No data found.");
                        }
                    },
                    error: function (xhr, status, error) {
                        Blockloaderhide();
                        showDangerAlert("Error loading data: " + error);
                    }
                });
            }

            function buildLuminaireGrid(response) {

                var tabledata = response.map((item, index) => {

                    // ✅ Convert item.date → dd/MM/yyyy
                    let formattedDate = "";
                    if (item.date) {
                        let d = new Date(item.date);
                        formattedDate = !isNaN(d) ? d.toLocaleDateString("en-GB") : item.date;
                    }

                    return {
                        Sr_No: index + 1,
                        Id: item.id,
                        Prod_Cat_Code: item.prod_Cat_Code || "",

                        Report_No: item.report_No || "",
                        Report_Date: formattedDate,

                        Cust_Name: item.cust_Name || "",
                        Samp_Identi_Lab: item.samp_Identi_Lab || "",
                        Input_Voltage: item.input_Voltage || "",
                        Samp_Desc: item.samp_Desc || "",
                    };
                });

                if (table) table.destroy();

                table = new Tabulator("#luminaire_table", {
                    data: tabledata,
                    layout: "fitDataTable",
                    movableColumns: true,
                    pagination: "local",
                    paginationSize: 10,
                    paginationSizeSelector: [10, 50, 100, { label: "All", value: true }],

                    columns: [

                        {
                            title: "Action",
                            field: "Action",
                            width: 140,
                            hozAlign: "center",
                            formatter: function (cell) {
                                const row = cell.getRow().getData();
                                return `
                                    <i onclick="(function(e){ e.stopPropagation(); deleteLuminaire(${row.Id}); })(event)"
                                       class="fas fa-trash-alt"
                                       title="Delete"
                                       style="color:red; cursor:pointer; margin-right:10px;"></i>

                                    <i onclick="(function(e){ e.stopPropagation(); exportLuminaireToExcel(${row.Id}); })(event)"
                                       class="fas fa-file-excel"
                                       title="Export Excel"
                                       style="color:green; cursor:pointer;"></i>
                                `;
                            }
                        },

                        { title: "SNo", field: "Sr_No", width: 100, hozAlign: "center" },
                        { title: "Report No", field: "Report_No",headerFilter: "input", hozAlign: "left" },
                        { title: "Report Date", field: "Report_Date", headerFilter: "input", hozAlign: "center" },
                        { title: "Product CAT Code", field: "Prod_Cat_Code",headerFilter: "input", hozAlign: "left" },
                        { title: "Sample Description", field: "Samp_Desc", headerFilter: "input", hozAlign: "left" },
                        { title: "Customer Name", field: "Cust_Name",  headerFilter: "input", hozAlign: "left" },
                        { title: "Input Voltage", field: "Input_Voltage", headerFilter: "input", hozAlign: "left" },
                        { title: "Sample Identification (Lab)", field: "Samp_Identi_Lab", headerFilter: "input", hozAlign: "left" }
                    ]
                });

                table.on("cellClick", (e, cell) => {
                    if (cell.getColumn().getField() === "Action") return;

                    const id = cell.getRow().getData().Id;
                    if (id) {
                        window.location.href = "/LuminaireTypeTestReport/LuminaireTypeTestDetails?internalTypeId=" + id;
                    }
                });
            }

            function deleteLuminaire(recid) {
                PNotify.prototype.options.styling = "bootstrap3";
                (new PNotify({
                    title: 'Confirmation Needed',
                    text: 'Are you sure to delete? It will not delete if this record is used in transactions.',
                    icon: 'glyphicon glyphicon-question-sign',
                    hide: false,
                    confirm: {
                        confirm: true
                    },
                    buttons: {
                        closer: false,
                        sticker: false
                    },
                    history: {
                        history: false
                    },
                })).get().on('pnotify.confirm', function () {
                    $.ajax({
                        url: '@Url.Action("DeleteInternalTypeTest", "LuminaireTypeTestReport")',
                        type: 'POST',
                        data: { Id: recid },
                        success: function (data) {
                            if (data.success == true) {
                                showSuccessAlert("Deleted successfully.");
                                setTimeout(function () {
                                    window.location.reload();
                                }, 2500);
                            }
                            else {
                                showDangerAlert(data.message);
                            }
                        },
                        error: function () {
                            showDangerAlert('Error retrieving data.');
                        }
                    });
                }).on('pnotify.cancel', function () {
                    loadLuminaireGrid();
                });
            }


            function exportLuminaireToExcel(recid) {
                Blockloadershow();

                $.ajax({
                    url: '@Url.Action("ExportInternalTypeTestExcel", "LuminaireTypeTestReport")',
                    data: { id: recid },
                    type: 'POST',
                    xhrFields: {
                        responseType: 'blob' // expect binary Excel blob
                    },
                    success: function (data, status, xhr) {
                        try {
                            var blob = new Blob([data], { type: xhr.getResponseHeader('Content-Type') || 'application/octet-stream' });

                            var contentDisposition = xhr.getResponseHeader('Content-Disposition');
                            var fileName = '';

                            if (contentDisposition) {
                                // RFC5987 / filename* handling
                                var fileNameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)/);
                                if (fileNameMatch && fileNameMatch.length > 1) {
                                    fileName = decodeURIComponent(fileNameMatch[1].split(';')[0].trim());
                                } else {
                                    // fallback to basic filename="..."
                                    var fileNameSimpleMatch = contentDisposition.match(/filename="?(.+?)"?($|;)/);
                                    if (fileNameSimpleMatch && fileNameSimpleMatch.length > 1) {
                                        fileName = fileNameSimpleMatch[1].trim();
                                    }
                                }
                            }

                            if (!fileName) {
                                fileName = 'LuminaireTypeTestReport.xlsx';
                            }

                            var link = document.createElement('a');
                            link.href = window.URL.createObjectURL(blob);
                            link.download = fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } catch (ex) {
                            console.error('Failed to save Excel file', ex);
                            showDangerAlert('Failed to download the file. See console for details.');
                        }
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            // optional: redirect to login if unauthorized
                            window.location.href = '@Url.Action("Login", "Account")';
                        } else {
                            showDangerAlert('Error exporting Excel. Please try again.');
                        }
                    },
                    complete: function () {
                        Blockloaderhide();
                    }
                });
            }
        </script>
    }
    


</div>

@section HideSidebar { }