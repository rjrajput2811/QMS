@{
    ViewData["Title"] = "Merge Tracker";
}
<link href="~/css/fontawesome/styles.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator_bootstrap4.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="~/js/jquery.min.js"></script>
<script src="~/js/jquery.datatables.js"></script>
<link href="~/css/pnotify.css" rel="stylesheet" />
<script src="~/js/pnotify.js"></script>
<script src="~/js/pnotify.confirm.js"></script>
<script src="~/lib/bootstrap/dist/js/datatables.buttons.min.js"></script>

<script src="~/lib/bootstrap/dist/js/jszip.min.js"></script>
<script src="~/lib/bootstrap/dist/js/buttons.html5.min.js"></script>
<script src="~/js/common.js"></script>
<script src="~/lib/bootstrap/dist/js/popupalert.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />

<style>
    .form-control {
        padding: 0 10px !important;
        border: 0;
        border-bottom: 1px solid #cccccc;
        border-radius: 0px;
    }

    label {
        margin-bottom: 0;
        margin-top: .3rem;
    }

    #scrollToTopBtn:hover {
        background-color: #0056b3;
    }

    #scrollToTopBtn {
        outline: none;
    }

    .card .card-body .page-title {
        color: #4682B4;
        font-weight: 700;
    }

    .tabulator .tabulator-header .tabulator-col {
        font-size: 14px;
        background-color: #D6E4F0;
        font-weight: 600;
        border-right: 1px solid #ccc;
    }

    .tabulator-row .tabulator-cell {
        padding: 8px 8px;
        font-size: 14px;
        min-height: 36px;
        line-height: 18px;
    }

    .tabulator-cell:hover {
        color: #4682B4 !important;
        cursor: pointer !important;
        font-weight: bold;
    }

    .form-group {
        margin-bottom: 0.5rem;
    }

    .calendar-container {
        cursor: pointer;
        padding: 8px 8px;
        width: 100%;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        transition: background-color 0.3s, box-shadow 0.3s;
        gap: 8px;
        border: 1px solid slategray;
    }

        .calendar-container:hover {
            background-color: #e3f2fd;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        .calendar-container i.fa-calendar {
            color: #2196f3;
            font-size: 1.2em;
            padding-left: 6px;
        }

        .calendar-container span {
            color: #4682B4;
            margin: 0;
            font-size: 14px;
        }

    @@keyframes flash-bg {
        0% {
            background-color: #fff3cd;
        }

        100% {
            background-color: transparent;
        }
    }

    .row-flash {
        animation: flash-bg 2s ease-out forwards;
    }

    .tabulator-row.row-flash {
        transition: background-color 2s ease-out;
    }

    /* AHP-style tabs */
    .nav-tabs .nav-link {
        border: 1px solid transparent;
        border-bottom: none;
        color: #333;
        background: transparent;
        font-weight: 500;
        font-size: 14px;
        transition: all .2s ease-in-out;
        padding: 8px 16px;
    }

        .nav-tabs .nav-link:hover {
            color: #000;
        }

        .nav-tabs .nav-link.active {
            color: #000 !important;
            font-weight: 700 !important;
            font-size: 15.5px !important;
            background: #fff;
            border-top: 3px solid #0c83ff;
            border-left: 3px solid #0c83ff;
            border-right: 3px solid #0c83ff;
            border-bottom: none !important;
            border-radius: 6px 6px 0 0;
        }
</style>

<div class="content">
    <div class="row">
        <div class="col-12">

            <!-- HEADER CARD -->
            <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">

                    <!-- Title -->
                    <div>
                        <b style="font-size: large;color: #4682B4;">Merge Tracker</b>
                    </div>

                    <!-- DATE PICKER -->
                    <div class="col-md-3">
                        <div id="customDateTriggerMergeTracker" class="calendar-container">
                            <i class="fa fa-calendar"></i>
                            <span id="dateRangeMergeTracker">Select Date Range</span>
                        </div>
                    </div>

                    <!-- BUTTONS -->
                    <div>
                        <button id="exportMergeTrackerButton" type="button"
                                class="btn btn-outline-danger legitRipple mr-2"
                                style="width: 140px;font-size:15px">
                            <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                        </button>

                        <button id="backButton"
                                class="btn btn-outline-primary legitRipple mr-2"
                                onclick="location.href='@Url.Action("TrackerMenu", "Home")'">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>

                </div>
            </div>

            <!-- MAIN TABS CARD -->
            <div class="card mt-3">
                <div class="card-body">

                    <!-- TAB HEADERS -->
                    <ul class="nav nav-tabs" id="csoTabs" role="tablist">

                        <li class="nav-item">
                            <a class="nav-link active" id="caReport-tab" data-bs-toggle="tab" href="#caReportTab" role="tab">CA Report</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="customerRca-tab" data-bs-toggle="tab" href="#customerRcaTab" role="tab">Cust. RCA</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="deviation-tab" data-bs-toggle="tab" href="#deviationTab" role="tab">Deviation Summary</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="bisProject-tab" data-bs-toggle="tab" href="#bisProjectTab" role="tab">BIS Project</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="paymentSummary-tab" data-bs-toggle="tab" href="#paymentSummaryTab" role="tab">Payment Summary</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="walujTesting-tab" data-bs-toggle="tab" href="#walujTestingTab" role="tab">Waluj Testing</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="thirdPartyTesting-tab" data-bs-toggle="tab" href="#thirdPartyTestingTab" role="tab">ThirdParty Testing</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="tpi-tab" data-bs-toggle="tab" href="#tpiTab" role="tab">TPI Summary</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="csatSummary-tab" data-bs-toggle="tab" href="#csatSummaryTab" role="tab">CSAT Summary</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="changeNote-tab" data-bs-toggle="tab" href="#changeNoteTab" role="tab">Change Note Summary</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" id="npiValidation-tab" data-bs-toggle="tab" href="#npiValidationTab" role="tab">NPI Validation</a>
                        </li>

                    </ul>

                    <!-- TAB CONTENT -->
                    <div class="tab-content mt-3">

                        <!-- TAB 1 -->
                        <div class="tab-pane fade show active" id="caReportTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportCAButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="caReport_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2 -->
                        <div class="tab-pane fade" id="customerRcaTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportCustomerRcaButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="customerRca_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 3 -->
                        <div class="tab-pane fade" id="deviationTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportDeviationButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="deviation_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 4 -->
                        <div class="tab-pane fade" id="bisProjectTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportBisProjectButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="bisProject_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 5 -->
                        <div class="tab-pane fade" id="paymentSummaryTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportPaymentSummaryButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="paymentSummary_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 6 -->
                        <div class="tab-pane fade" id="walujTestingTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportWalujTestingButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="walujTesting_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 7 -->
                        <div class="tab-pane fade" id="thirdPartyTestingTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportThirdPartyTestingButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="thirdPartyTesting_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 8 -->
                        <div class="tab-pane fade" id="tpiTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportTpiButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="tpi_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 9 -->
                        <div class="tab-pane fade" id="csatSummaryTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportCsatSummaryButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="csatSummary_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 10 -->
                        <div class="tab-pane fade" id="changeNoteTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportChangeNoteButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="changeNote_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 11 -->
                        <div class="tab-pane fade" id="npiValidationTab" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button id="exportNpiValidationButton" type="button"
                                        class="btn btn-outline-danger legitRipple mr-2"
                                        style="width: 140px;font-size:15px">
                                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                                </button>
                            </div>
                            <div class="chart-container">
                                <div class="form-group row">
                                    <div id="npiValidation_Table" class="col-12"></div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- end tab-content -->
                </div> <!-- end card-body -->
            </div> <!-- end card -->

        </div>
    </div>
</div>

@section Scripts {

    <script src="~/js/tabulator.js"></script>
    <script src="~/js/tabulator.min.js"></script>

    <!-- Moment.js and Litepicker -->
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="~/js/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

    <script>

        var caGrid, customerRcaGrid, deviationGrid, bisGrid, paymentGrid,
            walujGrid, tpiGrid, csatGrid, changeNoteGrid, npiValidationGrid, thirdPartyGrid;

        let filterStartPaymentDate = moment().startOf('month').format('YYYY-MM-DD');
        let filterEndPaymentDate = moment().endOf('month').format('YYYY-MM-DD');

        $(document).ready(function () {

            $('#dateRangeMergeTracker').text(
                moment(filterStartPaymentDate).format('MMMM D, YYYY') + ' - ' + moment(filterEndPaymentDate).format('MMMM D, YYYY')
            );

            const picker = new Litepicker({
                element: document.getElementById('customDateTriggerMergeTracker'),
                singleMode: false,
                format: 'DD-MM-YYYY',
                numberOfMonths: 2,
                numberOfColumns: 2,
                dropdowns: { minYear: 2020, maxYear: null, months: true, years: true },
                plugins: ['ranges'],
                setup: (picker) => {
                    picker.on('selected', (start, end) => {
                        filterStartPaymentDate = start.format('YYYY-MM-DD');
                        filterEndPaymentDate = end.format('YYYY-MM-DD');
                        $('#dateRangeMergeTracker').text(`${start.format('MMMM D, YYYY')} - ${end.format('MMMM D, YYYY')}`);

                        fetchAllActivitySummary();
                    });

                    picker.on('clear', () => {
                        filterStartPaymentDate = "";
                        filterEndPaymentDate = "";
                        $('#dateRangeMergeTracker').text("Select Date Range");
                    });
                },
                ranges: {
                    Today: [moment(), moment()],
                    Yesterday: [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },
                startDate: moment().startOf('month').format('DD-MM-YYYY'),
                endDate: moment().endOf('month').format('DD-MM-YYYY')
            });

            $('#customDateTriggerMergeTracker').on('click', function () {
                picker.show();
            });

            loadCAReportGrid();
            loadCustomerRcaGrid();
            loadDeviationGrid();
            loadBisProjectGrid();
            loadPaymentSummaryGrid();
            loadWalujTestingGrid();
            loadThirdPartyTestingGrid();
            loadTpiGrid();
            loadCsatSummaryGrid();
            loadChangeNoteGrid();
            loadNpiValidationGrid();
            fetchAllActivitySummary();

            $('#exportMergeTrackerButton').on('click', function() {
                // List all tables you want to include in the master file
                const tablesToExport = [
                    { instance: caGrid, sheetName: 'CA_Report' },
                    { instance: customerRcaGrid, sheetName: 'Customer_RCA' },
                    { instance: deviationGrid, sheetName: 'Deviation_Summary' },
                    { instance: bisGrid, sheetName: 'BIS_Project' },
                    { instance: paymentGrid, sheetName: 'Payment_Summary' },
                    { instance: walujGrid, sheetName: 'Waluj_Testing' },
                    { instance: thirdPartyGrid, sheetName: 'Third_Party_Testing' },
                    { instance: tpiGrid, sheetName: 'TPI_Summary' },
                    { instance: csatGrid, sheetName: 'CSAT_Summary' },
                    { instance: changeNoteGrid, sheetName: 'Change_Note' },
                    { instance: npiValidationGrid, sheetName: 'NPI_Validation' }
                ];

                // Filter out any grids that haven't been initialized yet
                const initializedTables = tablesToExport.filter(t => t.instance !== undefined);

                if (initializedTables.length === 0) {
                    alert("No data available to export. Please open the tabs to load data.");
                    return;
                }

                exportAllTablesToSingleExcel(initializedTables, 'Merge_Tracker_Full_Report');
            });
           
            // 1. CA Report
            $('#exportCAButton').on('click', () => exportTableToExcel(caGrid, 'CA_Report'));

            // 2. Customer RCA
            $('#exportCustomerRcaButton').on('click', () => exportTableToExcel(customerRcaGrid, 'Customer_RCA_Report'));

            // 3. Deviation
            $('#exportDeviationButton').on('click', () => exportTableToExcel(deviationGrid, 'Deviation_Report'));

            // 4. BIS Project
            $('#exportBisProjectButton').on('click', () => exportTableToExcel(bisGrid, 'BIS_Project_Report'));

            // 5. Payment Summary
            $('#exportPaymentSummaryButton').on('click', () => exportTableToExcel(paymentGrid, 'Payment_Summary_Report'));

            // 6. Waluj Testing
            $('#exportWalujTestingButton').on('click', () => exportTableToExcel(walujGrid, 'Waluj_Testing_Report'));

            // 7. Third Party Testing
            $('#exportThirdPartyTestingButton').on('click', () => exportTableToExcel(thirdPartyGrid, 'Third_Party_Testing_Report'));

            // 8. TPI
            $('#exportTpiButton').on('click', () => exportTableToExcel(tpiGrid, 'TPI_Report'));

            // 9. CSAT
            $('#exportCsatSummaryButton').on('click', () => exportTableToExcel(csatGrid, 'CSAT_Summary_Report'));

            // 10. Change Note
            $('#exportChangeNoteButton').on('click', () => exportTableToExcel(changeNoteGrid, 'Change_Note_Report'));

            // 11. NPI Validation
            $('#exportNpiValidationButton').on('click', () => exportTableToExcel(npiValidationGrid, 'NPI_Validation_Report'));

        });

        // ---------- HEADER MENU ----------
        var headerMenu = function () {
            var menu = [];
            var columns = this.getColumns();

            for (let column of columns) {
                let icon = document.createElement("i");
                icon.classList.add("fas");
                icon.classList.add(column.isVisible() ? "fa-check-square" : "fa-square");

                let label = document.createElement("span");
                let title = document.createElement("span");
                title.textContent = " " + column.getDefinition().title;

                label.appendChild(icon);
                label.appendChild(title);

                menu.push({
                    label: label,
                    action: function (e) {
                        e.stopPropagation();
                        column.toggle();
                        if (column.isVisible()) {
                            icon.classList.remove("fa-square");
                            icon.classList.add("fa-check-square");
                        } else {
                            icon.classList.remove("fa-check-square");
                            icon.classList.add("fa-square");
                        }
                    }
                });
            }

            return menu;
        };

        // ---------- DATA FETCHING ----------
        function fetchAllActivitySummary() {
            if (!filterStartPaymentDate || !filterEndPaymentDate) return;

            Blockloadershow();

            $.ajax({
                url: '@Url.Action("GetAllActivitySummary", "MergeTracker")',
                type: 'GET',
                data: {
                    fromDate: filterStartPaymentDate,
                    toDate: filterEndPaymentDate
                },
                success: function (response) {
                    Blockloaderhide();
                    if (response) {
                        // Response.summary is a single object, Tabulator needs an array
                        const summaryArray = response.summary ? [response.summary] : [];

                        const formatDate = (dateStr) => {
                            const dateObj = new Date(dateStr);
                            return dateObj.toLocaleDateString("en-GB");
                        };

                        // 1. CA Report
                        caGrid.setData(summaryArray.map(s => ({
                            "From": formatDate(s.fromDate), "To": formatDate(s.toDate),
                            "Total_Registered": s.caTotalComplaintRegistered,
                            "Till_Open": s.caTillDateOpenComplaint,
                            "Till_Closed": s.caTillDateClosedComplaint
                        })));

                        // 2. RCA Report
                        customerRcaGrid.setData(summaryArray.map(s => ({
                            "From": formatDate(s.fromDate), "To": formatDate(s.toDate),
                            "Total_Registered": s.rcaTotalComplaintRegistered,
                            "Till_Open": s.rcaTillDateOpenComplaint,
                            "Till_Closed": s.rcaTillDateClosedComplaint
                        })));

                        // 3. Deviation
                        deviationGrid.setData(summaryArray.map(s => ({
                            "From": formatDate(s.fromDate), "To": formatDate(s.toDate),
                            "Total_Deviation": s.totalDeviationRaised
                        })));

                        // 4. BIS Project
                        bisGrid.setData(summaryArray.map(s => ({
                            "From": s.fromMonth, "To": s.toMonth,
                            "Total_Project": s.totalProject, "Model_Inclusion": s.modelInclusion,
                            "Series_Addition": s.seriesAddition, "CCL_Updation": s.cclUpdation,
                            "CCL_Series": s.cclSeries, "Others": s.othersProject
                        })));

                        // 5. Payment Summary
                        paymentGrid.setData(summaryArray.map(s => ({
                            "From": s.fromMonth, "To": s.toMonth,
                            "Total_Payment": s.totalPayment
                        })));

                        //6. Third Party
                        thirdPartyGrid.setData(summaryArray.map((f, i) => ({
                            "From": f.fromMonth, "To": f.toMonth,
                            "Total_Testing_Initiated": f.totalTestingInitiated, "Testing_Completed": f.testingCompleted, "Testing_Pending_To_Complete": f.testingPendingToComplete
                        })));

                        // 7. TPI
                        tpiGrid.setData(summaryArray.map(s => ({
                            "From": s.fromMonth, "To": s.toMonth,
                            "Total_TPI": s.totalNumberOfTPI, "Project_Value": s.projectValue
                        })));

                        // 8. Change Note
                        changeNoteGrid.setData(summaryArray.map(s => ({
                            "From": s.fromMonth, "To": s.toMonth,
                            "Total_Change_Note": s.totalChangeNoteRaised
                        })));

                        // 9. NPI Validation
                        npiValidationGrid.setData(summaryArray.map(s => ({
                            "From": s.fromMonth, "To": s.toMonth,
                            "Total_Validation": s.totalValidation,
                            "AsOn_Open_Validation": s.asOnOpenValidation,
                            "AsOn_Close_Validation": s.asOnCloseValidation
                        })));

                        // 10. FIFO / Waluj (List)
                        walujGrid.setData(response.fifoDetails.map((s, i) => ({
                            "Sr_No": i + 1, "From": response.summary.fromMonth, "To": response.summary.toMonth,
                            "Test": s.test, "Qty": s.qty, "Test_Completed": s.testCompleted, "Test_Pending": s.testPending
                        })));

                        // 11. CSAT (List)
                        csatGrid.setData(response.csatDetails.map((c, i) => ({
                            "Sr_No": i + 1, "FY": c.fy, "Quarter": c.quarter,
                            "Request_Sent": c.requestSent, "Responses_Received": c.responsesReceived,
                            "Promoters": c.promoters, "Percent_Collection": c.collection,
                            "Detractors": c.detractors, "NPS": c.nps
                        })));
                    }
                },
                error: function (ex) {
                    Blockloaderhide();
                    showDangerAlert("Data Fetch Error:", ex);
                }
            });
        }

        // ---------- GRID DEFINITIONS ----------

        function loadCAReportGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Complaint Registered", field: "Total_Registered", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Till Date Open Complaint", field: "Till_Open", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Till Date Closed Complaint", field: "Till_Closed", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            caGrid = new Tabulator("#caReport_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadCustomerRcaGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Complaint Registered", field: "Total_Registered", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Till Date Open Complaint", field: "Till_Open", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Till Date Closed Complaint", field: "Till_Closed", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            customerRcaGrid = new Tabulator("#customerRca_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadDeviationGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Deviation Raised", field: "Total_Deviation", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            deviationGrid = new Tabulator("#deviation_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadBisProjectGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Project", field: "Total_Project", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Model Inclusion", field: "Model_Inclusion", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Series addition", field: "Series_Addition", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "CCL Updation", field: "CCL_Updation", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "CCL+Series", field: "CCL_Series", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Others", field: "Others", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            bisGrid = new Tabulator("#bisProject_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadPaymentSummaryGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Payment", field: "Total_Payment", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            paymentGrid = new Tabulator("#paymentSummary_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadWalujTestingGrid() {
            let columns = [
                { title: "Sr No.", field: "Sr_No", width: 110, hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Test", field: "Test", headerFilter: "input", hozAlign: "left", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Qty", field: "Qty", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "TestCompleted", field: "Test_Completed", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Test Pending", field: "Test_Pending", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            walujGrid = new Tabulator("#walujTesting_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadThirdPartyTestingGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Testing Initiated", field: "Total_Testing_Initiated", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Testing Completed", field: "Testing_Completed", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Testing Pending To Complete", field: "Testing_Pending_To_Complete", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            thirdPartyGrid = new Tabulator("#thirdPartyTesting_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadTpiGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Number of TPI", field: "Total_TPI", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Project Value", field: "Project_Value", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            tpiGrid = new Tabulator("#tpi_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadCsatSummaryGrid() {
            let columns = [
                { title: "Sr No.", field: "Sr_No", width: 110, hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "FY", field: "FY", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Quarter", field: "Quarter", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Request Sent", field: "Request_Sent", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Responses Received", field: "Responses_Received", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Promoters", field: "Promoters", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "% Collection", field: "Percent_Collection", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Detractors", field: "Detractors", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "NPS", field: "NPS", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            csatGrid = new Tabulator("#csatSummary_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadChangeNoteGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Change Note Raised", field: "Total_Change_Note", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            changeNoteGrid = new Tabulator("#changeNote_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        function loadNpiValidationGrid() {
            let columns = [
                { title: "From", field: "From", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "To", field: "To", headerFilter: "input", hozAlign: "center", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "Total Validation", field: "Total_Validation", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "As on Open Validation", field: "AsOn_Open_Validation", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu },
                { title: "As on Close Validation", field: "AsOn_Close_Validation", headerFilter: "input", hozAlign: "right", headerHozAlign: "center", headerMenu: headerMenu }
            ];
            npiValidationGrid = new Tabulator("#npiValidation_Table", { data: [], layout: "fitColumns", movableColumns: true, pagination: "local", paginationSize: 10, columns: columns });
        }

        async function exportTableToExcel(tableInstance, fileName) {
            Blockloadershow();
            if (!tableInstance) {
                // Simple fallback if grid isn't initialized
                console.error('Table data is not loaded yet.');
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const sheetName = fileName.replace(/_/g, ' ').substring(0, 31);
            const worksheet = workbook.addWorksheet(sheetName);

            // 1. Get Columns from Tabulator (excluding internal ones)
            const columns = tableInstance.getColumns();
            const headerTitles = [];
            const excelColumns = [];

            columns.forEach(col => {
                const def = col.getDefinition();
                if (def.title && def.field) {
                    headerTitles.push(def.title);
                    excelColumns.push({ key: def.field, width: 20 });
                }
            });

            worksheet.columns = excelColumns;

            // 2. Add and Style Header Row
            const headerRow = worksheet.addRow(headerTitles);
            headerRow.eachCell((cell) => {
                cell.font = { bold: true, color: { argb: 'FFFFFF' } };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: '4472C4' } // Corporate Blue
                };
                cell.border = {
                    top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
                };
            });

            // 3. Add Data Rows (active filters/sorts respected)
            const rowData = tableInstance.getData("active");
            rowData.forEach(item => {
                const rowValues = [];
                columns.forEach(col => {
                    const field = col.getDefinition().field;
                    if (field) rowValues.push(item[field]);
                });
                const row = worksheet.addRow(rowValues);
        
                // Basic alignment for data
                row.eachCell((cell) => {
                    cell.alignment = { vertical: 'middle', horizontal: 'left' };
                    cell.border = {
                        top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
                    };
                });
            });

            // 4. Generate and Download
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = fileName + '.xlsx';
            anchor.click();
            window.URL.revokeObjectURL(url);
            Blockloaderhide();
        }

        async function exportAllTablesToSingleExcel(tablesArray, finalFileName) {
            Blockloadershow();
            const workbook = new ExcelJS.Workbook();

            for (const item of tablesArray) {
                const table = item.instance;
                const rawName = item.sheetName;

                // Skip if table isn't initialized or has no data
                if (!table) continue;

                // 1. Clean Sheet Name (No underscores, max 31 chars)
                const cleanSheetName = rawName.replace(/_/g, ' ').substring(0, 31);
                const worksheet = workbook.addWorksheet(cleanSheetName);

                // 2. Get Columns
                const columns = table.getColumns();
                const headerTitles = [];
                const excelColumns = [];

                columns.forEach(col => {
                    const def = col.getDefinition();
                    if (def.title && def.field) {
                        headerTitles.push(def.title);
                        excelColumns.push({ key: def.field, width: 20 });
                    }
                });

                worksheet.columns = excelColumns;

                // 3. Add and Style Header Row
                const headerRow = worksheet.addRow(headerTitles);
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true, color: { argb: 'FFFFFF' } };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: '4472C4' } // Corporate Blue
                    };
                });

                // 4. Add Data Rows
                const rowData = table.getData("active");
                rowData.forEach(dataItem => {
                    const rowValues = [];
                    columns.forEach(col => {
                        const field = col.getDefinition().field;
                        if (field) rowValues.push(dataItem[field]);
                    });
                    const row = worksheet.addRow(rowValues);
                    row.eachCell(c => {
                        c.border = {
                            top: {style:'thin'}, left: {style:'thin'}, 
                            bottom: {style:'thin'}, right: {style:'thin'}
                        };
                    });
                });
            }

            // 5. Save the final single file
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = finalFileName + '.xlsx';
            anchor.click();
            window.URL.revokeObjectURL(url);
            Blockloaderhide();
        }
    </script>
}



    @section HideSidebar { }
