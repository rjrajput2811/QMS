@model QMS.Core.Models.InstallationTrialViewModel

@{
    ViewData["Title"] = "Installation Trial Report";
}


<style>

    .req {
        color: #d00;
        font-style: normal;
    }

    /* Header title card */
    .card-header-title {
        font-size: x-large;
        color: #4682B4;
        font-weight: 700;
    }

    /* Header button styles */
    .header-btn {
        width: 120px;
        font-size: 15px;
        border-radius: 6px;
    }

    /* Base style for table section */
    .header-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        border: 1px solid #000;
        margin-bottom: 5px !important;
    }

        .header-table td {
            border: 1px solid #000;
            padding: 10px 12px;
            vertical-align: middle;
            white-space: nowrap;
        }

        .header-table + hr {
            margin-top: 0 !important;
        }

    /* Label styling */
    .field-label {
        font-weight: 600;
        color: #000;
        margin-right: 6px;
    }

    /* ==== PHOTO HEADER STYLING ==== */
    .photo-head {
        background: #eef2f5;
        text-align: center;
        vertical-align: middle;
        height: 110px; /* increased height */
    }

    .photo-header-content {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 18px;
    }

    .photo-text {
        font-size: 20px;
        font-weight: 500;
        color: #2b4b6f;
    }

    .photo-header-content input[type="file"] {
        font-size: 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: #333;
    }

    /* Underline-only input fields */
    .inline-input,
    .inline-date {
        display: inline-block;
        border: none;
        border-bottom: 1.5px solid #666;
        background: transparent;
        width: 60%;
        font-size: 14px;
        padding: 2px 4px;
        outline: none;
        box-shadow: none;
        transition: border-color 0.2s ease-in-out;
        vertical-align: baseline;
    }

        .inline-input:focus,
        .inline-date:focus {
            border-bottom-color: #4682B4;
        }

        .inline-date::-webkit-calendar-picker-indicator {
            opacity: 1;
            cursor: pointer;
            margin-left: 4px;
        }

        .inline-date::-ms-clear,
        .inline-date::-webkit-clear-button {
            display: none;
        }

    /* 🔹 Result Cell Styling */
    .result-cell {
        font-weight: 700;
        color: red;
        padding: 12px 10px;
        vertical-align: middle;
        background: #fff;
        font-size: 14px;
    }

    /* 🔹 Unified modern dropdown style (for all dropdowns) */
    .result-dropdown,
    .result-select {
        width: 100%;
        padding: 6px 25px 6px 10px;
        border: none; /* remove all sides */
        border-bottom: 1.5px solid #cbd5e1; /* underline only */
        border-radius: 6px; /* soft curve */
        background-color: #fff; /* white background */
        font-size: 14px;
        color: #000;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='12' viewBox='0 0 20 20' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M5.516 7.548l4.484 4.486 4.484-4.486L16 8.548l-6 6-6-6z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
        cursor: pointer;
        transition: all 0.25s ease-in-out;
        box-shadow: none; /* remove background shadows */
    }

        /* 🔹 Focus & Hover States */
        .result-dropdown:focus,
        .result-select:focus {
            outline: none;
            border-bottom-color: #4a90e2; /* blue underline */
        }

        .result-dropdown:hover,
        .result-select:hover {
            border-bottom-color: #93b4d8; /* lighter blue on hover */
        }

        /* Dropdown option list */
        .result-dropdown option,
        .result-select option {
            background: #fff;
            color: #000;
        }

    /* PV table */
    .pv-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 14px;
    }

        .pv-table th,
        .pv-table td {
            border: 1px solid #000;
            padding: 8px 10px;
            vertical-align: top;
        }

        .pv-table thead th {
            background: #eef2f5;
            text-align: center;
            font-weight: 700;
        }

        .pv-table col.serial {
            width: 8%;
        }

        .pv-table col.param {
            width: 32%;
        }

        .pv-table col.result {
            width: 25%;
        }

        .pv-table td[contenteditable="true"] {
            outline: none;
        }

            .pv-table td[contenteditable="true"]:focus {
                box-shadow: inset 0 -2px 0 #4682B4;
                background: #f9fcff;
            }

    /* Photo table */
    .photo-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        table-layout: fixed;
        margin-top: 0;
    }

        .photo-table th,
        .photo-table td {
            border: 1px solid #000;
            vertical-align: middle;
            text-align: center;
        }

        .photo-table th {
            background: #eef2f5;
            font-weight: 600;
            height: 35px;
        }

    .header-responsive {
        overflow: visible !important; /* allow dropdown to overflow */
        position: relative;
        z-index: 2000;
    }

    .header-table td {
        overflow: visible; /* allow children to overflow */
    }
</style>


<div class="content">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc;">
                <div class="card-body d-flex justify-content-between align-items-center py-3" style="min-height:80px;">
                    <div>
                        <b style="font-size:large; color:#4682B4;">Installation Trial Report</b>
                    </div>
                    <div>
                        <button id="saveInstallationButton" type="button" class="btn btn-outline-success legitRipple mr-2 header-btn" onclick="saveInstallationTrial()">
                            <i class="fas fa-save mr-1"></i>Save
                        </button>
                        <a href='@Url.Action("InstallationTrialReport", "ProductValidation")' class="btn btn-outline-primary header-btn">
                            <i class="fas fa-arrow-left"></i> BACK
                        </a>
                    </div>
                </div>
            </div>


            <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc;">
                <form id="installation_form" method="post" asp-action="InsertUpdateInstallationTrail" asp-controller="ProductValidation" enctype="multipart/form-data">
                    <div class="card-body">
                        @Html.HiddenFor(m => m.Id)
                        <div class="">
                            <table class="header-table">
                                <colgroup>
                                    <col style="width:46%;">
                                    <col style="width:26%;">
                                    <col style="width:28%;">
                                </colgroup>
                                <tbody>
                                    <tr>
                                        <td>
                                            <span class="field-label">Report No:</span><em class="req">*</em>
                                            @* <input type="text" name="ReportNo" class="inline-input" placeholder="Enter Report Number" required /> *@
                                            @Html.TextBoxFor(m => m.ReportNo, new { @class = "inline-input form-control", placeholder = "Enter Report Number", required = "required" })
                                        </td>

                                        <td>
                                            <span class="field-label">Date:</span><em class="req">*</em>
                                            @* <input type="date" name="ReportDate" class="inline-date" placeholder="Select Date" required /> *@
                                            @* @Html.TextBoxFor(m => m.ReportDate, "{0:dd/MM/yyyy}", new { @class = "inline-date", placeholder = "Select Date", @readonly = "readonly" }) *@
                                            @Html.TextBoxFor(m => m.ReportDate, "{0:yyyy-MM-dd}", new
                                                {
                                                    @class = "inline-date d-inline-block",
                                                    style = "width:60%; font-size:13px;",
                                                    placeholder = "dd-mm-yyyy",
                                                    title = "Enter date as dd-mm-yyyy",
                                                    required = "required",
                                                    type = "date"
                                                })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            @* <input type="text" name="ProductCatRef" class="inline-input" placeholder="Enter Product Reference" required /> *@
                                            <div class="row g-2 align-items-center mt-1">
                                            <span class="field-label">Product Cat Ref:</span><em class="req">*</em>
                                                <!-- BIS Search Code -->
                                                <div class="col-md-3 mr-3">
                                                    <input type="text"
                                                           name="prodCode_Search"
                                                           id="prodCode_Search"
                                                           class="inline-input form-control"
                                                           placeholder="Search Code"
                                                           aria-label="Search Code"
                                                           oninput="handleProdCodeSearch(this)"
                                                           style="text-transform: uppercase;width: 175px;" />
                                                </div>
                                                <div class="col-md-6">
                                                    @Html.TextBoxFor(m => m.ProductCatRef, new { @class = "inline-input form-control", placeholder = "Enter Product Reference", required = "required", style = "width:230px;" })
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="field-label">Batch Code:</span>
                                            @* <input type="text" name="BatchCode" class="inline-input" placeholder="Enter Batch Code" /> *@
                                            @Html.TextBoxFor(m => m.BatchCode, new { @class = "inline-input form-control", placeholder = "Enter Batch Code" })

                                        </td>
                                        <td>
                                            <span class="field-label">Sample Qty:</span>
                                            @* <input type="text" name="SampleQty" class="inline-input" placeholder="Enter Quantity" /> *@
                                            @Html.TextBoxFor(m => m.SampleQty, new { @class = "inline-input form-control", placeholder = "Enter Quantity" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="field-label">Product Description:</span><em class="req">*</em>
                                            @* <input type="text" name="ProductDescription" class="inline-input" placeholder="Enter Product Description" required /> *@
                                            @Html.TextBoxFor(m => m.ProductDescription, new { @class = "inline-input form-control", placeholder = "Enter Product Description", required = "required" })
                                        </td>
                                        <td>
                                            <span class="field-label">PKD:</span>
                                            @* <input type="text" name="PKD" class="inline-input" placeholder="Enter PKD" /> *@
                                            @Html.TextBoxFor(m => m.PKD, new { @class = "inline-input form-control", placeholder = "Enter PKD" })
                                        </td>
                                        <td>
                                            <span class="field-label">Installation Location:</span><em class="req">*</em>
                                            <input type="text" name="InstallLocation" class="inline-input" placeholder="Enter Location" required />
                                            @* @Html.TextBoxFor(m => m.InstallLocation, new { @class = "inline-input form-control", placeholder = "Enter Location", required = "required" }) *@
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Parameters Table -->
                        <div class="table-responsive">
                            <table class="pv-table looklikeshot" id="parameterTable">
                                <colgroup>
                                    <col class="serial" />
                                    <col class="param" />
                                    <col class="sample" />
                                    <col class="result" />
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>Serial No.</th>
                                        <th>PARAMETERS</th>
                                        <th>SAMPLE DETAILS</th>
                                        <th class="result-header" style="color:#d00;">Result - Pass/ Fail/ Not Applicable/ Pending</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td contenteditable="false">1</td>
                                        <td contenteditable="false">Product Category</td>
                                        <td contenteditable="true" data-name="ProductCategory_SampleDetails">@Model.ProductCategory_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="ProductCategory_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.ProductCategory_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.ProductCategory_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.ProductCategory_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.ProductCategory_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="false">2</td>
                                        <td contenteditable="false">Installation Sheet</td>
                                        <td contenteditable="true" data-name="InstallationSheet_SampleDetails">@Model.InstallationSheet_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="InstallationSheet_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.InstallationSheet_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.InstallationSheet_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.InstallationSheet_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.InstallationSheet_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="false">3</td>
                                        <td contenteditable="false">Mounting Mechanism</td>
                                        <td contenteditable="true" data-name="MountingMechanism_SampleDetails">@Model.MountingMechanism_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="MountingMechanism_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.MountingMechanism_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.MountingMechanism_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.MountingMechanism_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.MountingMechanism_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="false">4</td>
                                        <td contenteditable="false">Duration of Test</td>
                                        <td contenteditable="true" data-name="DurationOfTest_SampleDetails">@Model.DurationOfTest_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="DurationOfTest_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.DurationOfTest_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.DurationOfTest_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.DurationOfTest_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.DurationOfTest_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="false">5</td>
                                        <td contenteditable="false">Installation with 4x Load</td>
                                        <td contenteditable="true" data-name="InstallationWith4xLoad_SampleDetails">@Model.InstallationWith4xLoad_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="InstallationWith4xLoad_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.InstallationWith4xLoad_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.InstallationWith4xLoad_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.InstallationWith4xLoad_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.InstallationWith4xLoad_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="false">6</td>
                                        <td contenteditable="false">Installation with Sand Bag Load</td>
                                        <td contenteditable="true" data-name="InstallationWithSandBagLoad_SampleDetails">@Model.InstallationWithSandBagLoad_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="InstallationWithSandBagLoad_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.InstallationWithSandBagLoad_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.InstallationWithSandBagLoad_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.InstallationWithSandBagLoad_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.InstallationWithSandBagLoad_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="false">7</td>
                                        <td contenteditable="false">Installation with Sand Bag Load</td>
                                        <td contenteditable="true" data-name="InstallationWithSandBagLoad2_SampleDetails">@Model.InstallationWithSandBagLoad2_SampleDetails</td>
                                        <td>
                                            <select class="result-select" data-name="InstallationWithSandBagLoad2_Result">
                                                <option value="">Select</option>
                                                <option value="Pass" selected="@(Model.InstallationWithSandBagLoad2_Result == "Pass")">Pass</option>
                                                <option value="Fail" selected="@(Model.InstallationWithSandBagLoad2_Result == "Fail")">Fail</option>
                                                <option value="Not Applicable" selected="@(Model.InstallationWithSandBagLoad2_Result == "Not Applicable")">Not Applicable</option>
                                                <option value="Pending" selected="@(Model.InstallationWithSandBagLoad2_Result == "Pending")">Pending</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Photo Table (same width, no extra card-body wrappers) -->
                        <div class="table-responsive">
                            <table class="photo-table" style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px;">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="photo-head" style="height:40px;">
                                            @* <div class="photo-header-content">
                                            <span class="photo-text"></span>
                                            <input type="file" id="photoUpload" accept="image/*" />
                                        </div> *@
                                            Photo
                                        </th>
                                    </tr>

                                    <tr>
                                        <th style="border:1px solid #000;">With Load</th>
                                        <th style="border:1px solid #000;">Without Load</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border:1px solid #000; padding:10px;height:180px;">
                                            <div class="photo-header-content">
                                                @Html.HiddenFor(m => m.Photo_WithLoad)
                                                <span class="photo-text"></span>
                                                <input type="file" id="photoUpload1" accept="image/*" name="Photo_WithLoadFile" style="display:block; margin:0 auto;" />
                                                <img id="preview1" alt="Photo 1" src="@Model?.Photo_WithLoad"
                                                @(string.IsNullOrEmpty(Model?.Photo_WithLoad) ? "display:none;" : "display:block;")
                                                     style="margin-top:6px; max-width:85%; max-height:110px;border:1px solid #aaa; border-radius:5px;">
                                            </div>
                                        </td>
                                        <td style="border:1px solid #000; padding:10px;height:150px;">
                                            <div class="photo-header-content">
                                                @Html.HiddenFor(m => m.Photo_WithoutLoad)
                                                <span class="photo-text"></span>
                                                <input type="file" id="photoUpload2" accept="image/*" name="Photo_WithoutLoadFile" style="display:block; margin:0 auto;" />
                                                <img id="preview2" alt="Photo 2" src="@Model?.Photo_WithoutLoad"
                                                @(string.IsNullOrEmpty(Model?.Photo_WithoutLoad) ? "display:none;" : "display:block;")
                                                     style="margin-top:6px; max-width:85%; max-height:110px; border:1px solid #aaa; border-radius:5px;">
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Result (overall) -->
                        <div class="table-responsive">
                            <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px;">
                                <thead>
                                    <tr>
                                        <th style="color:#d00; font-weight:700; text-align:left; background:#fff; border:1px solid #000; padding:15px;">
                                            <div style="display:flex; align-items:center; gap:15px;">
                                                <span>Result - Pass / Fail / NA / Pending</span>
                                                <select class="result-select" style="width:200px;" data-name="OverallResult">
                                                    <option value="" selected="@(Model.OverallResult == "")">Select</option>
                                                    <option value="Pass" selected="@(Model.OverallResult == "Pass")">Pass</option>
                                                    <option value="Fail" selected="@(Model.OverallResult == "Fail")">Fail</option>
                                                    <option value="NA" selected="@(Model.OverallResult == "NA")">NA</option>
                                                    <option value="Pending" selected="@(Model.OverallResult == "Pending")">Pending</option>
                                                </select>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                            </table>
                        </div>

                        <!-- Checked By / Verified By -->
                        <div class="table-responsive" style="margin-top:0px;">
                            <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px;">
                                <tbody>
                                    <tr>
                                        <td style="width:50%; border:1px solid #000; padding:12px;">
                                            <label style="font-weight:600;">Checked By:</label>
                                            @* <input type="text" style="border:none; border-bottom:1.5px solid #000; width:70%; outline:none; background:transparent; margin-left:6px; font-size:14px;" placeholder="Enter name" /> *@
                                            @Html.TextBoxFor(m => m.CheckedBy, new { @class = "inline-input form-control", placeholder = "Enter name", style = "border:none; border-bottom:1.5px solid #000; width:70%; outline:none; background:transparent; margin-left:6px; font-size:14px;" })
                                        </td>
                                        <td style="width:50%; border:1px solid #000; padding:12px;">
                                            <label style="font-weight:600;">Verified By:</label>
                                            @* <input type="text" style="border:none; border-bottom:1.5px solid #000; width:70%; outline:none; background:transparent; margin-left:6px; font-size:14px;" placeholder="Enter name" /> *@
                                            @Html.TextBoxFor(m => m.VerifiedBy, new { @class = "inline-input form-control", placeholder = "Enter name", style = "border:none; border-bottom:1.5px solid #000; width:70%; outline:none; background:transparent; margin-left:6px; font-size:14px;" })
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>

    <script>
        let searchTimeout;

        $(document).ready(function () {
            initPhotoPreviews();

           const inputElement = $("#prodCode_Search");
           if (inputElement.length) {
                    // Attach the keydown event handler
                   inputElement.on('input', function (event) {
                   handleProdCodeSearch(event);
               });
           }
        });

          function handleProdCodeSearch(event) {

            const input = event.target;
            if (!input) return;

            let searchQuery = input.value.trim();

            // 🔴 Clear suggestions if less than 4 chars
            if (searchQuery.length < 4) {
                clearTimeout(searchTimeout);
                // optional: hide suggestion dropdown here
                // hideBisSuggestions();
                return;
            }

            // ✅ Take first 4 characters only
            const searchTerms = searchQuery.substring(0, 4);

            // 🟡 Debounce API call
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                pagedData = {}; // Clear cached data
                fetchProdCodeRelatedData(searchTerms, input);
            }, 300);
        }

            function fetchProdCodeRelatedData(productCatNo, inputField) {
                debugger
                $.ajax({
                    url: '/Vendor/GetCodeSearch', // API endpoint
                    type: 'GET', // HTTP method
                    data: { search: productCatNo }, // Query parameters
                    dataType: 'json', // Expected response data type
                    success: function (data) {
                        if (data && data.length > 0) {
                            displayProdCodeSuggestions(data, inputField);
                        } else {
                            showDangerAlert('No data found for the entered Product Cat No.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching data:', error);
                    }
                });
            }


            // Function to display suggestions in a dropdown
                function displayProdCodeSuggestions(data, inputField) {
                    // Remove any existing dropdown (if any)
                    removeExistingDropdown(inputField);

                    // Ensure parent can anchor absolute dropdown
                    const parent = inputField.parentElement;
                    if (getComputedStyle(parent).position === "static") {
                        parent.style.position = "relative";
                    }

                    const dropdown = document.createElement('div');
                    dropdown.className = 'suggestion-dropdown';
                    dropdown.style.position = 'absolute';
                    dropdown.style.top = (inputField.offsetTop + inputField.offsetHeight) + 'px';
                    dropdown.style.left = inputField.offsetLeft + 'px';
                    dropdown.style.backgroundColor = 'white';
                    dropdown.style.border = '1px solid #ccc';
                    dropdown.style.zIndex = 1000;
                    dropdown.style.overflowY = 'auto';
                    dropdown.style.maxHeight = '300px';
                    dropdown.style.width = inputField.offsetWidth + 'px';
                    dropdown.style.boxShadow = '0px 4px 6px rgba(0, 0, 0, 0.1)';

                    data.forEach(item => {
                        const code = (item.oldPart_No || "").toString().trim();
                        // change these keys as per your API response:
                        const desc = (item.description || item.prodDesc || item.prod_Desc || "").toString().trim();

                        const option = document.createElement('div');
                        option.className = 'suggestion-item';
                        option.textContent = desc ? `${code} | ${desc}` : code;
                        option.style.padding = '8px';
                        option.style.cursor = 'pointer';

                        option.addEventListener('mouseover', () => {
                            option.style.backgroundColor = '#4682B4';
                            option.style.color = '#fff';
                        });
                        option.addEventListener('mouseout', () => {
                            option.style.backgroundColor = '';
                            option.style.color = '';
                        });

                        option.addEventListener('click', () => {

                            const productCatRefInput = document.getElementById('ProductCatRef');
                            if (productCatRefInput) {
                                productCatRefInput.value = code ?? '';
                            }

                            const productDescInput = document.getElementById('ProductDescription');
                            if (productDescInput) {
                                productDescInput.value = desc ?? '';
                            }

                            // optional: also set search box to just code
                            const searchBox = document.getElementById('prodCode_Search');
                            if (searchBox) {
                                searchBox.value = code;
                            }

                            dropdown.remove();
                        });

                        dropdown.appendChild(option);
                    });

                    parent.appendChild(dropdown);
                }



            // Function to remove any existing dropdowns
            function removeExistingDropdown(inputField) {
                const existingDropdown = document.querySelector('.suggestion-dropdown');
                if (existingDropdown) {
                    existingDropdown.remove();
                }
            }

            // Remove dropdown on outside click
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.suggestion-dropdown') && !e.target.closest('#prodCode_Search')) {
                    removeExistingDropdown();
                }
            });

        function setupPreview(inputId, imgId) {
            const inp = document.getElementById(inputId);
            const img = document.getElementById(imgId);

            if (!inp || !img) return;

            inp.addEventListener('change', () => {
                const file = inp.files && inp.files[0];

                if (!file) {
                    img.src = '';
                    img.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = e => {
                    img.src = e.target.result;
                    img.style.display = 'block';
                };

                reader.readAsDataURL(file);
            });
        }

        function initPhotoPreviews() {
            setupPreview('photoUpload1', 'preview1');
            setupPreview('photoUpload2', 'preview2');
        }

        function saveInstallationTrial() {
            Blockloadershow();
            const requiredFields = [
                { id: 'ReportNo', name: 'Report No' },
                { id: 'ProductCatRef', name: 'Product Cat. Ref.' },
                { id: 'ProductDescription', name: 'Product Description' }
            ];

            let isValid = true;
            let missingFields = [];

            requiredFields.forEach(field => {
                const element = $('#' + field.id);
                const value = element.val();

                if (!value) {
                    isValid = false;
                    missingFields.push(field.name);
                }
                else if (field.id === 'SampleQty') {
                    const quantity = Number(value.trim());

                    if (quantity === 0) {
                        isValid = false;
                        missingFields.push(field.name + " (cannot be 0)");
                    }
                }
            });

            if (!isValid) {
                const missingFieldsList = missingFields.map(field => `<li>${field}</li>`).join('');
                const alertMessage = `
                        <p>Please fill out the following required field(s):</p>
                        <ul>${missingFieldsList}</ul>
                    `;
                showDangerAlert(alertMessage);
                Blockloaderhide();
                return false;
            }

            $("#Id").val(@Model.Id);

            const form = $('#installation_form')[0];
            const formData = new FormData(form);

            $('#parameterTable [contenteditable="true"][data-name]').each(function() {
                const dataName = $(this).data('name');
                const content = $(this).text().trim();

                if (dataName) {
                    formData.append(dataName, content);
                }
            });

            $('.result-select[data-name]').each(function () {
                const key = $(this).data('name');
                const val = ($(this).val() || "").toString().trim();
                formData.set(key, val);
            });

            $.ajax({
                url: $('#installation_form').attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    Blockloaderhide();
                    if (!response.success) {
                        var errorMessg = "";
                        if (response.errors != undefined) {
                            for (var error of response.errors) {
                                errorMessg += error + "\n";
                            }
                            if (errorMessg != "") {
                                showDangerAlert(errorMessg);
                            }
                        }
                        else {
                            showDangerAlert(response.message);
                        }
                        return false;
                    }
                    else {
                        if ($("#Id").val() > 0) {
                            showSuccessAlert("Updated Successfully.");
                        }
                        else {
                            showSuccessAlert("Saved Successfully.");
                        }
                        setTimeout(function () {
                            window.open('@Url.Action("InstallationTrialReport", "ProductValidation")', '_self');
                        }, 2500);
                    }
                },
                error: function (xhr, status, error) {
                    Blockloaderhide();
                    showDangerAlert('Error saving data: ' + error);
                }
            });
        }
    </script>
}
@section HideSidebar { }
