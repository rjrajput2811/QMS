@using QMS.Core.Models

@model PhotometryTestReportViewModel


@{
    ViewData["Title"] = "Photometry Test Report";
}

<link href="~/css/fontawesome/styles.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator_bootstrap4.min.css" rel="stylesheet" />
<script src="~/js/jquery.min.js"></script>
<script src="~/js/jquery.datatables.js"></script>
<link href="~/css/pnotify.css" rel="stylesheet" />
<script src="~/js/pnotify.js"></script>
<script src="~/js/pnotify.confirm.js"></script>
<script src="~/lib/bootstrap/dist/js/datatables.buttons.min.js"></script>
<script src="~/lib/bootstrap/dist/js/popupAlert.js"></script>
<script src="~/lib/bootstrap/dist/js/jszip.min.js"></script>
<script src="~/lib/bootstrap/dist/js/buttons.html5.min.js"></script>
<script src="~/js/common.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />

<style>
    .req {
        color: #d00;
        font-style: normal;
    }

    /* thin full-width spacer row (yellow) */
    .pv-table .spacer-row td {
        background: #fff;
        height: 14px;
        padding: 0;
        border-top: 1px solid #000;
        border-bottom: 1px solid #000;
    }

    .pv-table .sign-row td {
        vertical-align: top;
        padding: 6px 10px 25px 10px;
    }

    .same-input {
        border: none;
        border-bottom: 1.5px solid #666;
        background: transparent;
        outline: none;
        font-size: 14px;
        width: 70%;
        padding: 2px 4px;
        transition: border-color .2s ease-in-out;
    }

        .same-input:focus {
            border-bottom-color: #4682B4;
        }

        .same-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

    .header-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        border: 1px solid #000;
        margin-bottom: 0 !important; /* no gap under first table */
        border-bottom: none !important; /* join with second table border */
    }

        .header-table td {
            border: 1px solid #000;
            padding: 10px 12px;
            white-space: nowrap;
            vertical-align: middle;
        }

        .header-table + hr {
            margin-top: 0 !important;
        }

    .field-label {
        font-weight: 600;
        color: #000;
        margin-right: 6px;
    }

    .inline-input,
    .inline-date {
        display: inline-block;
        border: none;
        border-bottom: 1.5px solid #666;
        background: transparent;
        width: 60%;
        font-size: 14px;
        padding: 2px 4px;
        outline: none;
        box-shadow: none;
        transition: border-color 0.2s ease-in-out;
        vertical-align: baseline;
    }

        .inline-input:focus,
        .inline-date:focus {
            border-bottom-color: #4682B4;
        }

        .inline-date::-webkit-calendar-picker-indicator {
            opacity: 1;
            cursor: pointer;
            margin-left: 4px;
        }

        .inline-date::-ms-clear,
        .inline-date::-webkit-clear-button {
            display: none;
        }

    .pv-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-top: 0;
        border-top: none !important; /* share border with header-table */
    }

        .pv-table th,
        .pv-table td {
            border: 1px solid #000;
            padding: 8px 10px;
            vertical-align: middle;
        }

        .pv-table thead th {
            background: #f8f9fa;
            font-weight: 700;
            text-align: center;
        }

        .pv-table .subhead {
            background: #eef2f7;
            font-weight: 700;
            text-align: center;
        }

        .pv-table .result-header {
            color: #d00;
            text-align: center;
        }

        .pv-table .group-cell {
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            background: #fff;
        }

        .pv-table td[contenteditable="true"] {
            background: #fff;
            min-height: 28px;
            cursor: text;
        }

            .pv-table td[contenteditable="true"]:focus {
                outline: 2px solid rgba(70, 130, 180, 0.35);
                background: #f5faff;
            }

    .pretty-select {
        width: 100%;
        padding: 6px 25px 6px 10px;
        border: none;
        border-bottom: 1.5px solid #cbd5e1;
        border-radius: 6px;
        background-color: #fff;
        font-size: 14px;
        color: #000;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='12' viewBox='0 0 20 20' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M5.516 7.548l4.484 4.486 4.484-4.486L16 8.548l-6 6-6-6z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        cursor: pointer;
        transition: all 0.25s ease-in-out;
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.05);
    }

        .pretty-select:focus {
            outline: none;
            border-bottom-color: #4a90e2;
            box-shadow: 0 2px 4px rgba(70, 130, 180, 0.25);
        }

        .pretty-select:hover {
            border-bottom-color: #93b4d8;
        }

        .pretty-select option {
            background: #fff;
            color: #000;
        }

    .result-select {
        width: 100%;
        padding: 8px 30px 8px 12px;
        border: none;
        border-bottom: 2px solid #4682B4;
        border-radius: 0;
        background-color: transparent;
        font-size: 14px;
        color: #000;
        appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='12' viewBox='0 0 20 20' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M5.516 7.548l4.484 4.486 4.484-4.486L16 8.548l-6 6-6-6z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        cursor: pointer;
        transition: border-color 0.2s ease-in-out;
    }

        .result-select:hover,
        .result-select:focus {
            outline: none;
            border-bottom-color: #2f5c8a;
        }

        .result-select::-ms-expand {
            display: none;
        }

    /* Make both tables align perfectly inside the card */
    .card.shadow-sm .card-body .table-responsive {
        padding: 0 !important;
        margin: 0 !important;
    }

    em {
        color: red;
        font-style: normal;
    }
</style>

<div class="content">
    <div class="row">
        <div class="col-12">

            <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc;">
                <div class="card-body d-flex justify-content-between align-items-center py-3" style="min-height:80px;">

                    <!-- Title -->
                    <div>
                        <b style="font-size:large; color:#4682B4;">
                            Photometry Test Report
                        </b>
                    </div>

                    <!-- Buttons -->
                    <div>
                        <button id="savePhotometryButton" type="button"
                                class="btn btn-outline-success legitRipple mr-2" onclick="savePhotometryTest()"
                                style="width:120px; font-size:15px;">
                            <i class="fas fa-save mr-1"></i>Save
                        </button>

                        <a href='@Url.Action("PhotometryTestReport", "ProductValidation")'
                           class="btn btn-outline-primary" style="width:120px; font-size:15px;">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc;">
                <div class="card-body">
                    <form id="PhotometryTest-form" method="post" asp-action="InsertUpdatePhotometryTest" asp-controller="ProductValidation">
                        <div class="table-responsive">
                            <!-- FIRST TABLE (HEADER) -->
                            <table class="header-table">
                                <colgroup>
                                    <col style="width:33%;" />
                                    <col style="width:34%;" />
                                    <col style="width:33%;" />
                                </colgroup>
                                @Html.HiddenFor(m => m.Id)
                                <tbody>
                                    <tr>
                                        <td>
                                            <div style="display:flex; align-items:center; gap:10px;">
                                                <b style="width:105px;">Product Cat Ref :</b> <em>*</em>
                                                <input type="text"
                                                       name="prodCode_Search"
                                                       id="prodCode_Search"
                                                       class="form-control"
                                                       placeholder="Search Code"
                                                       oninput="handleProdCodeSearch(this)"
                                                       style="width:170px; text-transform:uppercase; font-size:13px;" />

                                                @Html.TextBoxFor(m => m.ProductCatRef, new {
                                                @class = "form-control",
                                                                                                style = "width:320px; font-size:13px;",
                                                                                                placeholder = "Enter Product Ref",
                                                                                                required = "required",
                                                                                                type = "text"
                                                                                                })
                                            </div>
                                        </td>
                                        <td>
                                            <span class="field-label">Product Description :</span><em class="req">*</em>
                                            @Html.TextBoxFor(m => m.ProductDescription, new {@class = "inline-input",
                                                                                        placeholder = "Enter Product Description",required = "required",type = "text"})
                                        </td>
                                        <td>
                                            <span class="field-label">Report No. :</span><em class="req">*</em>
                                            @Html.TextBoxFor(m => m.ReportNo, new {@class = "inline-input",
                                                                                        placeholder = "Enter Report Number",required = "required",type = "text"})
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span class="field-label">Driver :</span><em class="req">*</em>
                                            @Html.TextBoxFor(m => m.DriverDetails, new {@class = "inline-input",
                                                                                        placeholder = "Enter Driver Details",required = "required",type = "text"})
                                        </td>
                                        <td>
                                            <span class="field-label">LED Details :</span><em class="req">*</em>
                                            @Html.TextBoxFor(m => m.LedDetails, new {@class = "inline-input",
                                                                                        placeholder = "Enter LED Details",required = "required",type = "text"})
                                        </td>
                                        <td>
                                            <span class="field-label">Date :</span><em class="req">*</em>
                                            @Html.TextBoxFor(m => m.ReportDate, "{0:yyyy-MM-dd}", new { @class = "inline-date", placeholder = "dd-mm-yyyy" ,required = "required",type = "date" })
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- SECOND TABLE (ATTACHED DIRECTLY UNDER, SAME WIDTH, SHARED BORDER) -->
                            <table class="pv-table" id="Photometry_table" name="Photometry_table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="width:10%"></th>
                                        <th rowspan="2" style="width:22%">Parameter</th>
                                        <th rowspan="2" style="width:18%">Specification</th>
                                        <th colspan="5" class="subhead">Measured Values</th>
                                        <th rowspan="2" style="width:18%" class="result-header">
                                            Result ( Pass / Fail / Not Applicable )
                                        </th>
                                    </tr>
                                    <tr>
                                        <th style="width:8%">Sample-1</th>
                                        <th style="width:8%">Sample-2</th>
                                        <th style="width:8%">Sample-3</th>
                                        <th style="width:8%">Sample-4</th>
                                        <th style="width:8%">Sample-5</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="group-cell" rowspan="5">with<br />Sphere</td>
                                        <td contenteditable="true" readyonly>Input Wattage (W)</td>
                                        <td contenteditable="true" data-name="Sphere_InputWattage_Spec">
                                            @Model.Sphere_InputWattage_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_InputWattage_Sample1">
                                            @Model.Sphere_InputWattage_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_InputWattage_Sample2">
                                            @Model.Sphere_InputWattage_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_InputWattage_Sample3">
                                            @Model.Sphere_InputWattage_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_InputWattage_Sample4">
                                            @Model.Sphere_InputWattage_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_InputWattage_Sample5">
                                            @Model.Sphere_InputWattage_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Sphere_InputWattage_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>Luminous Flux (lm)</td>
                                        <td contenteditable="true" data-name="Sphere_LuminousFlux_Spec">
                                            @Model.Sphere_LuminousFlux_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_LuminousFlux_Sample1">
                                            @Model.Sphere_LuminousFlux_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_LuminousFlux_Sample2">
                                            @Model.Sphere_LuminousFlux_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_LuminousFlux_Sample3">
                                            @Model.Sphere_LuminousFlux_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_LuminousFlux_Sample4">
                                            @Model.Sphere_LuminousFlux_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_LuminousFlux_Sample5">
                                            @Model.Sphere_LuminousFlux_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Sphere_LuminousFlux_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>CCT (K)</td>
                                        <td contenteditable="true" data-name="Sphere_CCT_Spec">
                                            @Model.Sphere_CCT_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CCT_Sample1">
                                            @Model.Sphere_CCT_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CCT_Sample2">
                                            @Model.Sphere_CCT_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CCT_Sample3">
                                            @Model.Sphere_CCT_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CCT_Sample4">
                                            @Model.Sphere_CCT_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CCT_Sample5">
                                            @Model.Sphere_CCT_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Sphere_CCT_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>CRI</td>
                                        <td contenteditable="true" data-name="Sphere_CRI_Spec">
                                            @Model.Sphere_CRI_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CRI_Sample1">
                                            @Model.Sphere_CRI_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CRI_Sample2">
                                            @Model.Sphere_CRI_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CRI_Sample3">
                                            @Model.Sphere_CRI_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CRI_Sample4">
                                            @Model.Sphere_CRI_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_CRI_Sample5">
                                            @Model.Sphere_CRI_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Sphere_CRI_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>System Efficiency (lm/W)</td>
                                        <td contenteditable="true" data-name="Sphere_SystemEfficacy_Spec">
                                            @Model.Sphere_SystemEfficacy_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_SystemEfficacy_Sample1">
                                            @Model.Sphere_SystemEfficacy_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_SystemEfficacy_Sample2">
                                            @Model.Sphere_SystemEfficacy_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_SystemEfficacy_Sample3">
                                            @Model.Sphere_SystemEfficacy_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_SystemEfficacy_Sample4">
                                            @Model.Sphere_SystemEfficacy_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Sphere_SystemEfficacy_Sample5">
                                            @Model.Sphere_SystemEfficacy_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Sphere_SystemEfficacy_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="group-cell" rowspan="9">With<br />Gonio</td>
                                        <td contenteditable="true" readyonly>Input Wattage (W)</td>
                                        <td contenteditable="true" data-name="Gonio_InputWattage_Spec">
                                            @Model.Gonio_InputWattage_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_InputWattage_Sample1">
                                            @Model.Gonio_InputWattage_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_InputWattage_Sample2">
                                            @Model.Gonio_InputWattage_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_InputWattage_Sample3">
                                            @Model.Gonio_InputWattage_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_InputWattage_Sample4">
                                            @Model.Gonio_InputWattage_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_InputWattage_Sample5">
                                            @Model.Gonio_InputWattage_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_InputWattage_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>Luminous Flux (lm)</td>
                                        <td contenteditable="true" data-name="Gonio_LuminousFlux_Spec">
                                            @Model.Gonio_LuminousFlux_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_LuminousFlux_Sample1">
                                            @Model.Gonio_LuminousFlux_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_LuminousFlux_Sample2">
                                            @Model.Gonio_LuminousFlux_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_LuminousFlux_Sample3">
                                            @Model.Gonio_LuminousFlux_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_LuminousFlux_Sample4">
                                            @Model.Gonio_LuminousFlux_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_LuminousFlux_Sample5">
                                            @Model.Gonio_LuminousFlux_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_LuminousFlux_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>CCT (K)</td>
                                        <td contenteditable="true" data-name="Gonio_CCT_Spec">
                                            @Model.Gonio_CCT_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CCT_Sample1">
                                            @Model.Gonio_CCT_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CCT_Sample2">
                                            @Model.Gonio_CCT_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CCT_Sample3">
                                            @Model.Gonio_CCT_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CCT_Sample4">
                                            @Model.Gonio_CCT_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CCT_Sample5">
                                            @Model.Gonio_CCT_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_CCT_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>CRI</td>
                                        <td contenteditable="true" data-name="Gonio_CRI_Spec">
                                            @Model.Gonio_CRI_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CRI_Sample1">
                                            @Model.Gonio_CRI_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CRI_Sample2">
                                            @Model.Gonio_CRI_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CRI_Sample3">
                                            @Model.Gonio_CRI_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CRI_Sample4">
                                            @Model.Gonio_CRI_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_CRI_Sample5">
                                            @Model.Gonio_CRI_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_CRI_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>System Efficiency (lm/W)</td>
                                        <td contenteditable="true" data-name="Gonio_SystemEfficacy_Spec">
                                            @Model.Gonio_SystemEfficacy_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_SystemEfficacy_Sample1">
                                            @Model.Gonio_SystemEfficacy_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_SystemEfficacy_Sample2">
                                            @Model.Gonio_SystemEfficacy_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_SystemEfficacy_Sample3">
                                            @Model.Gonio_SystemEfficacy_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_SystemEfficacy_Sample4">
                                            @Model.Gonio_SystemEfficacy_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_SystemEfficacy_Sample5">
                                            @Model.Gonio_SystemEfficacy_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_SystemEfficacy_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>UGR Value</td>
                                        <td contenteditable="true" data-name="Gonio_UGR_Spec">
                                            @Model.Gonio_UGR_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_UGR_Sample1">
                                            @Model.Gonio_UGR_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_UGR_Sample2">
                                            @Model.Gonio_UGR_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_UGR_Sample3">
                                            @Model.Gonio_UGR_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_UGR_Sample4">
                                            @Model.Gonio_UGR_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_UGR_Sample5">
                                            @Model.Gonio_UGR_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_UGR_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>Distribution</td>
                                        <td contenteditable="true" data-name="Gonio_Distribution_Spec">
                                            @Model.Gonio_Distribution_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_Distribution_Sample1">
                                            @Model.Gonio_Distribution_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_Distribution_Sample2">
                                            @Model.Gonio_Distribution_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_Distribution_Sample3">
                                            @Model.Gonio_Distribution_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_Distribution_Sample4">
                                            @Model.Gonio_Distribution_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_Distribution_Sample5">
                                            @Model.Gonio_Distribution_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_Distribution_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>NABL 79 Report</td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Spec">
                                            @Model.Gonio_NABL79_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Sample1"
                                            @Model.Gonio_NABL79_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Sample2">
                                            @Model.Gonio_NABL79_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Sample3">
                                            @Model.Gonio_NABL79_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Sample4">
                                            @Model.Gonio_NABL79_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Sample5">
                                            @Model.Gonio_NABL79_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_NABL79_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>
                                    <tr>
                                        <td contenteditable="true" readyonly>NABL 79 Report of Other Cat Ref as per PPS</td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Other_Spec">
                                            @Model.Gonio_NABL79_Other_Spec
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Other_Sample1">
                                            @Model.Gonio_NABL79_Other_Sample1
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Other_Sample2">
                                            @Model.Gonio_NABL79_Other_Sample2
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Other_Sample3">
                                            @Model.Gonio_NABL79_Other_Sample3
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Other_Sample4">
                                            @Model.Gonio_NABL79_Other_Sample4
                                        </td>
                                        <td contenteditable="true" data-name="Gonio_NABL79_Other_Sample5">
                                            @Model.Gonio_NABL79_Other_Sample5
                                        </td>
                                        <td style="padding:10px;">
                                            @Html.DropDownListFor(m => m.Gonio_NABL79_Other_Result,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" },
                                                                                        new SelectListItem { Text="Not Applicable", Value="Not Applicable" }
                                                                                        },
                                                                                        new { @class = "pretty-select" })
                                        </td>
                                    </tr>

                                    <tr class="spacer-row">
                                        <td colspan="12"></td>
                                    </tr>

                                    <tr class="sign-row">
                                        <td colspan="4" style="font-weight:bold; border:1px solid #000;">
                                            Tested By:&nbsp;
                                            @Html.TextBoxFor(m => m.TestedBy, new {
                                                                                        @class = "same-input",type = "text" ,name = "checkedBy"})
                                        </td>
                                        <td colspan="5" style="font-weight:bold; border:1px solid #000;">
                                            Verified By:&nbsp;
                                            @Html.TextBoxFor(m => m.VerifiedBy, new {
                                                                                        @class = "same-input",type = "text" ,name = "verifiedBy"})
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>

    <script>
        let searchTimeout;
        $(document).ready(function () {

           const inputElement = $("#prodCode_Search");
           if (inputElement.length) {
                    // Attach the keydown event handler
                   inputElement.on('input', function (event) {
                   handleProdCodeSearch(event);
               });
           }
        });

        function handleProdCodeSearch(event) {

            const input = event.target;
            if (!input) return;

            let searchQuery = input.value.trim();

            // 🔴 Clear suggestions if less than 4 chars
            if (searchQuery.length < 4) {
                clearTimeout(searchTimeout);
                // optional: hide suggestion dropdown here
                // hideBisSuggestions();
                return;
            }

            // ✅ Take first 4 characters only
            const searchTerms = searchQuery.substring(0, 4);

            // 🟡 Debounce API call
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                pagedData = {}; // Clear cached data
                fetchProdCodeRelatedData(searchTerms, input);
            }, 300);
        }

          function fetchProdCodeRelatedData(productCatNo, inputField) {
                debugger
                $.ajax({
                    url: '/Vendor/GetCodeSearch', // API endpoint
                    type: 'GET', // HTTP method
                    data: { search: productCatNo }, // Query parameters
                    dataType: 'json', // Expected response data type
                    success: function (data) {
                        if (data && data.length > 0) {
                            displayProdCodeSuggestions(data, inputField);
                        } else {
                            showDangerAlert('No data found for the entered Product Cat No.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching data:', error);
                    }
                });
            }

            // Function to display suggestions in a dropdown
          function displayProdCodeSuggestions(data, inputField) {
                    // Remove any existing dropdown (if any)
                    removeExistingDropdown(inputField);

                    // Ensure parent can anchor absolute dropdown
                    const parent = inputField.parentElement;
                    if (getComputedStyle(parent).position === "static") {
                        parent.style.position = "relative";
                    }

                    const dropdown = document.createElement('div');
                    dropdown.className = 'suggestion-dropdown';
                    dropdown.style.position = 'absolute';
                    dropdown.style.top = (inputField.offsetTop + inputField.offsetHeight) + 'px';
                    dropdown.style.left = inputField.offsetLeft + 'px';
                    dropdown.style.backgroundColor = 'white';
                    dropdown.style.border = '1px solid #ccc';
                    dropdown.style.zIndex = 1000;
                    dropdown.style.overflowY = 'auto';
                    dropdown.style.maxHeight = '300px';
                    dropdown.style.width = inputField.offsetWidth + 'px';
                    dropdown.style.boxShadow = '0px 4px 6px rgba(0, 0, 0, 0.1)';

                    data.forEach(item => {
                        const code = (item.oldPart_No || "").toString().trim();
                        // change these keys as per your API response:
                        const desc = (item.description || item.prodDesc || item.prod_Desc || "").toString().trim();

                        const option = document.createElement('div');
                        option.className = 'suggestion-item';
                        option.textContent = desc ? `${code} | ${desc}` : code;
                        option.style.padding = '8px';
                        option.style.cursor = 'pointer';

                        option.addEventListener('mouseover', () => {
                            option.style.backgroundColor = '#4682B4';
                            option.style.color = '#fff';
                        });
                        option.addEventListener('mouseout', () => {
                            option.style.backgroundColor = '';
                            option.style.color = '';
                        });

                        option.addEventListener('click', () => {

                            const productCatRefInput = document.getElementById('ProductCatRef');
                            if (productCatRefInput) {
                                productCatRefInput.value = code ?? '';
                            }

                            const productDescInput = document.getElementById('ProductDescription');
                            if (productDescInput) {
                                productDescInput.value = desc ?? '';
                            }

                            // optional: also set search box to just code
                            const searchBox = document.getElementById('prodCode_Search');
                            if (searchBox) {
                                searchBox.value = code;
                            }

                            dropdown.remove();
                        });

                        dropdown.appendChild(option);
                    });

                    parent.appendChild(dropdown);
                }

            // Function to remove any existing dropdowns
          function removeExistingDropdown(inputField) {
                const existingDropdown = document.querySelector('.suggestion-dropdown');
                if (existingDropdown) {
                    existingDropdown.remove();
                }
            }

            // Remove dropdown on outside click
          document.addEventListener('click', function (e) {
                if (!e.target.closest('.suggestion-dropdown') && !e.target.closest('#prodCode_Search')) {
                    removeExistingDropdown();
                }
            });

        function savePhotometryTest() {
            Blockloadershow();
            const requiredFields = [
                { id: 'ProductCatRef', name: 'Product Cat Ref' },
                { id: 'ProductDescription', name: 'Product Description' },
                { id: 'ReportNo', name: 'Report No' },
                { id: 'DriverDetails', name: 'Driver Details' },
                { id: 'LedDetails', name: 'LED Details' },
                { id: 'ReportDate', name: 'Report Date' }
            ];

            let isValid = true;
            let missingFields = [];

            requiredFields.forEach(field => {
                const element = $('#' + field.id);
                const value = element.val();

                if (!value) {
                    isValid = false;
                    missingFields.push(field.name);
                }
            });

            if (!isValid) {
                const missingFieldsList = missingFields.map(field => `<li>${field}</li>`).join('');
                const alertMessage = `
                        <p>Please fill out the following required field(s):</p>
                        <ul>${missingFieldsList}</ul>
                    `;
                showDangerAlert(alertMessage);
                Blockloaderhide();
                return false;
            }

            $("#Id").val(@Model.Id);

            const form = $('#PhotometryTest-form')[0];
            const formData = new FormData(form);

            $('#Photometry_table [contenteditable="true"]').each(function() {
                const dataName = $(this).data('name');
                const content = $(this).text().trim();

                if (dataName) {
                    formData.append(dataName, content);
                }
            });

            $.ajax({
                url: $('#PhotometryTest-form').attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    Blockloaderhide();
                    if (!response.success) {
                        var errorMessg = "";
                        if (response.errors != undefined) {
                            for (var error of response.errors) {
                                errorMessg += error + "\n";
                            }
                            if (errorMessg != "") {
                                showDangerAlert(errorMessg);
                            }
                        }
                        else {
                            showDangerAlert(response.message);
                        }
                        return false;
                    }
                    else {
                        if ($("#Id").val() > 0) {
                            showSuccessAlert("Updated Successfully.");
                        }
                        else {
                            showSuccessAlert("Saved Successfully.");
                        }
                        setTimeout(function () {
                            window.open('@Url.Action("PhotometryTestReport", "ProductValidation")', '_self');
                        }, 2500);
                    }
                },
                error: function (xhr, status, error) {
                    Blockloaderhide();
                    showDangerAlert('Error saving data: ' + error);
                }
            });
        }
    </script>
}
@section HideSidebar { }