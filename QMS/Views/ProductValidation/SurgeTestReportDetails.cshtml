@using QMS.Core.Models

@model SurgeTestReportViewModel

@{
    ViewData["Title"] = "SurgeTestReport";
}

<link href="~/css/fontawesome/styles.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator_bootstrap4.min.css" rel="stylesheet" />
<script src="~/js/jquery.min.js"></script>
<script src="~/js/jquery.datatables.js"></script>
<link href="~/css/pnotify.css" rel="stylesheet" />
<script src="~/js/pnotify.js"></script>
<script src="~/js/pnotify.confirm.js"></script>
<script src="~/lib/bootstrap/dist/js/datatables.buttons.min.js"></script>
<script src="~/lib/bootstrap/dist/js/popupAlert.js"></script>
<script src="~/lib/bootstrap/dist/js/jszip.min.js"></script>
<script src="~/lib/bootstrap/dist/js/buttons.html5.min.js"></script>
<script src="~/js/common.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />

<style>

    .hdr-title {
        font-weight: 600;
        color: #000;
        font-size: 14px;
        text-align: center;
        display: inline-block;
    }

    .hdr-value {
        margin-left: 6px;
        color: #555;
        font-style: italic;
        font-size: 13px;
    }


    .hdr-split-title {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
    }

        .hdr-split-title span {
            font-weight: 600;
            color: #000;
            font-size: 14px;
        }

    input.form-control {
        border: none;
        border-bottom: 1px solid #999;
        background: transparent;
        outline: none;
        box-shadow: none;
        border-radius: 0;
        transition: border-color 0.2s ease-in-out;
        padding-left: 0;
        padding-right: 0;
    }
    /* 🔹 Clean, subtle dropdown design */
    .clean-select {
        width: 180px; /* balanced width */
        padding: 6px 25px 6px 10px;
        border: none; /* remove box borders */
        border-bottom: 1.5px solid #cbd5e1; /* thin underline */
        border-radius: 6px; /* subtle curved shape */
        background-color: #fff; /* pure white background */
        font-size: 14px;
        color: #000;
        text-align: center;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='12' viewBox='0 0 20 20' width='12' xmlns='http://www.w3.org/2000/svg'><path d='M5.516 7.548l4.484 4.486 4.484-4.486L16 8.548l-6 6-6-6z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        cursor: pointer;
        transition: all 0.25s ease-in-out;
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.05); /* faint depth */
    }

        .clean-select:focus {
            outline: none;
            border-bottom-color: #4a90e2; /* blue underline when focused */
            box-shadow: 0 2px 4px rgba(70, 130, 180, 0.25); /* soft glow */
        }

        .clean-select:hover {
            border-bottom-color: #93b4d8; /* subtle hover tint */
        }

        .clean-select option {
            background: #fff;
            color: #000;
        }

    input.form-control:focus {
        border-bottom: 1px solid #4682B4;
    }

    /* Header inputs (editable labels) */
    .hdr-input {
        display: inline-block;
        width: 140px;
        border: none;
        border-bottom: 1px solid #999;
        background: transparent;
        outline: none;
        box-shadow: none;
        font-size: 13px;
        margin-left: 6px;
        text-align: left;
    }

        .hdr-input:focus {
            border-bottom: 1px solid #4682B4;
        }

        .hdr-input.text-center {
            text-align: center;
        }

    /* Table look */
    .table {
        border-collapse: collapse;
        font-size: 13px;
    }

        .table th, .table td {
            border: 1px solid #000 !important;
            padding: 6px 8px !important;
            vertical-align: middle !important;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

    em {
        color: red;
        font-style: normal;
    }

    .card {
        border-radius: 8px;
        border: 1px solid #ccc;
        .hdr-divider

    {
        width: 60%;
        height: 2px;
        background-color: #000;
        margin: 4px 0;
    }
    /* 🔹 Header Card Styling (for consistency across forms) */
    .header-card {
        border-radius: 8px;
        border: 1px solid #ccc;
        background-color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    /* 🔹 Title text inside header */
    .header-title {
        font-size: x-large;
        color: #4682B4;
        font-weight: 600;
    }

    /* 🔹 Buttons (Save / Back) */
    .header-btn {
        width: 120px;
        font-size: 15px;
        border-radius: 6px;
        transition: all 0.2s ease-in-out;
    }

        /* Add a small hover zoom effect */
        .header-btn:hover {
            transform: scale(1.05);
        }

    /* Maintain spacing between buttons */
    .mr-2 {
        margin-right: 8px !important;
    }


    /* Editable header inputs (top row) */
    .hdr-input {
        border: none;
        border-bottom: 1px solid #999;
        background: transparent;
        outline: none;
        font-size: 13px;
        width: 100%;
        text-align: center;
    }

        .hdr-input:focus {
            border-bottom: 1px solid #4682B4;
        }

    /* ===========================
                                                                                                                                                                                                                                                                             TABLE / BORDER BASE
                                                                                                                                                                                                                                                                          ============================*/
    /* Use this class on your surge tables (with/without SPD) */
    .surge-table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
    }

        .surge-table th,
        .surge-table td {
            border: 1px solid #000 !important;
            padding: 6px;
            vertical-align: middle;
        }

        .surge-table thead th {
            background-color: #f8f9fa;
            font-weight: 700;
        }

    /* If you keep Bootstrap's table-bordered, ensure single borders */
    .table-bordered {
        border-collapse: separate !important;
        border-spacing: 0;
    }

    /* Fix collapsed double-border between specific rows if needed */
    .no-divider td {
        border-bottom: 0 !important;
    }

    .no-divider-next td {
        border-top: 0 !important;
    }

    /* Wrapper if you need horizontal scroll on small screens */
    .table-responsive {
        overflow-x: auto;
    }

    /* ===========================
                                                                                                                                                                                                                                                                             EDITABLE CELLS
                                                                                                                                                                                                                                                                          ============================*/
    .editable-cell,
    td[contenteditable="true"] {
        background-color: #fff;
        min-height: 30px;
        padding: 6px;
        text-align: center;
    }

        /* Focus cue for contenteditable cells */
        td[contenteditable="true"]:focus {
            outline: 2px solid #4a90e2;
            background-color: #eaf4ff;
        }

        /* Optional placeholder hint for empty editable cells */
        td[contenteditable="true"]:empty::before {
            content: attr(data-placeholder);
            opacity: 0.5;
        }

    /* ===========================
                                                                                                                                                                                                                                                                             RESULT ROW (BOTTOM)
                                                                                                                                                                                                                                                                          ============================*/
    /* Apply this to the <tr> of your final result row */
    .result-row {
        font-weight: 700;
        font-size: 18px;
        text-align: center;
    }

    body {
        background-color: #e7f1fb;
    }
    /* Red labels inside the result row (only labels, not select text) */
    .label-red {
        color: red;
        margin-right: 8px;
        font-weight: 700;
    }

    /* Underline-only dropdowns (neutral look) */
    .underline-select {
        font-size: 18px;
        font-weight: normal;
        color: #000;
        background-color: #f5f7fa;
        border: none;
        border-bottom: 2px solid #d0d7e6;
        border-radius: 0;
        padding: 4px 10px;
        outline: none;
        text-align: center;
        /* Flatten native appearance + add simple chevron */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #6c757d 50%), linear-gradient(135deg, #6c757d 50%, transparent 50%);
        background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
    }

        .underline-select:focus {
            border-bottom-color: #4a90e2;
        }

        /* Center align options (browser support varies) */
        .underline-select option {
            text-align: center;
        }

    /* ===========================
                                                                                                                                                                                                                                                                             UTILITIES (optional)
                                                                                                                                                                                                                                                                          ============================*/
    .text-center {
        text-align: center;
    }

    .mt-2 {
        margin-top: .5rem;
    }

    .mb-2 {
        margin-bottom: .5rem;
    }

    .mt-3 {
        margin-top: 1rem;
    }

    .mb-3 {
        margin-bottom: 1rem;
    }

    .mt-4 {
        margin-top: 1.5rem;
    }

    .mb-4 {
        margin-bottom: 1.5rem;
    }

    .table-surge {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-family: Arial, sans-serif;
        font-size: 13px;
    }

        /* Cells */
        .table-surge th,
        .table-surge td {
            border: 1.5px solid #000;
            text-align: center;
            vertical-align: middle;
            padding: 6px 4px;
            height: 36px;
            box-sizing: border-box;
        }

        /* Headers */
        .table-surge thead th {
            font-weight: 700;
            background: #f5f6f8; /* ✅ Light gray like your screenshot */
            white-space: nowrap;
            line-height: 1.2;
        }

    /* Compact dropdown (underline style) */
    .clean-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border: none;
        border-bottom: 1.5px solid #999;
        background: transparent;
        padding: 2px 18px 2px 6px;
        font-size: 13px;
        cursor: pointer;
        width: 100px;
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 20 20'><path d='M5 7l5 5 5-5' stroke='%23000' stroke-width='1.6' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>");
        background-repeat: no-repeat;
        background-position: right 4px center;
        background-size: 10px;
    }

        .clean-select:focus {
            outline: none;
            border-bottom-color: #4682B4;
        }

    /* Editable cells */
    .table-surge td[contenteditable="true"] {
        white-space: normal;
        text-align: center;
    }

    /* Column sizing */
    .table-surge col {
        width: 8.33%;
    }
</style>

<div class="content">
    <div class="row">
        <div class="col-12">

            <!-- Top Bar -->
            <div class="card shadow-sm mb-3" style="border-radius:8px; border:1px solid #ccc;">
                <div class="card-body d-flex justify-content-between align-items-center py-3" style="min-height:80px;">
                    <div>
                        <b style="font-size:large; color:#4682B4;">
                            Surge Test Report
                        </b>
                    </div>

                    <div>
                        <button id="addSurgeButton" type="button" class="btn btn-outline-success legitRipple mr-2"
                                onclick="insertSurgeTest()" style="width:120px; font-size:15px;">
                            <i class="fas fa-save mr-1"></i>Save
                        </button>

                        <a href='@Url.Action("SurgeTestReport", "ProductValidation")'
                           class="btn btn-outline-primary" style="width:120px; font-size:15px;">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>


            <!-- Body -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="surgeTest-form" method="post" asp-action="InsertUpdateSurgeTestReport" asp-controller="ProductValidation">
                        <div class="table-responsive">
                            @Html.HiddenFor(m => m.Id)
                            <!-- Product Information -->
                            <table class="table table-bordered" style="width:100%;">
                                <tbody>
                                    <tr>
                                        <!-- Row 1 -->
                                        <td>
                                            <b>Report Date :</b> <em>*</em>
                                            @Html.TextBoxFor(m => m.ReportDate,"{0:yyyy-MM-dd}", new {
                                            @class = "form-control d-inline-block",style = "width:60%; font-size:13px;",
                                                                                        placeholder = "dd-mm-yyyy",title = "Enter date as dd-mm-yyyy",
                                                                                        required = "required",type = "date"})
                                        </td>


                                        <td>
                                            <b>Report No. :</b> <em>*</em>
                                            @Html.TextBoxFor(m => m.ReportNo, new {
                                                                                        @class = "form-control d-inline-block",style = "width:60%; font-size:13px;",
                                                                                        placeholder = "Enter Report No", required = "required",type = "text"})
                                        </td>

                                        <td>
                                            <b>Batch Code :</b> <em>*</em>
                                            @Html.TextBoxFor(m=>m.BatchCode , new{
                                                                                        @class = "form-control d-inline-block",style = "width:60%; font-size:13px;",placeholder = "Enter Batch Code",
                                                                                        required = "required" , type = "text"})
                                        </td>
                                    </tr>

                                    <tr>
                                        <!-- Row 2 -->
                                        <td style="width:20px;">
                                            <div style="display:flex; align-items:center; gap:10px;">
                                                <b style="width:105px;">Product Cat Ref :</b> <em>*</em>
                                                <input type="text"
                                                       name="prodCode_Search"
                                                       id="prodCode_Search"
                                                       class="form-control"
                                                       placeholder="Search Code"
                                                       oninput="handleProdCodeSearch(this)"
                                                       style="width:170px; text-transform:uppercase; font-size:13px;" />

                                                @Html.TextBoxFor(m => m.ProductCatRef, new {
                                                                                                @class = "form-control",
                                                                                                style = "width:320px; font-size:13px;",
                                                                                                placeholder = "Enter Product Ref",
                                                                                                required = "required",
                                                                                                type = "text"
                                                                                                })
                                            </div>
                                        </td>

                                        <td>
                                            <b>Product Description :</b> <em>*</em>
                                            @Html.TextBoxFor(m => m.ProductDescription, new {
                                                                                        @class = "form-control d-inline-block",
                                                                                        style = "width:60%; font-size:13px;",
                                                                                        required = "required"
                                                                                        })
                                        </td>

                                        <td>
                                            <b>Driver Code :</b> <em>*</em>
                                            @Html.TextBoxFor(m => m.DriverCode, new {
                                                                                        @class = "form-control d-inline-block",
                                                                                        style = "width:60%; font-size:13px;",
                                                                                        required = "required"
                                                                                        })
                                        </td>
                                    </tr>

                                    <tr>
                                        <!-- Row 3 -->
                                        <td>
                                            <b>SPD Code :</b> <em>*</em>
                                            @Html.TextBoxFor(m=>m.SPDCode , new
                                                                                        {
                                                @class = "form-control d-inline-block",style = "width:60%; font-size:13px;",placeholder = "Enter SPD Code",
                                                                                        required = "required" , type = "text"
                                                                                        })
                                        </td>

                                        <td>
                                            <b>LED Configuration :</b> <em>*</em>
                                            @Html.TextBoxFor(m=>m.LEDConfiguration , new
                                                                                        {
                                                @class = "form-control d-inline-block",style = "width:60%; font-size:13px;",placeholder = "Enter LED Configuration",
                                                                                        required = "required" , type = "text"
                                                                                        })
                                        </td>

                                        <td>
                                            <b>PKD Code :</b> <em>*</em>
                                            @Html.TextBoxFor(m=>m.PKDCode , new
                                                                                        {
                                                @class = "form-control d-inline-block",style = "width:60%; font-size:13px;",placeholder = "Enter PKD Code",
                                                                                        required = "required" , type = "text"
                                                                                        })
                                        </td>
                                    </tr>


                                    <tr class="no-divider">
                                        <td colspan="3">
                                            <b>Reference Standard for Testing :</b>
                                            @Html.TextBoxFor(m=>m.ReferenceStandard , new
                                                                                        {
                                                @class = "form-control d-inline-block",style = "width:50%; font-size:13px;",placeholder = "Enter Standard (e.g. IEC 61000)",
                                                                                        required = "required" , type = "text"
                                                                                        })
                                        </td>
                                    </tr>

                                    <tr class="no-divider-next">
                                        <td colspan="3">
                                            <b>Acceptance Norm :</b>
                                            @Html.TextBoxFor(m=>m.AcceptanceNorm , new
                                                                                        {
                                                @class = "form-control d-inline-block",style = "width:50%; font-size:13px;",placeholder = "Enter Norm (e.g. As per TDS)",
                                                                                        required = "required" , type = "text"
                                                                                        })
                                        </td>
                                    </tr>

                                </tbody>
                            </table>

                            <hr style="border:1px solid #000; margin:30px 0;" />

                            <!-- Surge Driver without SPD -->
                            <h5 class="text-center mb-3 mt-4" style="font-weight:bold; text-decoration:underline;">Surge Driver without SPD</h5>
                            <table class="table-surge">
                                <colgroup>
                                    <col span="15" />
                                </colgroup>

                                <thead>
                                    <!-- 🔹 First Header Row -->
                                    <tr>
                                        <th colspan="7" style="text-align:left; padding-left:8px;">
                                            <span class="hdr-title">Time between each surge –</span>
                                            <span class="hdr-value" style="font-weight:600; margin-left:6px;">60 Sec</span>
                                        </th>
                                        <th colspan="7" style="text-align:left; padding-left:8px;">
                                            <span class="hdr-title">No of Cycles –</span>
                                            <span class="hdr-value" style="font-weight:600; margin-left:6px;">5</span>
                                        </th>
                                        <th style="text-align:center;">Observation</th>
                                    </tr>

                                    <!-- 🔹 Second Header Row -->
                                    <tr>
                                        <th rowspan="2">Voltage (kV)</th>
                                        <th>Mode</th>
                                        <th colspan="4">Line - Neutral (L-N) DM</th>
                                        <th colspan="4">Line - Earth (L-E) CM</th>
                                        <th colspan="4">Neutral - Earth (N-E) CM</th>
                                        <th rowspan="2"></th>
                                    </tr>

                                    <!-- 🔹 Third Header Row -->
                                    <tr>
                                        <th>Phase Angle</th>
                                        <th>±90°</th>
                                        <th>±180°</th>
                                        <th>±270°</th>
                                        <th>±0°</th>

                                        <th>±90°</th>
                                        <th>±180°</th>
                                        <th>±270°</th>
                                        <th>±0°</th>

                                        <th>±90°</th>
                                        <th>±180°</th>
                                        <th>±270°</th>
                                        <th>±0°</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    @for (int i = 0; i < 6; i++)
                                    {
                                        var detail = Model.DetailRows[i];

                                        <tr>
                                            <td contenteditable="true" data-name="Voltage_KV" data-index="@i">@detail.Voltage_KV</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].Voltage_KV)

                                            <td contenteditable="true" data-name="Mode" data-index="@i">@detail.Mode</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].Mode)

                                            <td contenteditable="true" data-name="L_N_DM_90" data-index="@i">@detail.L_N_DM_90</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_N_DM_90)

                                            <td contenteditable="true" data-name="L_N_DM_180" data-index="@i">@detail.L_N_DM_180</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_N_DM_180)

                                            <td contenteditable="true" data-name="L_N_DM_270" data-index="@i">@detail.L_N_DM_270</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_N_DM_270)

                                            <td contenteditable="true" data-name="L_N_DM_0" data-index="@i">@detail.L_N_DM_0</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_N_DM_0)

                                            <td contenteditable="true" data-name="L_E_CM_90" data-index="@i">@detail.L_E_CM_90</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_E_CM_90)

                                            <td contenteditable="true" data-name="L_E_CM_180" data-index="@i">@detail.L_E_CM_180</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_E_CM_180)

                                            <td contenteditable="true" data-name="L_E_CM_270" data-index="@i">@detail.L_E_CM_270</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_E_CM_270)

                                            <td contenteditable="true" data-name="L_E_CM_0" data-index="@i">@detail.L_E_CM_0</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].L_E_CM_0)

                                            <td contenteditable="true" data-name="N_E_CM_90" data-index="@i">@detail.N_E_CM_90</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].N_E_CM_90)

                                            <td contenteditable="true" data-name="N_E_CM_180" data-index="@i">@detail.N_E_CM_180</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].N_E_CM_180)

                                            <td contenteditable="true" data-name="N_E_CM_270" data-index="@i">@detail.N_E_CM_270</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].N_E_CM_270)

                                            <td contenteditable="true" data-name="N_E_CM_0" data-index="@i">@detail.N_E_CM_0</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].N_E_CM_0)

                                            <td contenteditable="true" data-name="Observation" data-index="@i">@detail.Observation</td>
                                            @Html.HiddenFor(m => m.DetailRows[i].Observation)

                                            @Html.HiddenFor(m => m.DetailRows[i].RowNo)
                                            @Html.HiddenFor(m => m.DetailRows[i].TestType)
                                            @Html.HiddenFor(m => m.DetailRows[i].IsResult) <!-- FIX -->
                                        </tr>
                                    }
                                    @{
                                        int b = 6;
                                    }

                                    <tr style="font-weight:bold; font-size:15px;">
                                        <td colspan="5">
                                            <label style="color:red;">Result:</label>
                                            @Html.DropDownListFor(m => m.DetailRows[b].PassFail,
                                            new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" }
                                                                                        }, new { @class = "clean-select" })
                                        </td>

                                        <td colspan="5">
                                            <label style="color:red;">SPD:</label>
                                            @Html.DropDownListFor(m => m.DetailRows[b].SPD_OK,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="OK", Value="OK" },
                                                                                        new SelectListItem { Text="Not OK", Value="Not OK" }
                                                                                        }, new { @class = "clean-select" })
                                        </td>

                                        <td colspan="5">
                                            <label style="color:red;">Driver / LED PCB:</label>
                                            @Html.DropDownListFor(m => m.DetailRows[b].Driver_LED_PCB_OK,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="OK", Value="OK" },
                                                                                        new SelectListItem { Text="Not OK", Value="Not OK" }
                                                                                        }, new { @class = "clean-select" })
                                        </td>

                                        @Html.HiddenFor(m => m.DetailRows[b].RowNo)
                                        @Html.HiddenFor(m => m.DetailRows[b].TestType)
                                        @Html.HiddenFor(m => m.DetailRows[b].IsResult) <!-- FIX -->
                                    </tr>
                                </tbody>
                            </table>

                            <hr style="border:1px solid #000; margin:30px 0;" />

                            <!-- Surge with SPD -->
                            <h5 class="text-center mb-3" style="font-weight:bold; text-decoration:underline;">Surge with SPD</h5>

                            <table class="table-surge">
                                <colgroup>
                                    <col span="15" />
                                </colgroup>

                                <thead>
                                    <!-- 🔹 First Header Row -->
                                    <tr>
                                        <th colspan="7" style="text-align:left; padding-left:8px;">
                                            <span class="hdr-title">Time between each surge –</span>
                                            <span class="hdr-value" style="font-weight:600; margin-left:6px;">60 Sec</span>
                                        </th>
                                        <th colspan="7" style="text-align:left; padding-left:8px;">
                                            <span class="hdr-title">No of Cycles –</span>
                                            <span class="hdr-value" style="font-weight:600; margin-left:6px;">5</span>
                                        </th>
                                        <th style="text-align:center;">Observation</th>
                                    </tr>

                                    <!-- 🔹 Second Header Row -->
                                    <tr>
                                        <th rowspan="2">Voltage (kV)</th>
                                        <th>Mode</th>
                                        <th colspan="4">Line - Neutral (L-N) DM</th>
                                        <th colspan="4">Line - Earth (L-E) CM</th>
                                        <th colspan="4">Neutral - Earth (N-E) CM</th>
                                        <th rowspan="2"></th>
                                    </tr>

                                    <!-- 🔹 Third Header Row -->
                                    <tr>
                                        <th>Phase Angle</th>
                                        <th>±90°</th>
                                        <th>±180°</th>
                                        <th>±270°</th>
                                        <th>±0°</th>

                                        <th>±90°</th>
                                        <th>±180°</th>
                                        <th>±270°</th>
                                        <th>±0°</th>

                                        <th>±90°</th>
                                        <th>±180°</th>
                                        <th>±270°</th>
                                        <th>±0°</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int j = 7; j < 13; j++)
                                    {
                                        var row = Model.DetailRows[j];

                                        <tr>
                                            <td contenteditable="true" data-name="Voltage_KV" data-index="@j">@row.Voltage_KV</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].Voltage_KV)

                                            <td contenteditable="true" data-name="Mode" data-index="@j">@row.Mode</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].Mode)

                                            <td contenteditable="true" data-name="L_N_DM_90" data-index="@j">@row.L_N_DM_90</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_N_DM_90)

                                            <td contenteditable="true" data-name="L_N_DM_180" data-index="@j">@row.L_N_DM_180</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_N_DM_180)

                                            <td contenteditable="true" data-name="L_N_DM_270" data-index="@j">@row.L_N_DM_270</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_N_DM_270)

                                            <td contenteditable="true" data-name="L_N_DM_0" data-index="@j">@row.L_N_DM_0</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_N_DM_0)

                                            <td contenteditable="true" data-name="L_E_CM_90" data-index="@j">@row.L_E_CM_90</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_E_CM_90)

                                            <td contenteditable="true" data-name="L_E_CM_180" data-index="@j">@row.L_E_CM_180</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_E_CM_180)

                                            <td contenteditable="true" data-name="L_E_CM_270" data-index="@j">@row.L_E_CM_270</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_E_CM_270)

                                            <td contenteditable="true" data-name="L_E_CM_0" data-index="@j">@row.L_E_CM_0</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].L_E_CM_0)

                                            <td contenteditable="true" data-name="N_E_CM_90" data-index="@j">@row.N_E_CM_90</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].N_E_CM_90)

                                            <td contenteditable="true" data-name="N_E_CM_180" data-index="@j">@row.N_E_CM_180</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].N_E_CM_180)

                                            <td contenteditable="true" data-name="N_E_CM_270" data-index="@j">@row.N_E_CM_270</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].N_E_CM_270)

                                            <td contenteditable="true" data-name="N_E_CM_0" data-index="@j">@row.N_E_CM_0</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].N_E_CM_0)

                                            <td contenteditable="true" data-name="Observation" data-index="@j">@row.Observation</td>
                                            @Html.HiddenFor(m => m.DetailRows[j].Observation)

                                            @Html.HiddenFor(m => m.DetailRows[j].RowNo)
                                            @Html.HiddenFor(m => m.DetailRows[j].TestType)
                                            @Html.HiddenFor(m => m.DetailRows[j].IsResult) <!-- FIX -->
                                        </tr>
                                    }

                                    @{
                                        int k = 13;
                                    }

                                    <tr style="font-weight:bold; font-size:15px;">
                                        <td colspan="5">
                                            <label style="color:red;">Result:</label>
                                            @Html.DropDownListFor(m => m.DetailRows[k].PassFail,
                                            new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="Pass", Value="Pass" },
                                                                                        new SelectListItem { Text="Fail", Value="Fail" }
                                                                                        },
                                                                                        new { @class = "clean-select" })
                                        </td>

                                        <td colspan="5">
                                            <label style="color:red;">SPD:</label>
                                            @Html.DropDownListFor(m => m.DetailRows[k].SPD_OK,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="OK", Value="OK" },
                                                                                        new SelectListItem { Text="Not OK", Value="Not OK" }
                                                                                        },
                                                                                        new { @class = "clean-select" })
                                        </td>

                                        <td colspan="5">
                                            <label style="color:red;">Driver / LED PCB:</label>
                                            @Html.DropDownListFor(m => m.DetailRows[k].Driver_LED_PCB_OK,
                                                                                        new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem { Text="Select", Value="" },
                                                                                        new SelectListItem { Text="OK", Value="OK" },
                                                                                        new SelectListItem { Text="Not OK", Value="Not OK" }
                                                                                        },
                                                                                        new { @class = "clean-select" })
                                        </td>

                                        @Html.HiddenFor(m => m.DetailRows[k].RowNo)
                                        @Html.HiddenFor(m => m.DetailRows[k].TestType)
                                        @Html.HiddenFor(m => m.DetailRows[k].IsResult) <!-- FIX -->
                                    </tr>
                                </tbody>
                            </table>

                            <hr style="border:1px solid #000; margin:30px 0;" />

                            <!-- Photo + Verification -->
                            <table class="table table-bordered" style="width:100%;">
                                <tr style="height:150px;">
                                    <td colspan="2" class="text-center align-middle" style="font-weight:bold;">
                                        <label for="photoUpload"
                                               style="display:block; color:#000; font-weight:bold; margin-bottom:10px;">
                                            Space for Photo :
                                        </label>

                                        <div style="display:flex; justify-content:center; align-items:center;">
                                            @Html.HiddenFor(m => m.Surge_Photo)
                                            <span class="photo-text"></span>
                                            <input type="file" id="photoUpload1" accept="image/*" name="Photo_SurgeFile" style="" />
                                            <img id="preview1" alt="" src="@Model?.Surge_Photo"
                                                 @(string.IsNullOrEmpty(Model?.Surge_Photo) ? "display:none;" : "display:block;")
                                                 style="width:15%; height:15%;border:1px solid #aaa; border-radius:5px;">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="width:50%; font-weight:bold;">
                                        Checked By:&nbsp;
                                        @Html.TextBoxFor(m => m.CheckedBy, new {
                                                                                @class = "form-control d-inline-block",style = "width:70%; font-weight:normal;",
                                                                                placeholder = "Enter name", type = "text"})
                                    </td>

                                    <td style="width:50%; font-weight:bold;">
                                        Verified By:&nbsp;
                                        @Html.TextBoxFor(m => m.VerifiedBy, new {
                                                                                @class = "form-control d-inline-block",style = "width:70%; font-weight:normal;",
                                                                                placeholder = "Enter name", type = "text"})
                                    </td>
                                </tr>
                            </table>

                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>

    <script>
         let searchTimeout;

         $(document).ready(function () {
             initPhotoPreviews();

            const inputElement = $("#prodCode_Search");
            if (inputElement.length) {

                 inputElement.on('input', function (event) {
                 handleProdCodeSearch(event);
                });
            }
         });

          function handleProdCodeSearch(event) {

             const input = event.target;
             if (!input) return;

             let searchQuery = input.value.trim();

             if (searchQuery.length < 4) {
                 clearTimeout(searchTimeout);
                 return;
             }

             const searchTerms = searchQuery.substring(0, 4);

             clearTimeout(searchTimeout);
             searchTimeout = setTimeout(() => {
                 pagedData = {};
                 fetchProdCodeRelatedData(searchTerms, input);
             }, 300);
         }

          function fetchProdCodeRelatedData(productCatNo, inputField) {
                 debugger
                 $.ajax({
                     url: '/Vendor/GetCodeSearch',
                     type: 'GET',
                     data: { search: productCatNo },
                     dataType: 'json',
                     success: function (data) {
                         if (data && data.length > 0) {
                             displayProdCodeSuggestions(data, inputField);
                         } else {
                             showDangerAlert('No data found for the entered Product Cat No.');
                         }
                     },
                     error: function (xhr, status, error) {
                         console.error('Error fetching data:', error);
                     }
                 });
             }

          function displayProdCodeSuggestions(data, inputField) {

                     removeExistingDropdown(inputField);

                     const parent = inputField.parentElement;
                     if (getComputedStyle(parent).position === "static") {
                         parent.style.position = "relative";
                     }

                     const dropdown = document.createElement('div');
                     dropdown.className = 'suggestion-dropdown';
                     dropdown.style.position = 'absolute';
                     dropdown.style.top = (inputField.offsetTop + inputField.offsetHeight) + 'px';
                     dropdown.style.left = inputField.offsetLeft + 'px';
                     dropdown.style.backgroundColor = 'white';
                     dropdown.style.border = '1px solid #ccc';
                     dropdown.style.zIndex = 1000;
                     dropdown.style.overflowY = 'auto';
                     dropdown.style.maxHeight = '300px';
                     dropdown.style.width = inputField.offsetWidth + 'px';
                     dropdown.style.boxShadow = '0px 4px 6px rgba(0, 0, 0, 0.1)';

                     data.forEach(item => {
                         const code = (item.oldPart_No || "").toString().trim();
                         const desc = (item.description || item.prodDesc || item.prod_Desc || "").toString().trim();

                         const option = document.createElement('div');
                         option.className = 'suggestion-item';
                         option.textContent = desc ? `${code} | ${desc}` : code;
                         option.style.padding = '8px';
                         option.style.cursor = 'pointer';

                         option.addEventListener('mouseover', () => {
                             option.style.backgroundColor = '#4682B4';
                             option.style.color = '#fff';
                         });
                         option.addEventListener('mouseout', () => {
                             option.style.backgroundColor = '';
                             option.style.color = '';
                         });

                         option.addEventListener('click', () => {

                             const productCatRefInput = document.getElementById('ProductCatRef');
                             if (productCatRefInput) {
                                 productCatRefInput.value = code ?? '';
                             }

                             const productDescInput = document.getElementById('ProductDescription');
                             if (productDescInput) {
                                 productDescInput.value = desc ?? '';
                             }

                             const searchBox = document.getElementById('prodCode_Search');
                             if (searchBox) {
                                 searchBox.value = code;
                             }

                             dropdown.remove();
                         });

                         dropdown.appendChild(option);
                     });

                     parent.appendChild(dropdown);
                 }

          function removeExistingDropdown(inputField) {
                 const existingDropdown = document.querySelector('.suggestion-dropdown');
                 if (existingDropdown) {
                     existingDropdown.remove();
                 }
             }

          document.addEventListener('click', function (e) {
                 if (!e.target.closest('.suggestion-dropdown') && !e.target.closest('#prodCode_Search')) {
                     removeExistingDropdown();
                 }
             });

        function setupPreview(inputId, imgId) {
             const inp = document.getElementById(inputId);
             const img = document.getElementById(imgId);

             if (!inp || !img) return;

             inp.addEventListener('change', () => {
                 const file = inp.files && inp.files[0];

                 if (!file) {
                     img.src = '';
                     img.style.display = 'none';
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = e => {
                     img.src = e.target.result;
                     img.style.display = 'block';
                 };

                 reader.readAsDataURL(file);
             });
         }

         function initPhotoPreviews() {
             setupPreview('photoUpload1', 'preview1');
         }

         function insertSurgeTest() {

         Blockloadershow();

             $('td[contenteditable="true"]').each(function () {
             var value = $(this).text().trim();
             var fieldName = $(this).data('name'); // e.g. Voltage_KV

             if (fieldName !== undefined) {
                 // Find the closest hidden input for the same field
                 var hiddenInput = $(this).closest('tr').find('input[name$=".' + fieldName + '"]');

                 if (hiddenInput.length > 0) {
                     hiddenInput.val(value);
                 }
             }
         });

                     const requiredFields = [
                         { name: 'ReportDate', label: 'Report Date' },
                         { name: 'ReportNo', label: 'Report No' },
                         { name: 'BatchCode', label: 'Batch Code' },
                         { name: 'ProductCatRef', label: 'Product Cat Ref' },
                         { name: 'ProductDescription', label: 'Product Description' },
                         { name: 'DriverCode', label: 'Driver Code' },
                         { name: 'SPDCode', label: 'SPD Code' },
                         { name: 'LEDConfiguration', label: 'LED Configuration' },
                         { name: 'PKDCode', label: 'PKD Code' }

                     ];

                     let isValid = true;
                     let missingFields = [];

                     requiredFields.forEach(field => {
                        const value = $(`[name="${field.name}"]`).val();

                         if (!value || value.trim() === '') {
                             isValid = false;
                             missingFields.push(field.name);
                         }
                     });

                     if (!isValid) {
                         const missingFieldsList = missingFields.map(field => `<li>${field}</li>`).join('');
                         const alertMessage = `
                                 <p>Please fill out the following required field(s):</p>
                                 <ul>${missingFieldsList}</ul>
                             `;
                         showDangerAlert(alertMessage);
                         Blockloaderhide();
                         return false;
                     }
                     $("#Id").val(@Model.Id);
                    const form = $('#surgeTest-form')[0];
                     const formData = new FormData(form);

                     // $('#surgeTest-form [contenteditable="true"]').each(function () {

                     //     const dataName = $(this).data('name');
                     //     const content = $(this).text().trim();

                     //     if (dataName) {
                     //         formData.append(dataName, content);
                     //     }

                     // });

                     $.ajax({
                         url: $('#surgeTest-form').attr('action'),
                         type: 'POST',
                         data: formData,
                         processData: false,
                         contentType: false,
                         success: function (response) {
                             Blockloaderhide();

                             if (!response.success) {
                                  var errorMessg = "";
                     if (response.errors != undefined) {
                         for (var error of response.errors) {
                             errorMessg += error + "\n";
                         }
                         if (errorMessg != "") {
                             showDangerAlert(errorMessg);
                         }
                     }
                     else {
                         showDangerAlert(response.message);
                     }
                     return false;
                 }

                 else {
                     if ($("#Id").val() > 0) {
                         showSuccessAlert("Updated Successfully.");
                     }
                     else {
                         showSuccessAlert("Saved Successfully.");
                     }
                     setTimeout(function () {
                         window.open('@Url.Action("SurgeTestReport", "ProductValidation")', '_self');
                     }, 2500);
                 }

                   },
                         error: function (xhr, status, error) {
                             Blockloaderhide();
                             showDangerAlert("Error saving data: " + error);
                         }
                     });
                 }


    </script>
}

@section HideSidebar { }
