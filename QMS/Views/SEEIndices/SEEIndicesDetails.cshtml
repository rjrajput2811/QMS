@model QMS.Core.Models.SixSigmaIndicesViewModel
@{
    ViewData["Title"] = "Six Sigma Indices Report";
}

<style>
    .nav-tabs {
        border-bottom: 1px solid #e0e0e0;
        padding-left: 12px;
    }

    /* parent row → remove bottom border for merged columns */
    .tabulator-row.merge-parent .tabulator-cell.tabulator-field-target,
    .tabulator-row.merge-parent .tabulator-cell.tabulator-field-weightage,
    .tabulator-row.merge-parent .tabulator-cell.tabulator-field-formula,
    .tabulator-row.merge-parent .tabulator-cell.tabulator-field-score {
        border-bottom-color: transparent !important;
    }

    /* child row → remove top border (and hide any text) for merged columns */
    .tabulator-row.merge-child .tabulator-cell.tabulator-field-target,
    .tabulator-row.merge-child .tabulator-cell.tabulator-field-weightage,
    .tabulator-row.merge-child .tabulator-cell.tabulator-field-formula,
    .tabulator-row.merge-child .tabulator-cell.tabulator-field-score {
        border-top-color: transparent !important;
        color: transparent;
    }

    .nav-tabs .nav-link {
        border: none;
        border-radius: 0;
        margin-right: 6px;
        margin-bottom: -2px;
        color: #333;
        background: transparent;
        font-weight: 500;
        font-size: 14px;
        padding: 8px 20px;
        transition: color .2s ease-in-out;
    }

        .nav-tabs .nav-link:hover {
            color: #000;
        }

        .nav-tabs .nav-link.active {
            color: #000 !important;
            font-weight: 700 !important;
            background: #fff;
            border: 3px solid #0c83ff;
            border-bottom-color: #fff;
            border-radius: 8px 8px 0 0;
            font-size: 15px !important;
        }

    .header-select {
        appearance: none;
        width: 160px;
        padding: 10px 32px 10px 12px;
        font-size: 15px;
        background: #fff;
        border: none;
        outline: none;
        text-align-last: center;
        border-bottom: 2px solid transparent;
        border-radius: 0 0 10px 10px;
        box-shadow: inset 0 -2px 0 #d5dce5, 0 2px 4px rgba(0,0,0,0.05);
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 20 20'><path fill='black' d='M5 7l5 5 5-5'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 14px;
        cursor: pointer;
    }

        .header-select:focus {
            box-shadow: inset 0 -2px 0 #4682B4, 0 2px 6px rgba(70,130,180,0.15);
        }

    .header-input {
        width: 180px;
        padding: 2px 4px;
        font-size: 15px;
        border: none;
        border-bottom: 1.5px solid #999;
        background: transparent;
        outline: none;
        transition: border-color .2s ease-in-out;
    }

        .header-input:focus {
            border-bottom: 1.5px solid #4682B4;
        }

    .tabulator {
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        border: 1px solid #000;
        border-collapse: collapse;
    }

        .tabulator .tabulator-header {
            color: #000;
            font-weight: bold;
            border-bottom: 1px solid #000;
        }

        .tabulator .tabulator-cell {
            border-right: 1px solid #000;
            border-bottom: 1px solid #000;
            padding: 6px 8px;
            white-space: normal !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
            line-height: 1.4em;
            background: #ffffff !important;
        }

    .tabulator-row {
        background-color: #ffffff !important;
    }

    .tabulator-group {
        background-color: #ffffff !important;
        font-weight: bold;
        color: #000;
        border-top: 1px solid #000;
        border-bottom: 1px solid #000;
        padding: 6px;
        text-align: center !important;
    }

        .tabulator-group .tabulator-group-toggle {
            display: none !important;
            pointer-events: none !important;
        }

    .card {
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .card-body {
        padding: 1rem 1.5rem;
    }

    #sixSigmaTableEffectiveness .tabulator-header,
    #sixSigmaTableEngagement .tabulator-header {
        font-weight: bold;
    }

    .sixsig-summary-row .tabulator-cell {
        font-weight: bold;
        border-top: 2px solid #000;
    }
</style>

<div class="card">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <b style="font-size: large; color: #4682B4;">
                Six Sigma Indices Report - Segment
            </b>
        </div>

        <div>
            <button id="saveButton" type="button" class="btn btn-outline-success mr-2"
                    style="width: 120px; font-size:15px">
                <i class="fas fa-save mr-2"></i>SAVE
            </button>

            <button id="backButton" class="btn btn-outline-primary"
                    onclick="location.href='@Url.Action("SEEIndices", "SEEIndices")'"
                    style="width: 120px; font-size:15px">
                <i class="fas fa-arrow-left"></i> BACK
            </button>
        </div>
    </div>
</div>

@Html.HiddenFor(m => m.Id)
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">

                <!-- FILTER HEADER (INSIDE SAME CARD) -->
                <div class="d-flex align-items-center mb-3"
                     style="gap: 30px; padding-bottom:12px; border-bottom:1px solid #ddd;">

                    <div>
                        <label style="font-weight:600; margin-right:5px;">
                            FY: <span style="color:red;">*</span>
                        </label>
                        @Html.DropDownListFor(
                                 m => m.Fy,
                                 new SelectList(new[]
                                 {
                        new { Value = "", Text = "Select" },
                        new { Value = "2023-24", Text = "2023-24" },
                        new { Value = "2024-25", Text = "2024-25" },
                        new { Value = "2025-26", Text = "2025-26" }
                        }, "Value", "Text", Model.Fy),
                                 new { @class = "header-select", @style = "width:160px;" }
                                 )
                    </div>

                    <div>
                        <label style="font-weight:600; margin-right:5px;">
                            PC: <span style="color:red;">*</span>
                        </label>
                        @Html.TextBoxFor(
                                 m => m.Pc,
                                 new { @class = "header-input", placeholder = "Enter PC", @style = "width:150px;" }
                                 )
                    </div>

                    <div>
                        <label style="font-weight:600; margin-right:5px;">
                            Location: <span style="color:red;">*</span>
                        </label>
                        @Html.TextBoxFor(
                                 m => m.Location,
                                 new { @class = "header-input", placeholder = "Enter Location", @style = "width:150px;" }
                                 )
                    </div>

                </div>

                <!-- TABS + TABLES INSIDE SAME CARD -->
                <ul class="nav nav-tabs custom-tabs" id="sixSigmaTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab-seg1" data-toggle="tab" href="#Engagement" role="tab">
                            Engagement
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" id="tab-seg2" data-toggle="tab" href="#Effectiveness" role="tab">
                            Effectiveness
                        </a>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="sixSigmaTabsContent">
                    <div class="tab-pane fade show active"
                         id="Engagement"
                         role="tabpanel"
                         aria-labelledby="tab-seg1">
                        <div id="sixSigmaTableEngagement"></div>
                    </div>

                    <div class="tab-pane fade"
                         id="Effectiveness"
                         role="tabpanel"
                         aria-labelledby="tab-seg2">
                        <div id="sixSigmaTableEffectiveness"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="~/js/tabulator.min.js"></script>
<link href="~/css/tabulator/tabulator.min.css" rel="stylesheet" />

<script>
    let effectivenessTable;
    let engagementTable;

    function loadSixSigmaGrid() {

        if (typeof Tabulator === "undefined") {
            alert("Tabulator failed to load. Check JS file path.");
            throw new Error("Tabulator not loaded");
        }

        // =================== UTILITY FUNCTIONS ===================

        function safeValue(val) {
            if (val === null || val === undefined) return "";
            if (typeof val === "string") {
                const v = val.trim();
                if (v === "" || v.toLowerCase() === "null") return "";
                return v;
            }
            return val;
        }

        function editableWhenOddId(cell) {
            const rowData = cell.getRow().getData();
            const id = Number(rowData.id);
            if (isNaN(id)) return false;
            return id % 2 !== 0;
        }

        function toNum(v) {
            if (v === null || v === undefined) return NaN;
            if (typeof v === "string") v = v.trim();
            if (v === "" || v === "null") return NaN;
            v = String(v).replace(/,/g, "");
            const n = parseFloat(v);
            return Number.isFinite(n) ? n : NaN;
        }

        function clamp(v, lo, hi) {
            return Math.max(lo, Math.min(hi, v));
        }

        function getModelValue(val) {
            if (val === null || val === undefined || val === "null" || val === "") {
                return "";
            }
            return val;
        }

        // =================== EXCEL FORMULA EVALUATOR ===================

        function sanitizeFormula(formula) {
            const allowedPattern = /^[CDEcde0-9\s+\-*/().,<>=!&|]+$/;
            const cleaned = formula.replace(/\b(IF|AND|OR|MIN|MAX|if|and|or|min|max)\b/g, '');

            if (!allowedPattern.test(cleaned)) {
                throw new Error("Formula contains disallowed characters");
            }

            return formula;
        }

        function evaluateExcelFormula(formula, C, D, E) {
            if (!formula || formula.trim() === "" || formula === "null") {
                return null; // Return null to trigger fallback
            }

            try {
                let normalized = formula
                    .replace(/C\d+/gi, 'C')
                    .replace(/D\d+/gi, 'D')
                    .replace(/E\d+/gi, 'E');

                normalized = sanitizeFormula(normalized);

                // Handle Excel comparison operators
                normalized = normalized.replace(/<>/g, '!=');
                normalized = normalized.replace(/([^<>!])=/g, '$1==');
                normalized = normalized.replace(/===/g, '==');

                const safeEval = new Function(
                    'C', 'D', 'E',
                    'IF', 'AND', 'OR', 'MIN', 'MAX',
                    `
                    "use strict";
                    try {
                        return (${normalized});
                    } catch (e) {
                        throw new Error("Formula execution failed: " + e.message);
                    }
                    `
                );

                const IF = (condition, valueIfTrue, valueIfFalse) => {
                    return condition ? valueIfTrue : valueIfFalse;
                };

                const AND = (...args) => {
                    return args.every(arg => arg === true || arg === 1);
                };

                const OR = (...args) => {
                    return args.some(arg => arg === true || arg === 1);
                };

                const MIN = (...args) => {
                    return Math.min(...args);
                };

                const MAX = (...args) => {
                    return Math.max(...args);
                };

                const result = safeEval(C, D, E, IF, AND, OR, MIN, MAX);

                if (typeof result === 'number' && Number.isFinite(result)) {
                    return Math.round(result * 100) / 100;
                }

                return result;

            } catch (error) {
                console.error("Formula evaluation error:", error.message, "| Formula:", formula);
                return null; // Return null to trigger fallback
            }
        }

        // =================== WEIGHTED SCORE CALCULATION ===================

        function calcWeightedScore(rowData) {
            // Summary row - don't calculate here
            if (rowData.score_formula === "Total Weighted Score") {
                return rowData.score || "";
            }

            const id = Number(rowData.id);

            // Only calculate for parent rows (odd IDs)
            if (!Number.isFinite(id) || id % 2 === 0) {
                return ""; // Child rows always empty
            }

            const C = toNum(rowData.data);      // Data for PC
            const D = toNum(rowData.target);    // Target
            const E = toNum(rowData.weightage); // Weightage

            // Validate inputs
            if (!Number.isFinite(C) || !Number.isFinite(D) || !Number.isFinite(E)) {
                return "";
            }

            // Avoid division by zero
            if (D === 0) {
                return "";
            }

            // CHANGED: Try to use formula, but always fallback if null/empty/invalid
            let result = null;

            if (rowData.score_formula && rowData.score_formula.trim() !== "" && rowData.score_formula !== "null") {
                result = evaluateExcelFormula(rowData.score_formula, C, D, E);
            }

            // If formula evaluation failed or returned null, use fallback
            if (result === null || result === "" || !Number.isFinite(result)) {
                // Fallback: MIN(MAX((C/D)*E, 0), E)
                const raw = (C / D) * E;
                const score = clamp(raw, 0, E);
                return Math.round(score * 100) / 100;
            }

            return result;
        }

        function recalcTableScores(table) {
            if (!table) return;

            let total = 0;
            let hasCalculation = false;

            table.getRows().forEach(r => {
                const d = r.getData();

                // Skip summary row
                if (d.formula === "Total Weighted Score") {
                    return;
                }

                // Calculate for all parent rows (odd id), regardless of formula presence
                const id = Number(d.id);
                if (!Number.isFinite(id) || id % 2 === 0) {
                    return; // Skip child rows
                }

                const newScore = calcWeightedScore(d);

                // Update row if score changed
                if (d.score !== newScore) {
                    r.update({ score: newScore }, true);
                }

                // Add to total if valid number
                const n = toNum(newScore);
                if (Number.isFinite(n)) {
                    total += n;
                    hasCalculation = true;
                }
            });

            // Update Total Weighted Score row
            const totalRow = table.getRows().find(r => r.getData().formula === "Total Weighted Score");
            if (totalRow) {
                const roundedTotal = hasCalculation ? Math.round(total * 100) / 100 : "";
                totalRow.update({ score: roundedTotal }, true);
            }
        }

        // =================== ROW FORMATTER ===================

        function mergeRowFormatter(row) {
            const data = row.getData();

            if (data.mergeWithPrev) {
                const prevRow = row.getPrevRow();
                if (!prevRow) return;

                const mergeFields = ["SrNo", "target", "weightage", "formula", "score"];
                mergeFields.forEach(field => {
                    const childCell = row.getCell(field);
                    if (childCell) {
                        const el = childCell.getElement();
                        el.style.borderTop = "none";
                        el.innerHTML = "";
                    }

                    const parentCell = prevRow.getCell(field);
                    if (parentCell) {
                        const elp = parentCell.getElement();
                        elp.style.borderBottom = "none";
                    }
                });
            }

            if (data.formula === "Total Weighted Score") {
                ["target", "weightage"].forEach(field => {
                    const cell = row.getCell(field);
                    if (cell) {
                        const el = cell.getElement();
                        el.innerHTML = "";
                        el.style.borderLeft = "none";
                        el.style.borderRight = "none";
                    }
                });

                const formulaCell = row.getCell("formula");
                if (formulaCell) {
                    const el = formulaCell.getElement();
                    el.style.textAlign = "center";
                    el.style.fontWeight = "bold";
                }
            }
        }

        // =================== CUSTOM EDITOR ===================

        function numericOnlyEditor(cell, onRendered, success, cancel) {
            var input = document.createElement("input");
            input.type = "text";
            input.value = cell.getValue() ?? "";

            input.addEventListener("input", function () {
                this.value = this.value.replace(/[^0-9.\-]/g, "");
            });

            input.addEventListener("blur", () => success(input.value));

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") success(input.value);
                if (e.key === "Escape") cancel();
            });

            onRendered(function () {
                input.focus();
                input.select();
            });

            return input;
        }

        // =================== DATA TEMPLATES ===================


        var effectivenessTemplate = [
            // SR 1 - Customer Impact (Cap: 10)
            {
                id: 1, SrNo: 1, group: "Business factor 1 - Customer impact",
                attribute: "OTIF (AS IS - Curr.level) / As IS - Tgt",
                data: safeValue("@(Model?.Cust_Data_Pc_Ot)"),
                target: safeValue("@(Model?.Cust_Target_Tgt)"),
                weightage: safeValue("@(Model?.Cust_Weightage_Tgt)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 2, SrNo: 1, group: "Business factor 1 - Customer impact",
                attribute: "AS IS",
                data: safeValue("@(Model?.Cust_Data_Pc_As)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 2 - Customer Impact (Cap: 15)
            {
                id: 3, SrNo: 2, group: "Business factor 1 - Customer impact",
                attribute: "Closed A Class CSO's closed in <= 45 days - YTD",
                data: safeValue("@(Model?.Cust_Data_Pc_Close)"),
                target: safeValue("@(Model?.Cust_Target_Ytd)"),
                weightage: safeValue("@(Model?.Cust_Weightage_Ytd)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<15),((C/D)*E),IF(((C/D)*E)<0,0,15))",
                score: "", mergeWithPrev: false
            },
            {
                id: 4, SrNo: 2, group: "Business factor 1 - Customer impact",
                attribute: "Total A Class CSO logged in YTD",
                data: safeValue("@(Model?.Cust_Data_Pc_Total)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 3 - Process Improvement (Cap: 10)
            {
                id: 5, SrNo: 3, group: "Business factor 2 - Process Improvement",
                attribute: "No of NPDs launched on time, within budget and Qty",
                data: safeValue("@(Model?.Proc_Data_Pc_Npd)"),
                target: safeValue("@(Model?.Proc_Target)"),
                weightage: safeValue("@(Model?.Proc_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 6, SrNo: 3, group: "Business factor 2 - Process Improvement",
                attribute: "Annual Target",
                data: safeValue("@(Model?.Proc_Data_Pc_Ann)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 4 - Key Result Areas (Cap: 10)
            {
                id: 7, SrNo: 4, group: "Business factor 3 - Key Result areas",
                attribute: "Customer Satisfaction index (Net Promoter Score)",
                data: safeValue("@(Model?.Key_Data_Pc_Cust)"),
                target: safeValue("@(Model?.Key_Target)"),
                weightage: safeValue("@(Model?.Key_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 8, SrNo: 4, group: "Business factor 3 - Key Result areas",
                attribute: "Annual Target",
                data: safeValue("@(Model?.Key_Data_Pc_Ann)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 5 - Savings (Cap: 10)
            {
                id: 9, SrNo: 5, group: "Business factor 4 - Savings",
                attribute: "Actual savings realised in C&I YTD",
                data: safeValue("@(Model?.Save_Data_Pc_Actu)"),
                target: safeValue("@(Model?.Save_Target)"),
                weightage: safeValue("@(Model?.Save_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 10, SrNo: 5, group: "Business factor 4 - Savings",
                attribute: "Annual Target",
                data: safeValue("@(Model?.Save_Data_Pc_Ann)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 6 - Outgoing Quality (Cap: 15)
            {
                id: 11, SrNo: 6, group: "Business factor 5 - Out going product quality",
                attribute: "Sigma level of outgoing product",
                data: safeValue("@(Model?.Out_Data_Pc_Sigma)"),
                target: safeValue("@(Model?.Out_Target)"),
                weightage: safeValue("@(Model?.Out_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<15),((C/D)*E),IF(((C/D)*E)<0,0,15))",
                score: "", mergeWithPrev: false
            },
            {
                id: 12, SrNo: 6, group: "Business factor 5 - Out going product quality",
                attribute: "AS IS",
                data: safeValue("@(Model?.Out_Data_Pc_As)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 7 - SPM Rating (Cap: 10)
            {
                id: 13, SrNo: 7, group: "Business factor 6 - SPM Rating",
                attribute: "SPM Scores >= 3 stars",
                data: safeValue("@(Model?.Spm_Data_Pc_Spm)"),
                target: safeValue("@(Model?.Spm_Target)"),
                weightage: safeValue("@(Model?.Spm_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 14, SrNo: 7, group: "Business factor 6 - SPM Rating",
                attribute: "AS IS",
                data: safeValue("@(Model?.Spm_Data_Pc_As)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 8-9 - Project Closure (No scoring)
            {
                id: 15, SrNo: 8, group: "Business factor 7 - Project Closure",
                attribute: "Projects closed this year",
                data: safeValue("@(Model?.Proj_Data_Pc_Close)"),
                target: safeValue("@(Model?.Proj_Num_Target)"),
                weightage: safeValue("@(Model?.Proj_Num_Weightage)"),
                formula: "", 
                score_formula: "IF(AND(((C28/D28)*E28)>=0,((C28/D28)*E28)<10),((C28/D28)*E28),IF(((C28/D28)*E28)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            
            {
                id: 16, SrNo: 8, group: "Business factor 7 - Project Closure",
                attribute: "Projects initiated + CF from last year",
                data: safeValue("@(Model?.Proj_Data_Pc_Dmaic)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },
             {
                id: 17, SrNo: 9, group: "Business factor 7 - Project Closure",
                attribute: "Turbo projects closed",
                data: safeValue("@(Model?.Proj_Data_Pc_Turbo)"),
                target: safeValue("@(Model?.Proj_No_Target)"),
                weightage: safeValue("@(Model?.Proj_No_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C30/D30)*E30)>=0,((C30/D30)*E30)<10),((C30/D30)*E30),IF(((C30/D30)*E30)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 18, SrNo: 9, group: "Business factor 7 - Project Closure",
                attribute: "Projects planned",
                data: safeValue("@(Model?.Proj_Data_Pc_Planned)"),
                target: "",
                weightage: "",
                formula: "",
                score_formula: "",
                score: "", mergeWithPrev: true
            },

            // SR 10 - Summary
            {
                id: 19, SrNo: 10, group: "Weighted Score Summary",
                attribute: "Weighted Score Target",
                data: "", target: "", weightage: "",
                formula: "Total Weighted Score", score: "", mergeWithPrev: false
            }
        ];

        var engagementTemplate = [
            // SR 1 - Lean Engagement (Cap: 15)
            {
                id: 1, SrNo: 1, group: "Lean Engagement",
                attribute: "No Of People engaged in Turbo and Ideas generation",
                data: safeValue("@(Model?.Lean_Data_Pc_No_People)"),
                target: safeValue("@(Model?.Lean_Target)"),
                weightage: safeValue("@(Model?.Lean_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<15),((C/D)*E),IF(((C/D)*E)<0,0,15))",
                score: "", mergeWithPrev: false
            },
            {
                id: 2, SrNo: 1, group: "Lean Engagement",
                attribute: "Total no of people in the location including permanent employees at vendor location",
                data: safeValue("@(Model?.Lean_Data_Pc_Total_People)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 2 - Six Sigma Engagement (Cap: 10)
            {
                id: 3, SrNo: 2, group: "Six Sigma Engagement -(Tools & Projects)",
                attribute: "Project Engagement",
                data: safeValue("@(Model?.Six_Sigma_Data_Pc_Proj)"),
                target: safeValue("@(Model?.Six_Sigma_Target)"),
                weightage: safeValue("@(Model?.Six_Sigma__Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 4, SrNo: 2, group: "Six Sigma Engagement -(Tools & Projects)",
                attribute: "Annual Target",
                data: safeValue("@(Model?.Six_Sigma_Data_Pc_Ann)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 3 - SPM Review Plan (Cap: 20)
            {
                id: 5, SrNo: 3, group: "SPM Review Plan vs. actual",
                attribute: "No of Vendors audited actually",
                data: safeValue("@(Model?.Review_Data_Pc_Proj_Review)"),
                target: safeValue("@(Model?.Review_Target)"),
                weightage: safeValue("@(Model?.Review_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<20),((C/D)*E),IF(((C/D)*E)<0,0,20))",
                score: "", mergeWithPrev: false
            },
            {
                id: 6, SrNo: 3, group: "SPM Review Plan vs. actual",
                attribute: "No of Vendors covered in the Annual Audit Plan (Make and Buy)",
                data: safeValue("@(Model?.Review_Data_Pc_Proj_Review)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 4 - Review Engagement (No scoring)
            {
                id: 7, SrNo: 4, group: "Review Engagement-All running & closed projects",
                attribute: "Number of projects reviewed by the champion every PC",
                data: safeValue("@(Model?.Review_Data_Pc_Proj_Review)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: false
            },
            {
                id: 8, SrNo: 4, group: "Review Engagement-All running & closed projects",
                attribute: "Number of projects running",
                data: safeValue("@(Model?.Review_Data_Pc_Proj_Running)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 5 - Market Engagement (Cap: 20)
            {
                id: 9, SrNo: 5, group: "Market Engagement- Visits with CSO'S",
                attribute: "CSO captured during Market Visits and Site Audits",
                data: safeValue("@(Model?.Market_Data_Pc_Cap_Cso)"),
                target: safeValue("@(Model?.Market_Target)"),
                weightage: safeValue("@(Model?.Market_Weightage)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<20),((C/D)*E),IF(((C/D)*E)<0,0,20))",
                score: "", mergeWithPrev: false
            },
            {
                id: 10, SrNo: 5, group: "Market Engagement- Visits with CSO'S",
                attribute: "Target no of CSO",
                data: safeValue("@(Model?.Market_Data_Pc_Tar_Cso)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 6 - BKPT YTD (Cap: 10)
            {
                id: 11, SrNo: 6, group: "BKPT - Generation & Replication of Ideas",
                attribute: "Number of Ideas generated till the PC (YTD)",
                data: safeValue("@(Model?.Bkpt_Data_Pc_Ytd)"),
                target: safeValue("@(Model?.Bkpt_Target_Ytd)"),
                weightage: safeValue("@(Model?.Bkpt_Weightage_Ytd)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 12, SrNo: 6, group: "BKPT - Generation & Replication of Ideas",
                attribute: "Annual Target",
                data: safeValue("@(Model?.Bkpt_Data_Pc_Ann_Ytd)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 7 - BKPT MFG (Cap: 10)
            {
                id: 13, SrNo: 7, group: "BKPT - Generation & Replication of Ideas",
                attribute: "MFG: Number of Ideas replicated from competition/industry",
                data: safeValue("@(Model?.Bkpt_Data_Pc_Mfg)"),
                target: safeValue("@(Model?.Bkpt_Target_Mfg)"),
                weightage: safeValue("@(Model?.Bkpt_Weightage_Mfg)"),
                formula: "",
                score_formula: "IF(AND(((C/D)*E)>=0,((C/D)*E)<10),((C/D)*E),IF(((C/D)*E)<0,0,10))",
                score: "", mergeWithPrev: false
            },
            {
                id: 14, SrNo: 7, group: "BKPT - Generation & Replication of Ideas",
                attribute: "Annual Target",
                data: safeValue("@(Model?.Bkpt_Data_Pc_Ann_Mfg)"),
                target: "", weightage: "", formula: "", score: "", mergeWithPrev: true
            },

            // SR 8 - Summary
            {
                id: 15, SrNo: 8, group: "Weighted Score Summary",
                attribute: "Weighted Score Target",
                data: "100", target: "", weightage: "",
                formula: "Total Weighted Score", score: "", mergeWithPrev: false
            }
        ];

        // =================== COLUMNS ===================

        let effectivenessColumns = [
            {
                title: "Sr No.", field: "SrNo", width: 80, hozAlign: "center",
                headerHozAlign: "center", editor: false,
                formatter: function (cell) {
                    const data = cell.getRow().getData();
                    if (data.mergeWithPrev) {
                        cell.getElement().style.borderTop = "none";
                        return "";
                    }
                    return data.SrNo;
                }
            },
            {
                title: "Attribute", field: "attribute", hozAlign: "left",
                widthGrow: 2, formatter: "textarea"
            },
            {
                title: "Data for PC", field: "data", hozAlign: "center",
                editor: numericOnlyEditor, validator: ["numeric"]
            },
            {
                title: "Target", field: "target", hozAlign: "center",
                editor: numericOnlyEditor, validator: ["numeric"],
                editable: function (cell) {
                    const rowData = cell.getRow().getData();
                    if (rowData.formula === "Total Weighted Score") return false;
                    return editableWhenOddId(cell);
                }
            },
            {
                title: "Weightage", field: "weightage", hozAlign: "center",
                editor: numericOnlyEditor, validator: ["numeric"],
                editable: function (cell) {
                    const rowData = cell.getRow().getData();
                    if (rowData.formula === "Total Weighted Score") return false;
                    return editableWhenOddId(cell);
                }
            },
            {
                title: "Formula", field: "formula", hozAlign: "center",
                editor: "input",
                editable: function (cell) {
                    const value = cell.getValue();
                    if (value === "Total Weighted Score") return false;
                    return editableWhenOddId(cell);
                }
            },
            {
                title: "Weighted Score", field: "score", hozAlign: "center",
                editor: false, editable: false
            }
        ];

        let engagementColumns = [
            {
                title: "Sr No.", field: "SrNo", width: 80, hozAlign: "center",
                headerHozAlign: "center", editor: false,
                formatter: function (cell) {
                    const data = cell.getRow().getData();
                    if (data.mergeWithPrev) {
                        cell.getElement().style.borderTop = "none";
                        return "";
                    }
                    return data.SrNo;
                }
            },
            {
                title: "Attribute", field: "attribute", hozAlign: "left",
                widthGrow: 2, formatter: "textarea"
            },
            {
                title: "Data for PC", field: "data", hozAlign: "center",
                editor: numericOnlyEditor, validator: ["numeric"]
            },
            {
                title: "Target", field: "target", hozAlign: "center",
                editor: numericOnlyEditor, validator: ["numeric"],
                editable: function (cell) {
                    const rowData = cell.getRow().getData();
                    if (rowData.formula === "Total Weighted Score") return false;
                    return editableWhenOddId(cell);
                }
            },
            {
                title: "Weightage", field: "weightage", hozAlign: "center",
                editor: numericOnlyEditor, validator: ["numeric"],
                editable: function (cell) {
                    const rowData = cell.getRow().getData();
                    if (rowData.formula === "Total Weighted Score") return false;
                    return editableWhenOddId(cell);
                }
            },
            {
                title: "Formula", field: "formula", hozAlign: "center",
                editor: "input",
                editable: function (cell) {
                    const value = cell.getValue();
                    if (value === "Total Weighted Score") return false;
                    return editableWhenOddId(cell);
                }
            },
            {
                title: "Weighted Score", field: "score", hozAlign: "center",
                editor: false, editable: false
            }
        ];

        // =================== INITIALIZE TABLES ===================

        effectivenessTable = new Tabulator("#sixSigmaTableEffectiveness", {
            data: effectivenessTemplate,
            layout: "fitColumns",
            groupBy: "group",
            groupHeader: value => `<span style='font-weight:bold; font-size:14px; color:#000;'>${value}</span>`,
            groupToggleElement: false,
            groupStartOpen: true,
            movableColumns: false,
            headerSort: false,
            height: "auto",
            columns: effectivenessColumns,
            rowFormatter: mergeRowFormatter,
            cellEdited: function (cell) {
                const field = cell.getField();
                const rowData = cell.getRow().getData();
                const table = cell.getTable();

                if (["target", "weightage", "formula"].includes(field)) {
                    const srno = rowData.SrNo;
                    const value = cell.getValue();

                    table.getRows().forEach(r => {
                        const d = r.getData();
                        if (r !== cell.getRow() && d.SrNo === srno) {
                            r.update({ [field]: value }, true);
                        }
                    });
                }

                if (["data", "target", "weightage", "formula"].includes(field)) {
                    recalcTableScores(table);
                }
            }
        });

        effectivenessTable.on("cellEdited", function (cell) {
         debugger
         const field = cell.getField();
            const rowData = cell.getRow().getData();
            const table = cell.getTable();

            if (["target", "weightage", "formula"].includes(field)) {
                const srno = rowData.SrNo;
                const value = cell.getValue();

                table.getRows().forEach(r => {
                    const d = r.getData();
                    if (r !== cell.getRow() && d.SrNo === srno) {
                        r.update({ [field]: value }, true);
                    }
                });
            }

            if (["data", "target", "weightage", "formula"].includes(field)) {
                recalcTableScores(table);
            }
        });

        engagementTable = new Tabulator("#sixSigmaTableEngagement", {
            data: engagementTemplate,
            layout: "fitColumns",
            groupBy: "group",
            groupHeader: value => `<span style='font-weight:bold; font-size:14px; color:#000;'>${value}</span>`,
            groupToggleElement: false,
            groupStartOpen: true,
            movableColumns: false,
            headerSort: false,
            height: "auto",
            columns: engagementColumns,
            rowFormatter: mergeRowFormatter,
            cellEdited: function (cell) {
                const field = cell.getField();
                const rowData = cell.getRow().getData();
                const table = cell.getTable();

                if (["target", "weightage", "formula"].includes(field)) {
                    const srno = rowData.SrNo;
                    const value = cell.getValue();

                    table.getRows().forEach(r => {
                        const d = r.getData();
                        if (r !== cell.getRow() && d.SrNo === srno) {
                            r.update({ [field]: value }, true);
                        }
                    });
                }

                if (["data", "target", "weightage", "formula"].includes(field)) {
                    recalcTableScores(table);
                }
            }
        });

        engagementTable.on("cellEdited", function (cell) {
            debugger
             const field = cell.getField();
                const rowData = cell.getRow().getData();
                const table = cell.getTable();

                if (["target", "weightage", "formula"].includes(field)) {
                    const srno = rowData.SrNo;
                    const value = cell.getValue();

                    table.getRows().forEach(r => {
                        const d = r.getData();
                        if (r !== cell.getRow() && d.SrNo === srno) {
                            r.update({ [field]: value }, true);
                        }
                    });
                }

                if (["data", "target", "weightage", "formula"].includes(field)) {
                    recalcTableScores(table);
                }
        });

        // Initial calculation
        setTimeout(function() {
            console.log("Starting initial calculation...");
            recalcTableScores(effectivenessTable);
            recalcTableScores(engagementTable);
            console.log("Initial calculation complete.");
        }, 500);
    }

    // =================== SAVE FUNCTION (same as before) ===================

    function getRowById(rows, id) {
        return rows.find(r => r.id === id) || {};
    }

    function saveSixSigma() {
        const requiredHeaderFields = [
            { id: "Fy", name: "FY" },
            { id: "Pc", name: "PC" },
            { id: "Location", name: "Location" }
        ];

        let missingHeaderFields = [];

        requiredHeaderFields.forEach(field => {
            const value = $("#" + field.id).val();
            if (!value || value.trim() === "") {
                missingHeaderFields.push(field.name);
            }
        });

        if (missingHeaderFields.length > 0) {
            const listHTML = missingHeaderFields.map(f => `<li>${f}</li>`).join("");
            showDangerAlert(`
                <p>Please fill out the following required field(s):</p>
                <ul>${listHTML}</ul>
            `);
            return false;
        }

        if (typeof Blockloadershow === "function") {
            Blockloadershow();
        }

        const eff = effectivenessTable.getData();
        const eng = engagementTable.getData();

        const model = {};

        const e1 = getRowById(eff, 1);
        const e2 = getRowById(eff, 2);
        const e3 = getRowById(eff, 3);
        const e4 = getRowById(eff, 4);
        const e5 = getRowById(eff, 5);
        const e6 = getRowById(eff, 6);
        const e7 = getRowById(eff, 7);
        const e8 = getRowById(eff, 8);
        const e9 = getRowById(eff, 9);
        const e10 = getRowById(eff, 10);
        const e11 = getRowById(eff, 11);
        const e12 = getRowById(eff, 12);
        const e13 = getRowById(eff, 13);
        const e14 = getRowById(eff, 14);
        const e15 = getRowById(eff, 15);
        const e16 = getRowById(eff, 16);
        const e17 = getRowById(eff, 17);
        const e18 = getRowById(eff, 18);
        const e19 = getRowById(eff, 19);

        model.Cust_Data_Pc_Ot = e1.data;
        model.Cust_Target_Tgt = e1.target;
        model.Cust_Weightage_Tgt = e1.weightage;
        model.Cust_Formula_Tgt = e1.formula;
        model.Cust_Weighted_Score_Tgt = e1.score;
        model.Cust_Data_Pc_As = e2.data;
        model.Cust_Data_Pc_Close = e3.data;
        model.Cust_Target_Ytd = e3.target;
        model.Cust_Weightage_Ytd = e3.weightage;
        model.Cust_Formula_Ytd = e3.formula;
        model.Cust_Weighted_Score_Ytd = e3.score;
        model.Cust_Data_Pc_Total = e4.data;
        model.Proc_Data_Pc_Npd = e5.data;
        model.Proc_Target = e5.target;
        model.Proc_Weightage = e5.weightage;
        model.Proc_Formula = e5.formula;
        model.Proc_Weighted_Score = e5.score;
        model.Proc_Data_Pc_Ann = e6.data;
        model.Key_Data_Pc_Cust = e7.data;
        model.Key_Target = e7.target;
        model.Key_Weightage = e7.weightage;
        model.Key_Formula = e7.formula;
        model.Key_Weighted_Score = e7.score;
        model.Key_Data_Pc_Ann = e8.data;
        model.Save_Data_Pc_Actu = e9.data;
        model.Save_Target = e9.target;
        model.Save_Weightage = e9.weightage;
        model.Save_Formula = e9.formula;
        model.Save_Weighted_Score = e9.score;
        model.Save_Data_Pc_Ann = e10.data;
        model.Out_Data_Pc_Sigma = e11.data;
        model.Out_Target = e11.target;
        model.Out_Weightage = e11.weightage;
        model.Out_Formula = e11.formula;
        model.Out_Weighted_Score = e11.score;
        model.Out_Data_Pc_As = e12.data;
        model.Spm_Data_Pc_Spm = e13.data;
        model.Spm_Target = e13.target;
        model.Spm_Weightage = e13.weightage;
        model.Spm_Formula = e13.formula;
        model.Spm_Weighted_Score = e13.score;
        model.Spm_Data_Pc_As = e14.data;
        model.Proj_Data_Pc_Close = e15.data;
        model.Proj_Num_Target = e15.target;
        model.Proj_Num_Weightage = e15.weightage;
        model.Proj_Num_Formula = e15.formula;
        model.Proj_Num_Weighted_Score = e15.score;
        model.Proj_Data_Pc_Dmaic = e16.data;
        model.Proj_No_Weighted_Score = e17.data;
        model.Proj_No_Target = e17.target;
        model.Proj_No_Weightage = e17.weightage;
        model.Proj_No_Formula = e17.formula;
        model.Proj_Data_Pc_Turbo = e17.score;
        model.Proj_Data_Pc_Planned = e18.data;
        model.Eff_Total_Sum = e19.data;
        model.Eff_Total_Weighted_Score = e19.score;

        const g1 = getRowById(eng, 1);
        const g2 = getRowById(eng, 2);
        const g3 = getRowById(eng, 3);
        const g4 = getRowById(eng, 4);
        const g5 = getRowById(eng, 5);
        const g6 = getRowById(eng, 6);
        const g7 = getRowById(eng, 7);
        const g8 = getRowById(eng, 8);
        const g9 = getRowById(eng, 9);
        const g10 = getRowById(eng, 10);
        const g11 = getRowById(eng, 11);
        const g12 = getRowById(eng, 12);
        const g13 = getRowById(eng, 13);
        const g14 = getRowById(eng, 14);
        const g15 = getRowById(eng, 15);

        model.Lean_Data_Pc_No_People = g1.data;
        model.Lean_Target = g1.target;
        model.Lean_Weightage = g1.weightage;
        model.Lean_Formula = g1.formula;
        model.Lean_Weighted_Score = g1.score;
        model.Lean_Data_Pc_Total_People = g2.data;
        model.Six_Sigma_Data_Pc_Proj = g3.data;
        model.Six_Sigma_Target = g3.target;
        model.Six_Sigma__Weightage = g3.weightage;
        model.Six_Sigma_Formula = g3.formula;
        model.Six_Sigma_Weighted_Score = g3.score;
        model.Six_Sigma_Data_Pc_Ann = g4.data;
        model.Review_Data_Pc_Proj_Review = g5.data;
        model.Review_Target = g5.target;
        model.Review_Weightage = g5.weightage;
        model.Review_Formula = g5.formula;
        model.Spm_Review_Weighted_Score = g5.score;
        model.Review_Data_Pc_Proj_Running = g6.data;
        model.Review_Data_Pc_Proj_Review = g7.data;
        model.Review_Data_Pc_Proj_Running = g8.data;
        model.Market_Data_Pc_Cap_Cso = g9.data;
        model.Market_Target = g9.target;
        model.Market_Weightage = g9.weightage; 
        model.Market_Formula = g9.formula;
        model.Market_Weighted_Score = g9.score;
        model.Market_Data_Pc_Tar_Cso = g10.data;
        model.Bkpt_Data_Pc_Ytd = g11.data;
        model.Bkpt_Target_Ytd = g11.target;
        model.Bkpt_Weightage_Ytd = g11.weightage;
        model.Bkpt_Formula_Ytd = g11.formula;
        model.Bkpt_Weighted_Score_Ytd = g11.score;
        model.Bkpt_Data_Pc_Ann_Ytd = g12.data;
        model.Bkpt_Data_Pc_Mfg = g13.data;
        model.Bkpt_Target_Mfg = g13.target;
        model.Bkpt_Weightage_Mfg = g13.weightage;
        model.Bkpt_Formula_Mfg = g13.formula;
        model.Bkpt_Weighted_Score_Mfg = g13.score;
        model.Bkpt_Data_Pc_Ann_Mfg = g14.data;
        model.Eng_Total_Sum = g15.data;
        model.Eng_Total_Weighted_Score = g15.score;

        model.Fy = $("#Fy").val();
        model.Pc = $("#Pc").val();
        model.Location = $("#Location").val();

        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        const formData = new FormData();

        for (const key in model) {
            if (Object.prototype.hasOwnProperty.call(model, key)) {
                formData.append(key, model[key] == null ? "" : model[key]);
            }
        }

        if (tokenInput) {
            formData.append("__RequestVerificationToken", tokenInput.value);
        }

        const idInput = document.querySelector("#Id");
        if (idInput) {
            formData.append("Id", idInput.value);
        }

        $.ajax({
            url: '@Url.Action("InsertUpdateSEEIndices", "SEEIndices")',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (typeof Blockloaderhide === "function") {
                    Blockloaderhide();
                }

                if (!response || response.success === false) {
                    let errorMsg = "";

                    if (response && response.errors !== undefined) {
                        for (let error of response.errors) {
                            errorMsg += error + "\n";
                        }
                        if (errorMsg !== "") {
                            showDangerAlert(errorMsg);
                        }
                    } else if (response && response.message) {
                        showDangerAlert(response.message);
                    } else {
                        showDangerAlert("Error while saving data.");
                    }

                    return false;
                } else {
                    if ($("#Id").val() > 0) {
                        showSuccessAlert("Updated Successfully.");
                    } else {
                        showSuccessAlert("Saved Successfully.");
                    }

                    setTimeout(function () {
                        window.open('@Url.Action("SEEIndices", "SEEIndices")', '_self');
                    }, 2500);
                }
            },
            error: function (xhr, status, error) {
                if (typeof Blockloaderhide === "function") {
                    Blockloaderhide();
                }
                showDangerAlert('Error saving data: ' + error);
            }
        });
    }

    $(document).ready(function () {
        loadSixSigmaGrid();

        $("#saveButton").on("click", function () {
            saveSixSigma();
        });
    });
</script>

@section HideSidebar { }