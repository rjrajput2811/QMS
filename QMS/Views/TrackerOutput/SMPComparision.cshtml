@{
    ViewData["Title"] = "SPM Comparison (Make)";
}

<link href="~/css/fontawesome/styles.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator.min.css" rel="stylesheet" />
<link href="~/css/tabulator/tabulator_bootstrap4.min.css" rel="stylesheet" />
@* <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" /> *@
<script src="~/js/jquery.min.js"></script>
<script src="~/js/jquery.datatables.js"></script>
<link href="~/css/pnotify.css" rel="stylesheet" />
<script src="~/js/pnotify.js"></script>
<script src="~/js/pnotify.confirm.js"></script>
<script src="~/lib/bootstrap/dist/js/datatables.buttons.min.js"></script>
@* <script src="~/lib/bootstrap/dist/js/popupAlert.js"></script> *@
<script src="~/lib/bootstrap/dist/js/jszip.min.js"></script>
<script src="~/lib/bootstrap/dist/js/buttons.html5.min.js"></script>
<script src="~/js/common.js"></script>
<script src="~/lib/bootstrap/dist/js/popupalert.js"></script>
<script src="~/js/xlsx.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
@* <link href="~/css/select2.min.css" rel="stylesheet" /> *@

<style>
    /* Header card */
    .nav-pills .nav-link {
        text-align: left;
        border-radius: 0;
        border-left: 4px solid transparent;
        font-weight: 500;
        width: 100%;
        padding: 12px;
        background-color: #fff;
        color: #333;
        margin-bottom: 4px;
    }

        .nav-pills .nav-link.active {
            background-color: #f4f3f8;
            border-left: 4px solid #645394;
            color: #645394;
            font-weight: bold;
        }

    .form-control {
        padding: 0 10px !important;
        border: 0;
        border-bottom: 1px solid #cccccc;
        border-radius: 0px;
    }

    label {
        margin-bottom: 0;
        margin-top: .3rem;
    }

    #scrollToTopBtn:hover {
        background-color: #0056b3;
    }

    #scrollToTopBtn {
        outline: none;
    }

    .tabulator .tabulator-header .tabulator-col {
        font-size: 14px;
        background-color: #D6E4F0;
        font-weight: 600;
        border-right: 1px solid #ccc;
    }

    .tabulator-row .tabulator-cell {
        padding: 5px 5px;
        font-size: 14px;
        height: 35px;
    }

    .tabulator-cell:hover {
        color: #4682B4 !important;
        cursor: pointer !important;
        font-weight: bold;
    }

    .form-group {
        margin-bottom: 0.5rem;
    }

    .calendar-container {
        cursor: pointer;
        padding: 8px 8px;
        width: 100%;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        transition: background-color 0.3s, box-shadow 0.3s;
        gap: 8px;
        border: 1px solid slategray;
    }

        .calendar-container:hover {
            background-color: #e3f2fd;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .calendar-container i.fa-calendar {
            color: #2196f3;
            font-size: 1.2em;
            padding-left: 20px;
        }

        .calendar-container span {
            color: #4682B4;
            margin: 0;
            font-size: 14px;
        }

    .container__predefined-ranges {
        font-size: 14px;
    }

    .month-item {
        font-size: 14px;
    }

    .tab-multi-ac {
        display: flex;
        flex-wrap: wrap;
        gap: .35rem;
        align-items: center;
        min-height: 30px;
        padding: 4px;
        cursor: text;
    }

        .tab-multi-ac input {
            border: none;
            outline: none;
            flex: 1 0 120px;
            min-width: 100px;
        }

    .tab-tag {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: 2px 8px;
        border-radius: 12px;
        background: #eef1f6;
        font-size: 12px;
    }

        .tab-tag .tab-x {
            cursor: pointer;
            font-weight: 700;
        }

    .row-flash {
        animation: flash-bg 2s ease-out forwards;
    }

    .row-flash1 {
        animation: flashRow 0.8s ease;
    }

    @@keyframes flashRow {
        0%, 100% {
            background-color: transparent;
        }

        50% {
            background-color: #d4edda;
        }
    }

    .select2-container {
        width: 100% !important;
        box-sizing: border-box;
    }

    .select2-container--default .select2-selection--single,
    .select2-container--default .select2-selection--multiple {
        border: 0 !important;
        border-bottom: 1px solid #cccccc !important;
        border-radius: 0 !important;
        min-height: 34px !important;
        height: auto !important;
        padding: 0 10px !important;
        display: flex !important;
        align-items: center !important;
        box-sizing: border-box;
        background: transparent !important;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding: 0 !important;
            line-height: 34px !important;
            color: #6c757d;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 34px !important;
            top: 0 !important;
        }

    .select2-container--default .select2-selection--multiple {
        padding: 2px 10px !important;
    }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            margin: 0 !important;
            border: 0 !important;
            border-radius: 12px;
            background: #eef1f6;
            padding: 2px 8px;
        }

    .select2-container--default.select2-container--focus .select2-selection--single,
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-bottom: 2px solid #645394 !important;
        box-shadow: none !important;
    }

</style>

<div class="content">

    <!-- Header Card -->
    <div class="card shadow-sm header-card" style="width:100%; margin:0;">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <b class="header-title">SPM Comparison (Make)</b>
            </div>
           
            <div class="col-md-3">
                <div class="form-group row align-items-center">
                    <label for="ddlFY" class="col-sm-4 col-form-label text-right">
                        Financial Year
                    </label>
                    <div class="col-sm-4">
                        <select id="ddlFY" class="form-control" onchange="filterData()">
                        </select>
                    </div>
                </div>
            </div>

            <div>

                <button id="exportExcelButton" type="button" class="btn btn-outline-danger legitRipple mr-2" style="width: 140px;font-size:15px">
                    <i class="fas fa-file-excel mr-2 fa-1x"></i>Export XL
                </button>

                <button id="backButton" class="btn btn-outline-primary" onclick="location.href='@Url.Action("TrackerMenu", "Home")'">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>

        </div>
    </div>

    <!-- Period Title + Table -->
    <div class="card shadow-sm period-card"
         style="border-radius:8px; border:1px solid #ccc; margin-top:20px; width:100%;">

        <div class="card-body">
            <div class="chart-container">
                <div id="deviation_note_table_wrapper" style="overflow-x:auto;">
                    <div id="spmMake_table"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script src="~/js/tabulator.js"></script>
    <script src="~/js/tabulator.min.js"></script>
    @* <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script> *@
    <script src="~/js/select2.min.js"></script>

    <!-- Moment.js and Litepicker -->
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script>
        // App base ("/" or "/BisProjectTrac/")
        window.APP_BASE = '@Url.Content("~")';
        // Absolute URL to wipro-logo.png (e.g., "/BisProjectTrac/images/wipro-logo.png")
        window.LOGO_URL = '@Url.Content("~/images/wipro-logo.png")';
    </script>

    <script>

        // var tabledata = [];
        var table = null;
        let vendorOptions = {};

        $(document).ready(function ()
        {

            bindFinancialYears();

            filterData();

        });

        function getCurrentFYStartYear() {
            const d = new Date();
            return (d.getMonth() >= 3) ? d.getFullYear() : d.getFullYear() - 1;
        }

        function fyText(startYear) {
            return startYear + "-" + String(startYear + 1).slice(-2);
        }

        function bindFinancialYears() {
            const ddl = $("#ddlFY");
            ddl.empty(); // clear existing options

            ddl.append(`<option value="">Select FY</option>`);

            const startFrom = 2020;
            const currentFY = getCurrentFYStartYear();
            const endFY = currentFY + 1; // include upcoming year

            for (let y = startFrom; y <= endFY; y++) {
                const fy = fyText(y);
                ddl.append(`<option value="${fy}">${fy}</option>`);
            }

            // default select current FY
            ddl.val(fyText(currentFY));
        }

        function filterData() {
            Blockloadershow();

            var fy = $("#ddlFY").val();

            // 🔴 Validation: Quarter not selected
            if (!fy || fy === "0") {
                showDangerAlert("Please select Financial Year.");
                $("#ddlFY").focus();
                return; // stop further execution
            }


            $.ajax({
                url: '/Service/GetVendor',
                type: 'GET'
            }).done(function (vendorData) {
                //let vendorOptions = {};

                if (Array.isArray(vendorData)) {
                    vendorOptions = vendorData.reduce((acc, v) => {
                        acc[v.value] = v.label;
                        return acc;
                    }, {});
                }

                $.ajax({
                    url: '/SPMCalculationMake/GetById',
                    type: 'GET',
                    dataType: 'json',
                    traditional: true,
                    data: {
                        Fy: fy
                    },
                    success: function (data) {
                        if (Array.isArray(data) && data.length > 0) {
                            renderSPMTable(data);
                        } else {
                            showDangerAlert('No Data available.');
                        }
                        Blockloaderhide();
                    },
                    error: function (xhr, status, error) {
                        showDangerAlert('Error retrieving data: ' + error);
                        Blockloaderhide();
                    }
                });

            }).fail(function () {
                Blockloaderhide();
                showDangerAlert('Failed to load vendor data.');
            });
        }

        var headerMenu = function () {
            const menu = [];
            const columns = this.getColumns();

            columns.forEach(column => {
                const icon = document.createElement("i");
                icon.classList.add("fas", column.isVisible() ? "fa-check-square" : "fa-square");

                const label = document.createElement("span");
                const title = document.createElement("span");
                title.textContent = " " + column.getDefinition().title;

                label.appendChild(icon);
                label.appendChild(title);

                menu.push({
                    label: label,
                    action: function (e) {
                        e.stopPropagation();
                        column.toggle();
                        icon.classList.toggle("fa-check-square", column.isVisible());
                        icon.classList.toggle("fa-square", !column.isVisible());
                    }
                });
            });

            return menu;
        };

        function getFinancialYears() {
            let today = new Date();
            let year = today.getFullYear();
            let month = today.getMonth() + 1; // Jan=0, so +1

            let startYear;
            if (month < 4) {
                // Before April → FY belongs to previous year
                startYear = year - 1;
            } else {
                startYear = year;
            }

            // Build last 5 financial years
            let years = {};
            for (let i = 0; i < 5; i++) {
                let sYear = startYear - i;
                let eYear = sYear + 1;
                let fy = sYear + "-" + eYear.toString().slice(-2);
                years[fy] = fy;
            }

            return years;
        }

        var financialYears = getFinancialYears();

        function getMonthOptions() {
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const yearSuffix = new Date().getFullYear().toString().slice(-2);
            return months.map(m => `${m} - ${yearSuffix}`); // array of strings
        }

        function getMonthString() {
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const today = new Date();
            const monthName = months[today.getMonth()];
            const yearSuffix = today.getFullYear().toString().slice(-2);
            return monthName + " - " + yearSuffix;
        }

        function getVendorText(val) {
            const key = (val ?? "").toString().trim();
            return vendorOptions?.[key] || vendorOptions?.[val] || key; // fallback to value itself
        }

        function renderSPMTable(response) {
                let tabledata = [];

            // Utility function to format date to dd/MM/yyyy
            function formatDate(value) {
                return value ? new Date(value).toLocaleDateString("en-GB") : "";
            }

            // Prepare data
            if (response.length > 0) {
                $.each(response, function (index, item) {
                    tabledata.push({
                        Sr_No: index + 1,
                        Id : item.id,
                        Supp_Name : item.supp_Name || "",
                        Supp_Name_Text: getVendorText(item.supp_Name),
                        Fy : item.fy || "",
                        Month : item.month || "",
                        Ppm_Rating : item.ppm_Rating || 0,
                        Delivery_Rating : item.delivery_Rating || 0,
                        Capa_Rating : item.capa_Rating,
                        Audit_Rating : item.audit_Rating || 0,
                        Cost_Rating : item.cost_Rating || 0,
                        Npi_Resp_Rating : item.npi_Resp_Rating || 0,
                        Rep_Lead_Time_Rating : item.rep_Lead_Time_Rating || 0,
                        Total : item.total || 0
                    });
                });
            }

            const columns = [
                { title: "S.No", field: "Sr_No", frozen: true, hozAlign: "center", headerSort: false, headerMenu: headerMenu, width: 80 },

               

                {
                    title: "FY",
                    field: "Fy",
                    headerFilter: "list",
                    headerFilterParams: { values: financialYears },
                    hozAlign: "center",
                    headerHozAlign: "center",
                    headerMenu: headerMenu
                },

                {
                    title: "Month",
                    field: "Month",
                    headerFilter: "list",
                    headerFilterParams: { values: getMonthOptions() },
                    hozAlign: "center",
                    headerHozAlign: "center",
                    headerMenu: headerMenu
                },

                 {
                  title: "Vendor",
                  field: "Supp_Name_Text",
                  hozAlign: "left",
                  headerHozAlign: "center"
                },

                { title: "PPM Rating", headerHozAlign: "center",field: "Ppm_Rating", hozAlign: "center", headerMenu: headerMenu },

                { title: "Delivery Rating", headerHozAlign: "center",field: "Delivery_Rating", hozAlign: "center" , headerMenu: headerMenu },

                { title: "CAPA Rating", headerHozAlign: "center",field: "Capa_Rating", hozAlign: "center", headerMenu: headerMenu  },

                { title: "Audit Rating", headerHozAlign: "center",field: "Audit_Rating", hozAlign: "center", headerMenu: headerMenu   },

                { title: "Cost Initiative Rating", headerHozAlign: "center",field: "Cost_Rating", hozAlign: "center", headerMenu: headerMenu },

                { title: "NPI Response Rating", headerHozAlign: "center", field: "Npi_Resp_Rating", hozAlign: "center", headerMenu: headerMenu },

                { title: "Replace Lead Time Rating", headerHozAlign: "center",field: "Rep_Lead_Time_Rating", hozAlign: "center", headerMenu: headerMenu },

                { title: "Total", headerHozAlign: "center",field: "Total", hozAlign: "center", headerMenu: headerMenu },

            ];

            // Create once, update after
            if (!table) {
                table = new Tabulator("#spmMake_table", {
                    data: tabledata,
                    columns: columns,
                    layout: "fitDataFill",
                    placeholder: "No data available",
                    movableColumns: true,
                    pagination: "local",
                    paginationSize: 10,
                    paginationSizeSelector: [10, 20, 50, 100],
                    paginationCounter: "rows",
                    reactiveData: true,
                    index: "Id",

                    columnDefaults: {
                       editor: false,
                       headerMenu: headerMenu
                    },

                    tableBuilt: function () {
                        this.redraw(true);
                    }
                });

            } else {
                table.setColumns(columns);
                table.replaceData(tabledata);
                table.redraw(true);
            }

            Blockloaderhide();
        }

    </script>

}

@section HideSidebar { }

